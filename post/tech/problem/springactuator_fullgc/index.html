<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="整体复盘： 一个不算普通的周五中午，同事收到了大量了cpu异常的报警。根据报警表现和通过arthas查看，很明显的问题就是内存不足，疯狂无效g"><title>偷偷开启的监控在吃内存</title>
<link rel=canonical href=https://qisiii.github.io/post/tech/problem/springactuator_fullgc/><link rel=stylesheet href=/scss/style.min.7657e19dfcc00117e827b40bd92bcea286037ffa4a33e95fc533eaea79d078f9.css><meta property='og:title' content="偷偷开启的监控在吃内存"><meta property='og:description' content="整体复盘： 一个不算普通的周五中午，同事收到了大量了cpu异常的报警。根据报警表现和通过arthas查看，很明显的问题就是内存不足，疯狂无效g"><meta property='og:url' content='https://qisiii.github.io/post/tech/problem/springactuator_fullgc/'><meta property='og:site_name' content='起司的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='线上异常'><meta property='article:published_time' content='2023-12-10T00:00:00+00:00'><meta property='article:modified_time' content='2025-02-12T15:02:08+00:00'><meta name=twitter:title content="偷偷开启的监控在吃内存"><meta name=twitter:description content="整体复盘： 一个不算普通的周五中午，同事收到了大量了cpu异常的报警。根据报警表现和通过arthas查看，很明显的问题就是内存不足，疯狂无效g"><link rel=alternate type=application/json href=https://qisiii.github.io/post/tech/problem/springactuator_fullgc/index.json><link rel=alternate type=application/rss+xml href=https://qisiii.github.io/post/tech/problem/springactuator_fullgc/index.xml><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NDCRP4S7S"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NDCRP4S7S")}</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><span id=top></span></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huf89847f5290877d03a6309f0caaa56f1_43584_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>起司的博客</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/qisiii target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页|Home</span></a></li><li><a href=/post/friends target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-heart-handshake"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/><path d="M12 6 8.707 9.293a1 1 0 000 1.414l.543.543c.69.69 1.81.69 2.5.0l1-1a3.182 3.182.0 014.5.0l2.25 2.25"/><path d="M12.5 15.5l2 2"/><path d="M15 13l2 2"/></svg>
<span>友链|Friends</span></a></li><li><a href=/post/search target=_blank><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索|Search</span></a></li><li><a href=/leetcode target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-leetcode"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg>
<span>力扣|Leetcode</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#整体复盘>整体复盘：</a></li><li><a href=#结论>结论</a></li><li><a href=#解决方案>解决方案</a></li><li><a href=#复现>复现：</a></li><li><a href=#分析>分析</a><ol><li><a href=#actuator导致rest启动了metrics记录>actuator导致rest启动了metrics记录</a></li><li><a href=#为什么maxuritags没有生效>为什么maxUriTags没有生效？</a><ol><li><a href=#simplemeterregistry的实例化时机>simpleMeterRegistry的实例化时机</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tech/>技术人生</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/tech/problem/springactuator_fullgc/>偷偷开启的监控在吃内存</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023-12-10</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
<time class=article-time--reading>10分钟</time></div><span id=busuanzi_container_value_page_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_page_pv></span>&nbsp;</span><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><div class=artile-time-reading><a href=https://qisiii.github.io/tags/%E7%BA%BF%E4%B8%8A%E5%BC%82%E5%B8%B8>#线上异常</a></div></footer></div></header><section class=article-content><h2 id=整体复盘>整体复盘：</h2><p>一个不算普通的周五中午，同事收到了大量了cpu异常的报警。根据报警表现和通过arthas查看，很明显的问题就是内存不足，疯狂无效gc。而且结合arthas和gc日志查看，老年代打满了，gc不了一点。既然问题是内存问题，那么老样子，通过jmap和heap dump 文件分析。</p><p>不感兴趣的可以直接看结论</p><p>通过jmap命令查看的类似下图，并没有项目中明显的自定义类，而占空间最大的又是char数组，当时线上占900M左右，整个老年代也就1.8个G；此时dump文件同事还在下载，网速较慢。</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/fb94239dccac4eefa2d473ca8d125573.png loading=lazy alt=image></p><p>通过业务日志查看，很多restTempalte请求报错，根据报错信息可知是某xx认证过期了，导致接收到回调，业务处理时调接口报错了；查询数据库，大概有20多万回调。根据过期时间和内存监控，大概能对的上号，表明内存异常和这个认证过期有关。怀疑度最高的只有回调以及回调补偿任务，但是一行一行代码看过去，并不觉得有什么异常。</p><p><del>在dump文件下载完之后，使用jvisualvm分析，最多的char里大部分都是一些请求的路径，如“example/test/1"，”“example/test/2"之类的，都是接口统一，但是参数不一样，因为是GET请求，所以实际路径都不一样。Jvisualvm点击gc_root又一直计算不出来，在等待计算的过程中，一度走了弯路（百度搜索到ImmutableTag这个类在skywalking有用过，但skywalking由于是jar包进行代理，项目中不存在对应的源码，所以又不得不下载公司的jar包反编译，然后去找http相关插件里翻源码，只是为了看一下ImmutableTag的具体结构）；此时，我们大概归纳到是http的监控在统计一些指标物料时，没有释放接口路径所引用的对象导致老年代打满）。 在gc_root终于计算出来之后，更是肯定了这个想法，但是hikari怎么可能监听http呢？</del></p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/f3c677e8f7c448d9be1cd17fe2df442b.png loading=lazy alt=image></p><p>于是又现下载jprofiler，通过jprofiler的聚类，确定了一定是这个Meter导致的，而通过JProfile的分析，终于定位到是</p><p>org.springframework.boot.actuate.metrics.web.client.MetricsClientHttpRequestInterceptor#intercept这个类。然后发现，MetricsClientHttpRequestInterceptor 持有一个meterRegistry，里面核心是个map，所以一定是map没有清除。和我们最开始想的skywalking不一样，是springboot配套的监控，根据依赖分析，发现是有次需求引入了redisson-spring-boot-starter，而redisson依赖了spring-boot-starter-actuator，这东西默认启动了，会拦截所有的RestTempalte请求，然后记录一些指标。</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/100bd5c603bb56ae51241d0f7ac07315.png loading=lazy alt=image></p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/b7b3cfcfcde7597d7a1fb1b55aa38983.png loading=lazy alt=image></p><p>所以问题变成了，为什么map没有清掉已经执行完的请求？</p><p>我之前并没有研究过spring的actuator，只是看过skywalking的流程，所以我以为也和skywalking一样，记录然后上报，上报之后删除本地的。所以当时怀疑，难道是和我们请求都异常了有关，但是正如下面的代码，无论是否异常，都是执行finnally，所以又不太可能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=n>ClientHttpResponse</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>execution</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>body</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>response</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>getTimeBuilder</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>response</span><span class=p>).</span><span class=na>register</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>meterRegistry</span><span class=p>).</span><span class=na>record</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>nanoTime</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>NANOSECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>logger</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Failed to record metrics.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>urlTemplate</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>urlTemplate</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>而在我自己尝试复现之后，micrometer的指标根本不会被自动清除，生命周期和应用的生命周期一样。因为并不存在上报，数据全部在内存（虽然可以导出到数据库，但并没有深入研究）。其实也合理，因为如果要通过Grafana等可视化平台查看的时候，我们也希望查看任意时刻的监控。不过看代码应该是有留一些手动删除的，应该是页面操作之类的才会触发。</p><h2 id=结论>结论</h2><p><strong>所以到此为止，可以定结论，那就是因为引入了redisson-spring-boot-starter，导致不知情引入了spring-boot-starter-actuator。</strong></p><p>因此默认开启了http.client.request指标的监控，关于http.client.request，有一个属性是maxUriTags，默认值是100，其作用是限制meterMap里<strong>uri</strong>的个数。但是maxUriTags起作用的地方MeterFilter没有生效。</p><p>由于maxUriTags没有生效，导致监控信息里的uri因为业务大量的GET请求中存在唯一id，本身就很占内存。压死内存的最后稻草是认证过期和补偿任务。补偿任务为保证及时性一直在频繁执行，而接口的uri里两个变量（token和uniId）导致meterMap里的key不重复，一直在插入，20万回调，token两小时更新一次，持续了两天，最终产生了124万条字符串，被map持有，无法回收。</p><h2 id=解决方案>解决方案</h2><ol><li>不需要监控</li></ol><p>直接排除掉<strong>spring-boot-starter-actuator</strong></p><ol start=2><li>需要监控但不需要http.client.request指标</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=nl>management</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>request</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>autotime</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><ol start=3><li>需要http.client.request指标</li></ol><p>jar包升到2.5.1或以上</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=o>&lt;</span><span class=n>dependency</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=p>.</span><span class=na>springframework</span><span class=p>.</span><span class=na>boot</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>spring</span><span class=o>-</span><span class=n>boot</span><span class=o>-</span><span class=n>actuator</span><span class=o>-</span><span class=n>autoconfigure</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>version</span><span class=o>&gt;</span><span class=n>2</span><span class=p>.</span><span class=na>5</span><span class=p>.</span><span class=na>1</span><span class=o>&lt;/</span><span class=n>version</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;/</span><span class=n>dependency</span><span class=o>&gt;</span><span class=w>
</span></span></span></code></pre></div><h2 id=复现>复现：</h2><p>新建测试项目</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/4a437c4a7e95d88a50ae832b0d20ab96.png loading=lazy alt=image></p><p>相关代码和配置如下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=nd>@SpringBootApplication</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Application</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ConfigurableApplicationContext</span><span class=w> </span><span class=n>run</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SpringApplication</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Application</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RestTemplate</span><span class=w> </span><span class=n>bean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>run</span><span class=p>.</span><span class=na>getBean</span><span class=p>(</span><span class=n>RestTemplate</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>300000</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>forObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bean</span><span class=p>.</span><span class=na>getForObject</span><span class=p>(</span><span class=s>&#34;http://localhost:9999/first/echo?i=&#34;</span><span class=o>+</span><span class=n>i</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;执行&#34;</span><span class=o>+</span><span class=n>i</span><span class=o>+</span><span class=s>&#34;次&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RestTemplateTestConfig</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RestTemplate</span><span class=w> </span><span class=nf>restTemplate</span><span class=p>(</span><span class=n>RestTemplateBuilder</span><span class=w> </span><span class=n>builder</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>dependencies</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>dependency</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=p>.</span><span class=na>redisson</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>redisson</span><span class=o>-</span><span class=n>spring</span><span class=o>-</span><span class=n>boot</span><span class=o>-</span><span class=n>starter</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&lt;</span><span class=n>version</span><span class=o>&gt;</span><span class=n>3</span><span class=p>.</span><span class=na>13</span><span class=p>.</span><span class=na>1</span><span class=o>&lt;/</span><span class=n>version</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;/</span><span class=n>dependency</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>dependency</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>httpcomponents</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>httpclient</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;/</span><span class=n>dependency</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;/</span><span class=n>dependencies</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>port</span><span class=p>:</span><span class=w> </span><span class=n>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nl>spring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>host</span><span class=p>:</span><span class=w> </span><span class=n>101</span><span class=p>.</span><span class=na>43</span><span class=p>.</span><span class=na>164</span><span class=p>.</span><span class=na>254</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>password</span><span class=p>:</span><span class=w> </span><span class=n>hkc810215</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=n>management</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>  </span><span class=n>endpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>    </span><span class=n>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>      </span><span class=n>exposure</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>        </span><span class=n>include</span><span class=p>:</span><span class=w> </span><span class=s>&#34;metrics&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>  </span><span class=n>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>    </span><span class=n>web</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>      </span><span class=n>client</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>        </span><span class=n>request</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>          </span><span class=n>autotime</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=w>            </span><span class=n>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>
</span></span></span></code></pre></div><p>启动项目通过jconsole查看整个堆的监控和老年代监控分别如下，可以看出老年代一直在增长，并不会回收，</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/b103b9f8d48a56d17efeb929ce55cb09.png loading=lazy alt=image></p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/f394832fb68fc9b5d0a5920592c32c9c.png loading=lazy alt=image></p><p>甚至手动触发GC，老年代也回收不了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=o>[</span><span class=n>Full</span><span class=w> </span><span class=nf>GC</span><span class=w> </span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>gc</span><span class=p>())</span><span class=w> </span><span class=o>[</span><span class=n>Tenured</span><span class=p>:</span><span class=w> </span><span class=n>195217K</span><span class=o>-&gt;</span><span class=n>195457K</span><span class=p>(</span><span class=n>204800K</span><span class=p>),</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>3975261</span><span class=w> </span><span class=n>secs</span><span class=o>]</span><span class=w> </span><span class=n>233021K</span><span class=o>-&gt;</span><span class=n>195457K</span><span class=p>(</span><span class=n>296960K</span><span class=p>),</span><span class=w> </span><span class=o>[</span><span class=n>Metaspace</span><span class=p>:</span><span class=w> </span><span class=n>30823K</span><span class=o>-&gt;</span><span class=n>30823K</span><span class=p>(</span><span class=n>33152K</span><span class=p>)</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>3976223</span><span class=w> </span><span class=n>secs</span><span class=o>]</span><span class=w> </span><span class=o>[</span><span class=n>Times</span><span class=p>:</span><span class=w> </span><span class=n>user</span><span class=o>=</span><span class=n>0</span><span class=p>.</span><span class=na>39</span><span class=w> </span><span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=p>.</span><span class=na>00</span><span class=p>,</span><span class=w> </span><span class=n>real</span><span class=o>=</span><span class=n>0</span><span class=p>.</span><span class=na>40</span><span class=w> </span><span class=n>secs</span><span class=o>]</span><span class=w> 
</span></span></span></code></pre></div><p>通过jprofiler确定主要是meterMap占据内存了，最多的都是字符串。</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/3b86f6f9197615d6a4576e8f5680beae.png loading=lazy alt=image></p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/b941ddd27869fc84b96320cfd319ebeb.png loading=lazy alt=image></p><h2 id=分析>分析</h2><h3 id=actuator导致rest启动了metrics记录>actuator导致rest启动了metrics记录</h3><p>在使用RestTemplateBuilder构建RestTemplate的时候，会触发懒加载的RestTemplateAutoConfiguration里的RestTemplateBuilderConfigurer，在此期间，config中会注入RestTempalteCustomizer类型的bean。</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/1c1f55cbab2f18c514d71b927407fb14.png loading=lazy alt=image></p><p>而项目中引用了redisson-spring-boot-starter，从依赖分析可以看出间接引用了actuator相关的包。</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/0482c8d69d436e1dd5b093cb379af320.png loading=lazy alt=image></p><p>这导致会在RestTemplateMetricsConfiguration配置类中实例化一个叫做MetricsRestTemplateCustomizer的bean，这个bean会通过上面的restTepalteBuilderConfigurer.configure方法给restTemplate添加拦截器MetricsClientHttpRequestInterceptor。</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/e5ab4340ba8235142f091438184ce69e.png loading=lazy alt=image></p><p>拦截器的intercept方法会在finnally中最终记录此次请求的一些指标</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/dbf55220b842080cb0ad326499c8fc27.png loading=lazy alt=image></p><p>io.micrometer.core.instrument.Timer.Builder#register-></p><p>io.micrometer.core.instrument.MeterRegistry#time-></p><p>io.micrometer.core.instrument.MeterRegistry#registerMeterIfNecessary-></p><p>io.micrometer.core.instrument.MeterRegistry#getOrCreateMeter{</p><p>meterMap.put(mappedId, m);</p><p>}</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/6b6ca0a0f42eedffaf21f3458c5c35b3.png loading=lazy alt=image></p><p>最终存到了是SimpleMeterRegistry这个bean的meterMap中去，这个bean也是actuator-autoconfigure自动注入的</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/72a5e91b3a438be2932692edd4d98427.png loading=lazy alt=image></p><p>但是到目前为止，只是启动了metrics记录，假如maxUriTags有效的话，会在超过100条记录后getOrCreateMeter方法里的accept这里过滤掉，并不会走到下面的meterMap.put(mappedId, m)</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/3d1e2ddbcf8608c7c05c2a94c079ca4b.png loading=lazy alt=image></p><h3 id=为什么maxuritags没有生效>为什么maxUriTags没有生效？</h3><p>maxUriTags只在下图这个位置使用了，作用是构建了一个MeterFilter，根据debug我们可以确定bean是产生了的</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/3104116217d9ce059ead802b830d06ee.png loading=lazy alt=image></p><p>但是在accept这里打上断点，再触发一些请求可以发现，代码并不会走到这里</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/7fa118caa87b3e644c30add211d01fd1.png loading=lazy alt=image></p><p>往上跟，没有走到这里的情况只能是filters里没有这个MeterFilter，但我们刚才又确定metricsHttpCLientUriTagFilter这个bean是产生了的，那么就只能是没有添加到filters，也就是没有调用过meterFilter</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/a0c28b1b8e080480b98dcc36caa9c5ae.png loading=lazy alt=image></p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/1a475e08f62def93921d049919bdc50b.png loading=lazy alt=image></p><p>从meterFilter往上只有可能是addFilters，一层一层往上最终到了MeterRegistryPostProcessor#postProcessAfterInitialization这个方法</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/a02f8403f0e7fdaa7b45f288f83893ac.png loading=lazy alt=image>
<img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/8ea1ce9ce41e4eeae01c0ee0b0673307.png loading=lazy alt=image>
<img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/31c720983f5788ae95b4e6c1a56990b6.png loading=lazy alt=image></p><p>我们上面说过负责记录的bean叫做simpleMeterRegistry，但是我们在这里打上条件断点发现并没有走到这里</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/4231cb8bef189b5bef139a35eb95d4b4.png loading=lazy alt=image></p><p>找到SimpleMeterRegistry和MeterRegistryPostProcessor这两个bean注入的地方打断点观察，都产生了，且MeterRegistryPostProcessor比SimpleMeterRegistry产生的要早</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/ba3f183257bb8243f1528466c53b9d85.png loading=lazy alt=image>
<img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/3a25688bbe04cf72b4979a1ff37b617e.png loading=lazy alt=image></p><p>理论上没问题，但现在确实没走到，所以只能在SimpleMeterRegistry产生的时候在org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization打断点，然后可以发现，在simpleMeterRegistry实例化快结束的时候，调用后处理器时this.beanPostProcessors确实没有MeterRegistryPostProcessor</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/e5e065390133498747b5da1a475e46d6.png loading=lazy alt=image>
<img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/8904478e9677cf7c25b0ec446e839c05.png loading=lazy alt=image></p><p>一般来说，postPorcessor的bean注入是在refresh方法的registerBeanPostProcessors中，是早于普通bean的实例化</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/d039259bf6df5f4d1340659ef90707fc.png loading=lazy alt=image></p><p>所以simpleMeterRegistry实例化的时候没有MeterRegistryPostProcessor是不合理的情况，定位simpleMeterRegistry是何时实例化的成了关键问题</p><h4 id=simplemeterregistry的实例化时机>simpleMeterRegistry的实例化时机</h4><p>在new SimpleMeterRegistry这里打上断点观察堆栈发现，simpleMeterRegistry是MetricsRepositoryMethodInvocationListener的参数，MetricsRepositoryMethodInvocationListener则是metricsRepositoryMethodInvocationListenerBeanPostProcessor的参数</p><p>所以是在实例化metricsRepositoryMethodInvocationListenerBeanPostProcessor这个处理器的时候，因为依赖导致先实例化了simpleMeterRegistry这个bean</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/66ad4c3d5054bfbcdf88cb48d35ee6b6.png loading=lazy alt=image>
<img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/c946a93c8bb47a8826572a6cd5775bae.png loading=lazy alt=image>
<img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/b249ebfbfa59d082a65f342524158075.png loading=lazy alt=image>
<img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/9f72f4a1b23830ad845c47434ca52923.png loading=lazy alt=image></p><p>依赖，导致实例化了SimpleMeterRegistry，而这个时候由于没有注册，所以SimpleMeterRegistry在执行applyBeanPostProcessorsAfterInitialization时就执行不到meterRegistryPostProcessor了</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/c10b2bd3bd467fb74592a972fbfd64f2.png loading=lazy alt=image></p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/ed15842ca83fbe8e1d87fc348e5f6466.png loading=lazy alt=image></p><p>spring已经修复了这个问题，spring-boot-actuator-autoconfigure版本大于2.5.0的都已经没有问题了。解决方案</p><p>2.5.1 版本中，添加了一个这个ObjectProvider，在源头上不会立即把依赖的bean初始化完</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/6edf9aa8e5296718dfc7f8769fbcd73e.png loading=lazy alt=image></p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/02e7c2b5edb7d6206e8b7f8a8094eaf1.png loading=lazy alt=image></p><p>2.5.0 版本</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/af294f40c61283037c4c61ea514d3f47.png loading=lazy alt=image></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>resolveDependency</span><span class=p>(</span><span class=n>DependencyDescriptor</span><span class=w> </span><span class=n>descriptor</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>requestingBeanName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>autowiredBeanNames</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>TypeConverter</span><span class=w> </span><span class=n>typeConverter</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>BeansException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>descriptor</span><span class=p>.</span><span class=na>initParameterNameDiscovery</span><span class=p>(</span><span class=n>getParameterNameDiscoverer</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Optional</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>descriptor</span><span class=p>.</span><span class=na>getDependencyType</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>createOptionalDependency</span><span class=p>(</span><span class=n>descriptor</span><span class=p>,</span><span class=w> </span><span class=n>requestingBeanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//由于使用了ObjectProvider，所以这里只是返回了一个DependencyObjectProvider</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ObjectFactory</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>descriptor</span><span class=p>.</span><span class=na>getDependencyType</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>ObjectProvider</span><span class=p>.</span><span class=na>class</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>descriptor</span><span class=p>.</span><span class=na>getDependencyType</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DependencyObjectProvider</span><span class=p>(</span><span class=n>descriptor</span><span class=p>,</span><span class=w> </span><span class=n>requestingBeanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>javaxInjectProviderClass</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>descriptor</span><span class=p>.</span><span class=na>getDependencyType</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Jsr330Factory</span><span class=p>().</span><span class=na>createDependencyProvider</span><span class=p>(</span><span class=n>descriptor</span><span class=p>,</span><span class=w> </span><span class=n>requestingBeanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//2.5.0版本中会在这个方法加载入参依赖的bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Object</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAutowireCandidateResolver</span><span class=p>().</span><span class=na>getLazyResolutionProxyIfNecessary</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>descriptor</span><span class=p>,</span><span class=w> </span><span class=n>requestingBeanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>doResolveDependency</span><span class=p>(</span><span class=n>descriptor</span><span class=p>,</span><span class=w> </span><span class=n>requestingBeanName</span><span class=p>,</span><span class=w> </span><span class=n>autowiredBeanNames</span><span class=p>,</span><span class=w> </span><span class=n>typeConverter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></section><footer class=article-footer><section class=article-tags><a href=/tags/%E7%BA%BF%E4%B8%8A%E5%BC%82%E5%B8%B8/>线上异常</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2025-02-12</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/tech/problem/task_fullgc/><div class=article-details><h2 class=article-title>记一次内存飙升、gc频繁、cpu飙高</h2></div></a></article><article><a href=/post/tech/problem/thread_exception/><div class=article-details><h2 class=article-title>线程异常增长</h2></div></a></article><article><a href=/post/base/binary/><div class=article-details><h2 class=article-title>Binary</h2></div></a></article><article class=has-image><a href=/post/tech/distributed/raft/theory/><div class=article-image><img src=http://picgo-cloudflare.qisiii.asia/post/2024/11/ffef51adc51af216dd8ff2e16ebac9d3.png loading=lazy data-key=theory data-hash=http://picgo-cloudflare.qisiii.asia/post/2024/11/ffef51adc51af216dd8ff2e16ebac9d3.png></div><div class=article-details><h2 class=article-title>Raft算法理论学习(一)</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/diff_acceptepoch_currentepoch/><div class=article-details><h2 class=article-title>AcceptEpoch和CurrentEpoch区别</h2></div></a></article></div></div></aside><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script src=https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js></script><script>const gitalk=new Gitalk({clientID:"Ov23libDgguDHlLK57yi",clientSecret:"bfd2cba55f272f4919357e37e54e4f4697cdd7d0",repo:"qisiii.github.io",owner:"qisiii",admin:["qisiii"],distractionFreeMode:!1,id:md5(location.pathname)});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script><a href=#top aria-label="go to top" class=top-link id=top-link style=display:none><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg>
</a><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>$(window).scroll(function(){$(this).scrollTop()>300?$("#top-link").show():$("#top-link").hide()})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2025 起司</section><section class=powerby><a href=https://beian.miit.gov.cn/ target=_blank>京ICP备2023017017号-1</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_site_pv></span>次
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user" aria-hidden=true></i>
<span id=busuanzi_value_site_uv></span>人次</span></section></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>