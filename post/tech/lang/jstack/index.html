<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Jstack应用 jstack是java提供的工具，一般用于分析栈-线程相关的问题，常见的比如死锁问题，cpu过高问题。 jstack 命令使用方式如下： jstack"><title>Jstack使用</title>
<link rel=canonical href=https://qisiii.github.io/post/tech/lang/jstack/><link rel=stylesheet href=/scss/style.min.7657e19dfcc00117e827b40bd92bcea286037ffa4a33e95fc533eaea79d078f9.css><meta property='og:title' content="Jstack使用"><meta property='og:description' content="Jstack应用 jstack是java提供的工具，一般用于分析栈-线程相关的问题，常见的比如死锁问题，cpu过高问题。 jstack 命令使用方式如下： jstack"><meta property='og:url' content='https://qisiii.github.io/post/tech/lang/jstack/'><meta property='og:site_name' content='起司的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='java'><meta property='article:tag' content='tool'><meta property='article:published_time' content='2024-07-28T17:14:47+08:00'><meta property='article:modified_time' content='2024-09-13T16:45:38+00:00'><meta name=twitter:title content="Jstack使用"><meta name=twitter:description content="Jstack应用 jstack是java提供的工具，一般用于分析栈-线程相关的问题，常见的比如死锁问题，cpu过高问题。 jstack 命令使用方式如下： jstack"><link rel=alternate type=application/json href=https://qisiii.github.io/post/tech/lang/jstack/index.json><link rel=alternate type=application/rss+xml href=https://qisiii.github.io/post/tech/lang/jstack/index.xml><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NDCRP4S7S"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NDCRP4S7S")}</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><span id=top></span></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huf89847f5290877d03a6309f0caaa56f1_43584_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>起司的博客</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/qisiii target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页|Home</span></a></li><li><a href=/post/friends target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-heart-handshake"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/><path d="M12 6 8.707 9.293a1 1 0 000 1.414l.543.543c.69.69 1.81.69 2.5.0l1-1a3.182 3.182.0 014.5.0l2.25 2.25"/><path d="M12.5 15.5l2 2"/><path d="M15 13l2 2"/></svg>
<span>友链|Friends</span></a></li><li><a href=/post/search target=_blank><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索|Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#jstack应用>Jstack应用</a><ol><li><a href=#jstack文件分析>Jstack文件分析</a><ol><li><a href=#参数分析>参数分析</a></li><li><a href=#状态>状态</a></li><li><a href=#线程的操作>线程的操作</a></li><li><a href=#例子>例子：</a></li></ol></li></ol></li><li><a href=#死循环cpu打满问题>死循环cpu打满问题</a><ol><li><a href=#测试代码>测试代码：</a></li></ol></li><li><a href=#死锁问题>死锁问题</a></li><li><a href=#参考文档>参考文档：</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tech/>技术人生</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/tech/lang/jstack/>Jstack使用</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-07-28</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
<time class=article-time--reading>7分钟</time></div><span id=busuanzi_container_value_page_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_page_pv></span>&nbsp;</span><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><div class=artile-time-reading><a href=https://qisiii.github.io/tags/java>#java</a>
<a href=https://qisiii.github.io/tags/tool>#tool</a></div></footer></div></header><section class=article-content><h2 id=jstack应用>Jstack应用</h2><p>jstack是java提供的工具，一般用于分析栈-线程相关的问题，常见的比如死锁问题，cpu过高问题。</p><p>jstack 命令使用方式如下：</p><p><code>jstack [-F][-l][-m] pid</code> 或者<code>jstack [-F][-l][-m] [server_id@]&lt;remote server IP or hostname</code></p><p>可以通过-h或者-help来了解每个参数具体的作用，pid指的是java项目所属的进程Id，一般通过jps命令或者top、ps等命令获取。</p><h3 id=jstack文件分析>Jstack文件分析</h3><h4 id=参数分析>参数分析</h4><p><img src=http://picgo.qisiii.asia/post/202407283188d3b762db93252b8fe9318264d476.png loading=lazy></p><p>大部分的信息都如上图所示：</p><p>&ldquo;pool-1-thread-2&rdquo; 表示线程的名字</p><p>#12 猜测是线程的nativeId，和arthas的线程id列很像，但是arthas官网文档又强调不是nativeId</p><p>prio表示java内定义的线程的优先级</p><p>os_prio操作系统级别的优先级</p><p>tid 猜测是一个地址，但具体不清楚</p><p>nid 操作系统级别线程的线程id,可通过top -pid [java应用进程id] 获取</p><p>下面的红色部分则是状态、调用链路、一些锁的操作信息，具体下面分开讲</p><h4 id=状态>状态</h4><p>Java中线程的状态有六种：NEW、RUNNABLE、BLOCKED、WAITING、TIMED_WAITING、TERMINATED</p><p>其中，NEW和TERMINATED是创建和销毁时的状态，在stack中没有见到过，基本上都是其他四种状态在流转。)
<img src=http://picgo.qisiii.asia/post/20240729b959e899f9a391eecb650ee6a786e976.png loading=lazy></p><p>RUNNABLE:表示当前可以被cpu调度执行或者已经在执行。</p><p>为了更好的解释BLOCKED，这里要结合synchronized的底层原理Monitor来进行讲解：
<img src=https://i.loli.net/2020/05/20/1vf4anVdw8juzt3.png loading=lazy alt=monitor></p><p>Monitor是java对象规定的一个区域，可以视作一个房间。</p><p>当持有synchronized锁的时候，表示当前线程持有Monitor，释放锁表示释放Monitor。因此，同一时刻只有一个线程可以持有，这个信息被记录在对象头的markword部分中。</p><p>左边的entrySet用于记录等待获取锁的线程（即最开始抢锁失败的线程），此时这些线程的状态就为BLOCKED，抢到锁的线程状态为RUNNABLE。</p><p>当拥有锁的线程释放锁的时候，存在两种可能：</p><p>一种是释放了并且再也不使用了，即线程工作完成了，此时线程就结束掉，状态变为TERMINATED。</p><p>一种是释放了但是线程是核心线程，可能还会继续调用，此时线程状态会为WAITING或者TIMED_WAITING，此时这个线程就会被放入到右边的waitSet。当调用notify或者到指定时间之后，就会将线程重新添加到左边的entrySet中再次尝试获取锁。</p><h4 id=线程的操作>线程的操作</h4><p>线程的操作是指在stack文件堆栈信息中，用于描述线程对锁、对象的一些操作，堆栈信息一般如下面这般，-locked就是线程的操作，分为几类：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>TIMED_WAITING</span><span class=w> </span><span class=p>(</span><span class=n>sleeping</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>Native</span><span class=w> </span><span class=n>Method</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>.</span><span class=na>test1</span><span class=p>(</span><span class=n>JStackExample</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>18</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=o>&lt;</span><span class=n>0x000000076adddbb8</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample$$Lambda$1</span><span class=o>/</span><span class=n>777874839</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Unknown</span><span class=w> </span><span class=n>Source</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor</span><span class=p>.</span><span class=na>runWorker</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1149</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor$Worker</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>624</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>750</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>WAITING</span><span class=w> </span><span class=p>(</span><span class=n>parking</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>sun</span><span class=p>.</span><span class=na>misc</span><span class=p>.</span><span class=na>Unsafe</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=n>Native</span><span class=w> </span><span class=n>Method</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>parking</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>wait</span><span class=w> </span><span class=k>for</span><span class=w>  </span><span class=o>&lt;</span><span class=n>0x000000076adddb80</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>AbstractQueuedSynchronizer$ConditionObject</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>LockSupport</span><span class=p>.</span><span class=na>park</span><span class=p>(</span><span class=n>LockSupport</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>175</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>AbstractQueuedSynchronizer$ConditionObject</span><span class=p>.</span><span class=na>await</span><span class=p>(</span><span class=n>AbstractQueuedSynchronizer</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>2044</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>LinkedBlockingQueue</span><span class=p>.</span><span class=na>take</span><span class=p>(</span><span class=n>LinkedBlockingQueue</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>442</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor</span><span class=p>.</span><span class=na>getTask</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1074</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor</span><span class=p>.</span><span class=na>runWorker</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1134</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor$Worker</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>624</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>750</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><strong>locked [地址]</strong>：当前线程持有锁，即持有monitor</p><p><strong>waiting on [地址]</strong> ：线程释放锁，等待通知，即在waitSet中</p><p><strong>waiting to lock [地址]</strong>：线程获取锁失败，正在等待获取锁，即在entrySet中</p><p><strong>parking to wait for [地址]</strong>：这种的是属于非synchronized锁的信息，多用于Lock锁，对应park方法，具体参考<a class=link href=https://stackoverflow.com/questions/11337384/java-thread-dump-difference-between-waiting-to-lock-and-parking-to-wait-for target=_blank rel=noopener>multithreading - Java thread dump: Difference between "waiting to lock" and "parking to wait for"? - Stack Overflow</a></p><h4 id=例子>例子：</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>Boolean</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>producer</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=o>+</span><span class=s>&#34;抢到了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>flag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>5000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=o>+</span><span class=s>&#34;执行了test1&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>consumer</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=o>+</span><span class=s>&#34;抢到了锁&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>flag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>5000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=o>+</span><span class=s>&#34;执行了test2&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>executorService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>newFixedThreadPool</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JStackExample</span><span class=w> </span><span class=n>example</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JStackExample</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>executorService</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>example</span><span class=p>::</span><span class=n>producer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>executorService</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>example</span><span class=p>::</span><span class=n>consumer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>一个简单的生产者-消费者例子，生成两次堆栈，分别在producer sleep时和</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>2024</span><span class=o>-</span><span class=n>07</span><span class=o>-</span><span class=n>28</span><span class=w> </span><span class=n>21</span><span class=p>:</span><span class=n>52</span><span class=p>:</span><span class=n>21</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Full</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>dump</span><span class=w> </span><span class=n>OpenJDK</span><span class=w> </span><span class=n>64</span><span class=o>-</span><span class=n>Bit</span><span class=w> </span><span class=n>Server</span><span class=w> </span><span class=nf>VM</span><span class=w> </span><span class=p>(</span><span class=n>25</span><span class=p>.</span><span class=na>392</span><span class=o>-</span><span class=n>b08</span><span class=w> </span><span class=n>mixed</span><span class=w> </span><span class=n>mode</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;Attach Listener&#34;</span><span class=w> </span><span class=err>#</span><span class=n>14</span><span class=w> </span><span class=n>daemon</span><span class=w> </span><span class=n>prio</span><span class=o>=</span><span class=n>9</span><span class=w> </span><span class=n>os_prio</span><span class=o>=</span><span class=n>31</span><span class=w> </span><span class=n>tid</span><span class=o>=</span><span class=n>0x0000000128811800</span><span class=w> </span><span class=n>nid</span><span class=o>=</span><span class=n>0x5b03</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>condition</span><span class=w> </span><span class=o>[</span><span class=n>0x0000000000000000</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>RUNNABLE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;DestroyJavaVM&#34;</span><span class=w> </span><span class=err>#</span><span class=n>13</span><span class=w> </span><span class=n>prio</span><span class=o>=</span><span class=n>5</span><span class=w> </span><span class=n>os_prio</span><span class=o>=</span><span class=n>31</span><span class=w> </span><span class=n>tid</span><span class=o>=</span><span class=n>0x0000000159922000</span><span class=w> </span><span class=n>nid</span><span class=o>=</span><span class=n>0x1503</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>condition</span><span class=w> </span><span class=o>[</span><span class=n>0x0000000000000000</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>RUNNABLE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;pool-1-thread-2&#34;</span><span class=w> </span><span class=err>#</span><span class=n>12</span><span class=w> </span><span class=n>prio</span><span class=o>=</span><span class=n>5</span><span class=w> </span><span class=n>os_prio</span><span class=o>=</span><span class=n>31</span><span class=w> </span><span class=n>tid</span><span class=o>=</span><span class=n>0x0000000159921000</span><span class=w> </span><span class=n>nid</span><span class=o>=</span><span class=n>0x5a03</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>monitor</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>[</span><span class=n>0x0000000172c56000</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>BLOCKED</span><span class=w> </span><span class=p>(</span><span class=n>on</span><span class=w> </span><span class=n>object</span><span class=w> </span><span class=n>monitor</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>.</span><span class=na>test2</span><span class=p>(</span><span class=n>JStackExample</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>27</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>&lt;</span><span class=n>0x000000076adddbb8</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample$$Lambda$2</span><span class=o>/</span><span class=n>930990596</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Unknown</span><span class=w> </span><span class=n>Source</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor</span><span class=p>.</span><span class=na>runWorker</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1149</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor$Worker</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>624</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>750</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;pool-1-thread-1&#34;</span><span class=w> </span><span class=err>#</span><span class=n>11</span><span class=w> </span><span class=n>prio</span><span class=o>=</span><span class=n>5</span><span class=w> </span><span class=n>os_prio</span><span class=o>=</span><span class=n>31</span><span class=w> </span><span class=n>tid</span><span class=o>=</span><span class=n>0x00000001598dc800</span><span class=w> </span><span class=n>nid</span><span class=o>=</span><span class=n>0x5903</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>condition</span><span class=w> </span><span class=o>[</span><span class=n>0x0000000172a4a000</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>TIMED_WAITING</span><span class=w> </span><span class=p>(</span><span class=n>sleeping</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>Native</span><span class=w> </span><span class=n>Method</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>.</span><span class=na>test1</span><span class=p>(</span><span class=n>JStackExample</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>18</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=o>&lt;</span><span class=n>0x000000076adddbb8</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample$$Lambda$1</span><span class=o>/</span><span class=n>777874839</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Unknown</span><span class=w> </span><span class=n>Source</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor</span><span class=p>.</span><span class=na>runWorker</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1149</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor$Worker</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>624</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>750</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>2024</span><span class=o>-</span><span class=n>07</span><span class=o>-</span><span class=n>28</span><span class=w> </span><span class=n>21</span><span class=p>:</span><span class=n>52</span><span class=p>:</span><span class=n>26</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Full</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=n>dump</span><span class=w> </span><span class=n>OpenJDK</span><span class=w> </span><span class=n>64</span><span class=o>-</span><span class=n>Bit</span><span class=w> </span><span class=n>Server</span><span class=w> </span><span class=nf>VM</span><span class=w> </span><span class=p>(</span><span class=n>25</span><span class=p>.</span><span class=na>392</span><span class=o>-</span><span class=n>b08</span><span class=w> </span><span class=n>mixed</span><span class=w> </span><span class=n>mode</span><span class=p>):</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;pool-1-thread-2&#34;</span><span class=w> </span><span class=err>#</span><span class=n>12</span><span class=w> </span><span class=n>prio</span><span class=o>=</span><span class=n>5</span><span class=w> </span><span class=n>os_prio</span><span class=o>=</span><span class=n>31</span><span class=w> </span><span class=n>tid</span><span class=o>=</span><span class=n>0x0000000159921000</span><span class=w> </span><span class=n>nid</span><span class=o>=</span><span class=n>0x5a03</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=n>condition</span><span class=w> </span><span class=o>[</span><span class=n>0x0000000172c56000</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>TIMED_WAITING</span><span class=w> </span><span class=p>(</span><span class=n>sleeping</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>Native</span><span class=w> </span><span class=n>Method</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>.</span><span class=na>test2</span><span class=p>(</span><span class=n>JStackExample</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>33</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=o>&lt;</span><span class=n>0x000000076adddbb8</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample$$Lambda$2</span><span class=o>/</span><span class=n>930990596</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Unknown</span><span class=w> </span><span class=n>Source</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor</span><span class=p>.</span><span class=na>runWorker</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1149</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor$Worker</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>624</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>750</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;pool-1-thread-1&#34;</span><span class=w> </span><span class=err>#</span><span class=n>11</span><span class=w> </span><span class=n>prio</span><span class=o>=</span><span class=n>5</span><span class=w> </span><span class=n>os_prio</span><span class=o>=</span><span class=n>31</span><span class=w> </span><span class=n>tid</span><span class=o>=</span><span class=n>0x00000001598dc800</span><span class=w> </span><span class=n>nid</span><span class=o>=</span><span class=n>0x5903</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>wait</span><span class=p>()</span><span class=w> </span><span class=o>[</span><span class=n>0x0000000172a4a000</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>BLOCKED</span><span class=w> </span><span class=p>(</span><span class=n>on</span><span class=w> </span><span class=n>object</span><span class=w> </span><span class=n>monitor</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Object</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>Native</span><span class=w> </span><span class=n>Method</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>on</span><span class=w> </span><span class=o>&lt;</span><span class=n>0x000000076adddbb8</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Object</span><span class=p>.</span><span class=na>wait</span><span class=p>(</span><span class=n>Object</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>502</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>.</span><span class=na>test1</span><span class=p>(</span><span class=n>JStackExample</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>19</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=o>&lt;</span><span class=n>0x000000076adddbb8</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>JStackExample$$Lambda$1</span><span class=o>/</span><span class=n>777874839</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Unknown</span><span class=w> </span><span class=n>Source</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor</span><span class=p>.</span><span class=na>runWorker</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>1149</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>ThreadPoolExecutor$Worker</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>ThreadPoolExecutor</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>624</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>750</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p> 先看21:52:21时的信息，</p><p>由于是thread1先执行producer，获取到锁，表现为-locked &lt;0x000000076adddbb8>，当执行到sleep时，状态变为TIMED_WAITING</p><p>当执行到wait时，thread1会释放锁，所以在2024-07-28 21:52:26，新增了一条- waiting on &lt;0x000000076adddbb8>，同时状态变为了BLOCKED，表示在等待锁。此时thread2获取到锁,thread2新增- locked &lt;0x000000076adddbb8>，状态为TIMED_WAITING</p><p>当thread的sleep醒来执行了notify时，后面的堆栈信息虽然没有抓取到，但可以推测出来，thread1被唤醒，因此，thread1会再次获取到锁，从堆栈信息来看则是waiting on会变为lock，因为此时只有thread1需要锁，如果有多个线程都需要锁，有可能会变成waiting to lock</p><h2 id=死循环cpu打满问题>死循环cpu打满问题</h2><h3 id=测试代码>测试代码：</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author : qisi
</span></span></span><span class=line><span class=cl><span class=cm> * @date: 2024/7/28
</span></span></span><span class=line><span class=cl><span class=cm> * @description: cpu打满测试用例
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>CpuFullExample</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>empty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=o>=</span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>count</span><span class=o>&lt;</span><span class=n>1000</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>count</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>full</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=o>=</span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>empty</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>full</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>根据top -pid [应用Id]找到cpu最高的tid，将10进制tid转换为16进制</p><p>根据jstack pid 生成tdump文件，根据转换出来的16进制，搜索对应的nid，此时的线程大概率是runnbale，不然怎么可能死循环，然后根据调用链路去找项目中对应的位置。</p><h2 id=死锁问题>死锁问题</h2><p>测试代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DeadLockExample</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>resourceA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>resourceB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>DeadLockExample</span><span class=w> </span><span class=n>deadLockExample</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DeadLockExample</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>runnableA</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>deadLockExample</span><span class=p>.</span><span class=na>resourceA</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;[INFO]: %s get resourceA&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>lineSeparator</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;[INFO]: %s trying to get resourceB&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>lineSeparator</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>deadLockExample</span><span class=p>.</span><span class=na>resourceB</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;[INFO]: %s get resourceB&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>lineSeparator</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;[INFO]: %s has done&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>lineSeparator</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runnable</span><span class=w> </span><span class=n>runnableB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>deadLockExample</span><span class=p>.</span><span class=na>resourceB</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;[INFO]: %s get resourceB&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>lineSeparator</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;[INFO]: %s trying to get resourceA&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>lineSeparator</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>synchronized</span><span class=p>(</span><span class=n>deadLockExample</span><span class=p>.</span><span class=na>resourceA</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=s>&#34;[INFO]: %s get resourceA&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>lineSeparator</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=s>&#34;[INFO]: %s has done&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>lineSeparator</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>runnableA</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>runnableB</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这段程序执行后，runnableA在持有resourceA后会再尝试获取resourceB锁，但此时resourceB锁已经被runnableB获取，释放的条件则是runnableB执行完，但是runnableB执行过程又在等待resourceA锁，这样就陷入了死锁。</p><p>使用jps获取pid，使用jstack pid生成文件。文件内容大致就是下面这样，其中大部分都是如同第一段一般，只有在出现死锁的时候，才会出现第二段（Found one Java-level deadlock），并清楚的告诉是哪些线程陷入死锁。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=s>&#34;Thread-1&#34;</span><span class=w> </span><span class=err>#</span><span class=n>14</span><span class=w> </span><span class=n>prio</span><span class=o>=</span><span class=n>5</span><span class=w> </span><span class=n>os_prio</span><span class=o>=</span><span class=n>31</span><span class=w> </span><span class=n>tid</span><span class=o>=</span><span class=n>0x0000000125809000</span><span class=w> </span><span class=n>nid</span><span class=o>=</span><span class=n>0x7a03</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>monitor</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>[</span><span class=n>0x000000016efba000</span><span class=o>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>:</span><span class=w> </span><span class=n>BLOCKED</span><span class=w> </span><span class=p>(</span><span class=n>on</span><span class=w> </span><span class=n>object</span><span class=w> </span><span class=n>monitor</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=na>qisi</span><span class=p>.</span><span class=na>simple</span><span class=p>.</span><span class=na>Jvisualvm</span><span class=p>.</span><span class=na>DeadLockExample$2</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>DeadLockExample</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>59</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>&lt;</span><span class=n>0x000000076b5dee40</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Object</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>locked</span><span class=w> </span><span class=o>&lt;</span><span class=n>0x000000076b5dee50</span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Object</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>at</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Thread</span><span class=p>.</span><span class=na>run</span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>java</span><span class=p>:</span><span class=n>750</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Found</span><span class=w> </span><span class=n>one</span><span class=w> </span><span class=n>Java</span><span class=o>-</span><span class=n>level</span><span class=w> </span><span class=n>deadlock</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;Thread-1&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=n>monitor</span><span class=w> </span><span class=nf>0x0000000124055770</span><span class=w> </span><span class=p>(</span><span class=n>object</span><span class=w> </span><span class=n>0x000000076b5dee40</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Object</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>which</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>held</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=s>&#34;Thread-0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=s>&#34;Thread-0&#34;</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>waiting</span><span class=w> </span><span class=n>to</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=n>monitor</span><span class=w> </span><span class=nf>0x0000000124058000</span><span class=w> </span><span class=p>(</span><span class=n>object</span><span class=w> </span><span class=n>0x000000076b5dee50</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=n>java</span><span class=p>.</span><span class=na>lang</span><span class=p>.</span><span class=na>Object</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>which</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=n>held</span><span class=w> </span><span class=n>by</span><span class=w> </span><span class=s>&#34;Thread-1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Found</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=n>deadlock</span><span class=p>.</span><span class=w>
</span></span></span></code></pre></div><h2 id=参考文档>参考文档：</h2><p><a class=link href=https://zihengcat.github.io/2019/08/09/java-tutorial-for-language-adavanced-deadlock-example-and-solution/ target=_blank rel=noopener>https://zihengcat.github.io/2019/08/09/java-tutorial-for-language-adavanced-deadlock-example-and-solution/</a></p><p><a class=link href=https://cloud.tencent.com/developer/article/1683376 target=_blank rel=noopener>图解 Java 线程生命周期-腾讯云开发者社区-腾讯云</a></p><p><a class=link href=https://xixincan.github.io/2020/05/20/Java/JVM/jstack%E5%B7%A5%E5%85%B7%E8%AF%A6%E8%A7%A3/ target=_blank rel=noopener>JVM系列&ndash;jstack工具详解 | 奚新灿的博客-Chronos</a></p><p><a class=link href=https://blog.csdn.net/CoreyXuu/article/details/110624151 target=_blank rel=noopener>jstack 命令的使用和问题排查分析思路_jstack pid-CSDN博客</a></p><p><a class=link href=https://peakzz.github.io/2021/11/12/Monitor%E5%AF%B9%E8%B1%A1%E5%85%A8%E8%A7%A3%E6%9E%90/ target=_blank rel=noopener>Monitor对象全解析 - 张高峰的博客 | Peakiz Blog</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/tool/>Tool</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2024-09-13</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/tech/lang/java_security/><div class=article-details><h2 class=article-title>Java安全机制之一——SecurityManager和AccessController</h2></div></a></article><article><a href=/post/tech/lang/javaagent/><div class=article-details><h2 class=article-title>JavaAgent技术</h2></div></a></article><article><a href=/post/tech/tool/remote_debug/><div class=article-details><h2 class=article-title>IDEA进程远程Debug</h2></div></a></article><article><a href=/post/tech/lang/javalock/><div class=article-details><h2 class=article-title>JavaLock类源码分析</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/zab/><div class=article-details><h2 class=article-title>Zookeeper源码分析-Zab协议</h2></div></a></article></div></div></aside><script src=//cdn.jsdelivr.net/npm/twikoo@1.6.21/dist/twikoo.all.min.js></script><div id=tcomment></div><style>.twikoo{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}:root[data-scheme=dark]{--twikoo-body-text-color-main:rgba(255, 255, 255, 0.9);--twikoo-body-text-color:rgba(255, 255, 255, 0.7)}.twikoo .el-input-group__prepend,.twikoo .tk-action-icon,.twikoo .tk-submit-action-icon,.twikoo .tk-time,.twikoo .tk-comments-no,.twikoo .tk-comments-count{color:var(--twikoo-body-text-color)}.twikoo .el-input__inner,.twikoo .el-textarea__inner,.twikoo .tk-preview-container,.twikoo .tk-content,.twikoo .tk-nick,.twikoo .tk-send{color:var(--twikoo-body-text-color-main)}.twikoo .el-button{color:var(--twikoo-body-text-color)!important}.twikoo .el-input__count{color:var(--twikoo-body-text-color)!important}.OwO .OwO-body{background-color:var(--body-background)!important;color:var(--body-text-color)!important}</style><script>twikoo.init({envId:"https://qisiii-twikoo.hf.space",el:"#tcomment"})</script><a href=#top aria-label="go to top" class=top-link id=top-link style=display:none><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg>
</a><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>$(window).scroll(function(){$(this).scrollTop()>300?$("#top-link").show():$("#top-link").hide()})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 起司</section><section class=powerby><a href=https://beian.miit.gov.cn/ target=_blank>京ICP备2023017017号-1</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_site_pv></span>次
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user" aria-hidden=true></i>
<span id=busuanzi_value_site_uv></span>人次</span></section></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>