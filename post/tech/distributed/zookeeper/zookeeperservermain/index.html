<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="调试前准备 对于大部分的开源项目，一般都可以从其启动shell脚本中分析出来java启动类。我这里clone源码后以tag 3.9.1为主创建了"><title>Zookeeper源码学习-单机部分通信组件</title>
<link rel=canonical href=https://qisiii.github.io/post/tech/distributed/zookeeper/zookeeperservermain/><link rel=stylesheet href=/scss/style.min.7657e19dfcc00117e827b40bd92bcea286037ffa4a33e95fc533eaea79d078f9.css><meta property='og:title' content="Zookeeper源码学习-单机部分通信组件"><meta property='og:description' content="调试前准备 对于大部分的开源项目，一般都可以从其启动shell脚本中分析出来java启动类。我这里clone源码后以tag 3.9.1为主创建了"><meta property='og:url' content='https://qisiii.github.io/post/tech/distributed/zookeeper/zookeeperservermain/'><meta property='og:site_name' content='起司的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='中间件'><meta property='article:tag' content='注册中心'><meta property='article:tag' content='zookeeper'><meta property='article:published_time' content='2024-08-05T12:59:08+08:00'><meta property='article:modified_time' content='2024-08-19T13:23:00+00:00'><meta name=twitter:title content="Zookeeper源码学习-单机部分通信组件"><meta name=twitter:description content="调试前准备 对于大部分的开源项目，一般都可以从其启动shell脚本中分析出来java启动类。我这里clone源码后以tag 3.9.1为主创建了"><link rel=alternate type=application/json href=https://qisiii.github.io/post/tech/distributed/zookeeper/zookeeperservermain/index.json><link rel=alternate type=application/rss+xml href=https://qisiii.github.io/post/tech/distributed/zookeeper/zookeeperservermain/index.xml><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NDCRP4S7S"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NDCRP4S7S")}</script><span id=top></span></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huf89847f5290877d03a6309f0caaa56f1_43584_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>起司的博客</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/qisiii target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页|Home</span></a></li><li><a href=/post/friends target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-heart-handshake"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/><path d="M12 6 8.707 9.293a1 1 0 000 1.414l.543.543c.69.69 1.81.69 2.5.0l1-1a3.182 3.182.0 014.5.0l2.25 2.25"/><path d="M12.5 15.5l2 2"/><path d="M15 13l2 2"/></svg>
<span>友链|Friends</span></a></li><li><a href=/post/search target=_blank><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索|Search</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#调试前准备>调试前准备</a></li><li><a href=#源码分析>源码分析</a><ol><li><a href=#quorumpeermain>QuorumPeerMain</a></li><li><a href=#zookeeperservermain>ZooKeeperServerMain</a></li><li><a href=#启动入口>启动入口</a></li><li><a href=#通信流程>通信流程</a><ol><li><a href=#servercnxnfactory>ServerCnxnFactory</a></li><li><a href=#requestthrottler>RequestThrottler</a></li><li><a href=#requestprocessor>RequestProcessor</a></li><li><a href=#sessiontracker>SessionTracker</a></li></ol></li></ol></li><li><a href=#参考文档>参考文档：</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tech/>技术人生</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/tech/distributed/zookeeper/zookeeperservermain/>Zookeeper源码学习-单机部分通信组件</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-08-05</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
<time class=article-time--reading>18分钟</time></div><span id=busuanzi_container_value_page_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_page_pv></span>&nbsp;</span><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><div class=artile-time-reading><a href=https://qisiii.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6>#中间件</a>
<a href=https://qisiii.github.io/tags/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83>#注册中心</a>
<a href=https://qisiii.github.io/tags/zookeeper>#zookeeper</a></div></footer></div></header><section class=article-content><h2 id=调试前准备>调试前准备</h2><p>对于大部分的开源项目，一般都可以从其启动shell脚本中分析出来java启动类。我这里clone源码后以tag 3.9.1为主创建了一个分支，方便注释，调试。</p><p>在bin/zkServer.sh脚本中，其启动逻辑如下，如果是执行的./zkServer.sh start的话，最终执行的命令大概是</p><p><code>nohup java [一堆参数] org.apache.zookeeper.server.quorum.QuorumPeerMain [输出日志]</code>,ZOOMAIN变量可以往上溯源，四个出现的地方最终都是QuorumPeerMain类。因此QuorumPeerMain类就是zookeeper的启动类。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>case</span> <span class=nv>$1</span> in
</span></span><span class=line><span class=cl>start<span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>  -n <span class=s2>&#34;Starting zookeeper ... &#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$ZOOPIDFILE</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=nb>kill</span> -0 <span class=sb>`</span>cat <span class=s2>&#34;</span><span class=nv>$ZOOPIDFILE</span><span class=s2>&#34;</span><span class=sb>`</span> &gt; /dev/null 2&gt;<span class=p>&amp;</span>1<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>         <span class=nb>echo</span> <span class=nv>$command</span> already running as process <span class=sb>`</span>cat <span class=s2>&#34;</span><span class=nv>$ZOOPIDFILE</span><span class=s2>&#34;</span><span class=sb>`</span>.
</span></span><span class=line><span class=cl>         <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>      <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    nohup <span class=s2>&#34;</span><span class=nv>$JAVA</span><span class=s2>&#34;</span> <span class=nv>$ZOO_DATADIR_AUTOCREATE</span> <span class=s2>&#34;-Dzookeeper.log.dir=</span><span class=si>${</span><span class=nv>ZOO_LOG_DIR</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s2>&#34;-Dzookeeper.log.file=</span><span class=si>${</span><span class=nv>ZOO_LOG_FILE</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -XX:+HeapDumpOnOutOfMemoryError -XX:OnOutOfMemoryError<span class=o>=</span><span class=s1>&#39;kill -9 %p&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=c1>#  $ZOOMAIN=  org.apache.zookeeper.server.quorum.QuorumPeerMain</span>
</span></span><span class=line><span class=cl>    -cp <span class=s2>&#34;</span><span class=nv>$CLASSPATH</span><span class=s2>&#34;</span> <span class=nv>$JVMFLAGS</span> <span class=nv>$ZOOMAIN</span> <span class=s2>&#34;</span><span class=nv>$ZOOCFG</span><span class=s2>&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$_ZOO_DAEMON_OUT</span><span class=s2>&#34;</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span> &lt; /dev/null <span class=p>&amp;</span>
</span></span></code></pre></td></tr></table></div></div><p><img src=http://picgo.qisiii.asia/post/08-09-44-21-image.png loading=lazy></p><p>知道启动类之后，就要进入debug模式进行调试，这里有两个点需要注意：</p><ol><li><p>设置启动参数</p><p>由于shell脚本通过命令行模式执行的时候拼接了非常多的参数，虽然大部分参数都可以忽略，但是config参数确是必须的，即ZOOMAIN 后的 &ldquo;ZOOCFG&rdquo;。因此在通过idea等编辑器进行debug的时候，要设置program arguments为zk的配置文件(这里的zoo.cfg是复制的zoo_sample.cfg)</p><p><img src=http://picgo.qisiii.asia/post/08-09-53-45-image.png loading=lazy></p></li><li><p>启动时报类找不到，编译失败</p><p>这是由于在pom文件中，有部分依赖的scope是provider类型，即zk项目本身不提供，由依赖方提供。我这里为了省事，将zookeeper-server的pom.xml里所有<code>&lt;scope>provided&lt;/scope></code>都够注释掉了</p></li><li><p>当涉及到客户端和服务端通信时，建议session过期时间设置的长一些，不然在debug的时候总是会session过期，连接关闭</p><p><img src=http://picgo.qisiii.asia/post/09-15-52-41-image.png loading=lazy></p><p>但是由于有最大限制，因此建议临时注释掉最大限制的逻辑</p><p><img src=http://picgo.qisiii.asia/post/09-15-54-09-image.png loading=lazy></p></li></ol><h2 id=源码分析>源码分析</h2><h3 id=quorumpeermain>QuorumPeerMain</h3><p>QuorumPeerMain类的逻辑相对简单，需要注意的是集群和单机两种模式走的是不同的逻辑。下面我会先分析单机模式熟悉结构后，再去看集群模式。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>public static void main(String[] args) {
</span></span><span class=line><span class=cl>        QuorumPeerMain main = new QuorumPeerMain();
</span></span><span class=line><span class=cl>        try {
</span></span><span class=line><span class=cl>            main.initializeAndRun(args);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>protected void initializeAndRun(String[] args) throws ConfigException, IOException, AdminServerException {
</span></span><span class=line><span class=cl>        //args[0]一般是zk的配置文件zoo.cfg,即这里将配置文件转换为javaBean
</span></span><span class=line><span class=cl>        QuorumPeerConfig config = new QuorumPeerConfig();
</span></span><span class=line><span class=cl>        if (args.length == 1) {
</span></span><span class=line><span class=cl>            config.parse(args[0]);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        // Start and schedule the the purge task
</span></span><span class=line><span class=cl>        //通过定时执行PurgeTask来清楚data数据和datalog数据
</span></span><span class=line><span class=cl>        DatadirCleanupManager purgeMgr = new DatadirCleanupManager(
</span></span><span class=line><span class=cl>            config.getDataDir(),
</span></span><span class=line><span class=cl>            config.getDataLogDir(),
</span></span><span class=line><span class=cl>            config.getSnapRetainCount(),
</span></span><span class=line><span class=cl>            config.getPurgeInterval());
</span></span><span class=line><span class=cl>        purgeMgr.start();
</span></span><span class=line><span class=cl>//        集群和单机两种方式
</span></span><span class=line><span class=cl>        if (args.length == 1 &amp;&amp; config.isDistributed()) {
</span></span><span class=line><span class=cl>            runFromConfig(config);
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            LOG.warn(&#34;Either no config or no quorum defined in config, running in standalone mode&#34;);
</span></span><span class=line><span class=cl>            // there is only server in the quorum -- run as standalone
</span></span><span class=line><span class=cl>            //单机模式
</span></span><span class=line><span class=cl>            ZooKeeperServerMain.main(args);
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span></code></pre></td></tr></table></div></div><h3 id=zookeeperservermain>ZooKeeperServerMain</h3><p><img src=http://picgo.qisiii.asia/post/08-13-01-25-image.png loading=lazy></p><p>单机版的组件主要如上图所示。</p><p><strong>AdminServer</strong>: zk通过jetty简单实现了一个后端admin，可通过http://localhost:8080/commands去进行一些操作。</p><p><strong>MetricsProvider</strong>：用于记录、监控一些指标，本文不做分析</p><p><strong>JvmPauseMonitor</strong>: 来源于hadoop的一个监控，有个线程一直死循环，当判断系统暂停时间大于一定指标，打印一条信息</p><p><strong>JMX</strong>: java所提供的jmx</p><p><strong>QuorumPeerConfig</strong>: 读取的是zoo.cfg，服务于zk集群模式</p><p><strong>ServerConfig</strong>: 读取的也是zoo.cfg，但是仅限于zk单机模式，且主要服务于通信组件</p><h3 id=启动入口>启动入口</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>final</span><span class=w> </span><span class=n>ZooKeeperServer</span><span class=w> </span><span class=n>zkServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ZooKeeperServer</span><span class=p>(</span><span class=n>jvmPauseMonitor</span><span class=p>,</span><span class=w> </span><span class=n>txnLog</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>tickTime</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>minSessionTimeout</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>maxSessionTimeout</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>listenBacklog</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>initialConfig</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>boolean</span><span class=w> </span><span class=n>needStartZKServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>getClientPortAddress</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cnxnFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServerCnxnFactory</span><span class=p>.</span><span class=na>createFactory</span><span class=p>();</span><span class=c1>//默认是NIOServerCnxnFactory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cnxnFactory</span><span class=p>.</span><span class=na>configure</span><span class=p>(</span><span class=n>config</span><span class=p>.</span><span class=na>getClientPortAddress</span><span class=p>(),</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>getMaxClientCnxns</span><span class=p>(),</span><span class=w> </span><span class=n>config</span><span class=p>.</span><span class=na>getClientPortListenBacklog</span><span class=p>(),</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//启动入口                </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cnxnFactory</span><span class=p>.</span><span class=na>startup</span><span class=p>(</span><span class=n>zkServer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// zkServer has been started. So we don&#39;t need to start it again in secureCnxnFactory.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>needStartZKServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startup</span><span class=p>(</span><span class=n>ZooKeeperServer</span><span class=w> </span><span class=n>zks</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>startServer</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//启动socket相关的线程</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setZooKeeperServer</span><span class=p>(</span><span class=n>zks</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>startServer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//启动zkDataBase</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>zks</span><span class=p>.</span><span class=na>startdata</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//启动其他组件（限流、processor、session、jmx等）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>zks</span><span class=p>.</span><span class=na>startup</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=通信流程>通信流程</h3><p><img src=http://picgo.qisiii.asia/post/08-11-30-03-image.png loading=lazy></p><h4 id=servercnxnfactory>ServerCnxnFactory</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>stopped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>workerPool</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>workerPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WorkerService</span><span class=p>(</span><span class=s>&#34;NIOWorker&#34;</span><span class=p>,</span><span class=w> </span><span class=n>numWorkerThreads</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SelectorThread</span><span class=w> </span><span class=n>thread</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>selectorThreads</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>thread</span><span class=p>.</span><span class=na>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>.</span><span class=na>NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>thread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// ensure thread is started once and only once</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acceptThread</span><span class=p>.</span><span class=na>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>.</span><span class=na>NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>acceptThread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>expirerThread</span><span class=p>.</span><span class=na>getState</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>State</span><span class=p>.</span><span class=na>NEW</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>expirerThread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ServerCnxnFactory主要负责socket相关的部分，从start方法可以看出，zk的serverSocket设计为了四种线程，acceptThread来监听accept事件，selectorThread监听读写io，workerPool负责处理IO，expirerThread负责处理过期的连接。</p><h5 id=acceptthread>AcceptThread</h5><p>AcceptThread只处理accept事件，且通过队列进行解耦。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>doAccept</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>boolean</span><span class=w> </span><span class=n>accepted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//获取到socketChannel</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acceptSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>accepted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//中间会校验一下是否达到最大连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>sc</span><span class=p>.</span><span class=na>configureBlocking</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//建立连接后分配给selector线程，轮询分配</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Round-robin assign this connection to a selector thread</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>selectorIterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>selectorIterator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectorThreads</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SelectorThread</span><span class=w> </span><span class=n>selectorThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectorIterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//将新accept的socket传递给selector</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>selectorThread</span><span class=p>.</span><span class=na>addAcceptedConnection</span><span class=p>(</span><span class=n>sc</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&#34;Unable to add connection to selector queue&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                          </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34; (shutdown in progress)&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>acceptErrorLogger</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>accepted</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>addAcceptedConnection</span><span class=p>(</span><span class=n>SocketChannel</span><span class=w> </span><span class=n>accepted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//将socket放入acceptedQueue，在selectorThread进行处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stopped</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>acceptedQueue</span><span class=p>.</span><span class=na>offer</span><span class=p>(</span><span class=n>accepted</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//唤醒阻塞在selectorThread上的select方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>wakeupSelector</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=selectorthread>SelectorThread</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//处理读写IO事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>select</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//新accept的socket注册read事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>processAcceptedConnections</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//暂时没理解透下面这个方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>processInterestOpsUpdateRequests</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>select</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//当收到accept事件或者由wakeupSelector()唤醒selector，下面的循环可能有事件，也可能没有事件，有事件优先处理，没有的话跳出select方法，去给新accept的socket注册read事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>selector</span><span class=p>.</span><span class=na>select</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>selected</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selector</span><span class=p>.</span><span class=na>selectedKeys</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectedList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>selected</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Collections</span><span class=p>.</span><span class=na>shuffle</span><span class=p>(</span><span class=n>selectedList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>SelectionKey</span><span class=o>&gt;</span><span class=w> </span><span class=n>selectedKeys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectedList</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>selectedKeys</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>selectedKeys</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>selected</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>key</span><span class=p>.</span><span class=na>isValid</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>isReadable</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>isWritable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//处理IO，其实是将key包装为request扔到workerpool</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>handleIO</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Unexpected ops in select {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=na>readyOps</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processAcceptedConnections</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>SocketChannel</span><span class=w> </span><span class=n>accepted</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>accepted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acceptedQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SelectionKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//当前socket注册read事件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accepted</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>selector</span><span class=p>,</span><span class=w> </span><span class=n>SelectionKey</span><span class=p>.</span><span class=na>OP_READ</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//根据socketChannel创建连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createConnection</span><span class=p>(</span><span class=n>accepted</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//这里key持有了cnxn，这样在处理io的时候才能获取到对应对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>key</span><span class=p>.</span><span class=na>attach</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>addCnxn</span><span class=p>(</span><span class=n>cnxn</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// register, createConnection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>cleanupSelectionKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>fastCloseSock</span><span class=p>(</span><span class=n>accepted</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=expirerthread>expirerThread</h5><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>stopped</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cnxnExpiryQueue</span><span class=p>.</span><span class=na>getWaitTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>waitTime</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>waitTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//关闭过期的链接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>cnxnExpiryQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>SESSIONLESS_CONNECTIONS_EXPIRED</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>conn</span><span class=p>.</span><span class=na>close</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>DisconnectReason</span><span class=p>.</span><span class=na>CONNECTION_EXPIRED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;ConnnectionExpirerThread interrupted&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>expirer线程的run逻辑是很简单的，就是从一个队列取出过期的连接，并进行关闭。程序会通过touchCnxn方法，来延长连接的过期时间。touchCnxn方法在创建连接，处理IO事件的前后都会调用。</p><p>由于连接和session的过期机制都是一样的，所以这里先不分析cnxnExpiryQueue.poll和cnxnExpiryQueue.update方法，在下面讲到sessionTrack的时候进行分析</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>touchCnxn</span><span class=p>(</span><span class=n>NIOServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cnxnExpiryQueue</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getSessionTimeout</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=workpool>workPool</h5><p>worker线程的核心任务，是将socket中的数据读取并封装为request，然后交由processor去处理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>doIO</span><span class=p>(</span><span class=n>SelectionKey</span><span class=w> </span><span class=n>k</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//前4个字节用来记录长度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>k</span><span class=p>.</span><span class=na>isReadable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//将消息长度写到incomingBuffer，返回值小于0表示没有读到消息长度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>rc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sock</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>handleFailedRead</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//正常来讲，消息长度占4个字节，所以此时limit==position</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>boolean</span><span class=w> </span><span class=n>isPayload</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//这里没有特别理解，incomingBuffer什么情况下才会不等于呢？？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>incomingBuffer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>lenBuffer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// start of next request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//变成读模式，会在readLength读到incomingBuffer写入的数据（即长度）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>flip</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//incomingBuffer在这里会重新分配</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>isPayload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readLength</span><span class=p>(</span><span class=n>k</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// continuation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>isPayload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isPayload</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// not the case for 4letterword</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//读取具体的数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>readPayload</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// four letter words take care</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// need not do anything else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>readLength</span><span class=p>(</span><span class=n>SelectionKey</span><span class=w> </span><span class=n>k</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Read the length, now get the buffer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//获取到数据长度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lenBuffer</span><span class=p>.</span><span class=na>getInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>zkServer</span><span class=p>.</span><span class=na>checkRequestSizeWhenReceivingMessage</span><span class=p>(</span><span class=n>len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//重新分配长度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>incomingBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>allocate</span><span class=p>(</span><span class=n>len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>readPayload</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=p>,</span><span class=w> </span><span class=n>ClientCnxnLimitException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//刚分配了新的空间，所以这里一定不等于0，因此可以将socket剩余信息写到incomingBuffer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// have we read length bytes?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>rc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sock</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>);</span><span class=w> </span><span class=c1>// sock is non-blocking, so ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rc</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>handleFailedRead</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//incomingBuffer已经写完数据了，所以下面就是flip后再读数据了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// have we read length bytes?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>flip</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>packetReceived</span><span class=p>(</span><span class=n>4</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>initialized</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//只在这里面会将initialized设置为true，所以第一次建立连接一定会走进来</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>readConnectRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>readRequest</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lenBuffer</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>incomingBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lenBuffer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>当建立连接后第一次处理io会走到readConnectRequest方法，这个方法封装的是ConnectRequest，由processConnectRequest进行处理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BinaryInputArchive</span><span class=w> </span><span class=n>bia</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BinaryInputArchive</span><span class=p>.</span><span class=na>getArchive</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ByteBufferInputStream</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ConnectRequest</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>protocolManager</span><span class=p>.</span><span class=na>deserializeConnectRequest</span><span class=p>(</span><span class=n>bia</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>zkServer</span><span class=p>.</span><span class=na>processConnectRequest</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>其他时候会走到readRequest，封装的是普通的RequestRecord，由processPacket进行处理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>        </span><span class=n>RequestHeader</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestHeader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ByteBufferInputStream</span><span class=p>.</span><span class=na>byteBuffer2Record</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>,</span><span class=w> </span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RequestRecord</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RequestRecord</span><span class=p>.</span><span class=na>fromBytes</span><span class=p>(</span><span class=n>incomingBuffer</span><span class=p>.</span><span class=na>slice</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>zkServer</span><span class=p>.</span><span class=na>processPacket</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>processConnectRequest最核心的工作就是创建了session，并封装了个createSession的request进行处理</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sessionId</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createSession</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>passwd</span><span class=p>,</span><span class=w> </span><span class=n>sessionTimeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=nf>createSession</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>passwd</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>passwd</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Possible since it&#39;s just deserialized from a packet on the wire.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>passwd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>sessionId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sessionTracker</span><span class=p>.</span><span class=na>createSession</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Random</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Random</span><span class=p>(</span><span class=n>sessionId</span><span class=w> </span><span class=o>^</span><span class=w> </span><span class=n>superSecret</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>r</span><span class=p>.</span><span class=na>nextBytes</span><span class=p>(</span><span class=n>passwd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>CreateSessionTxn</span><span class=w> </span><span class=n>txn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CreateSessionTxn</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cnxn</span><span class=p>.</span><span class=na>setSessionId</span><span class=p>(</span><span class=n>sessionId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Request</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>sessionId</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>OpCode</span><span class=p>.</span><span class=na>createSession</span><span class=p>,</span><span class=w> </span><span class=n>RequestRecord</span><span class=p>.</span><span class=na>fromRecord</span><span class=p>(</span><span class=n>txn</span><span class=p>),</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>submitRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span><span class=c1>//所以首次创建session最终还是会走到submitRequest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>sessionId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>processPacket的工作则是进行认证校验和request转发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processPacket</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=w> </span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>RequestHeader</span><span class=w> </span><span class=n>h</span><span class=p>,</span><span class=w> </span><span class=n>RequestRecord</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//除了校验之外则是正常的请求转发</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=p>.</span><span class=na>getType</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>OpCode</span><span class=p>.</span><span class=na>auth</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=p>.</span><span class=na>getType</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>OpCode</span><span class=p>.</span><span class=na>sasl</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>authHelper</span><span class=p>.</span><span class=na>enforceAuthentication</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>getXid</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Authentication enforcement is failed</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Already sent response to user about failure and closed the session, lets return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Request</span><span class=p>(</span><span class=n>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getSessionId</span><span class=p>(),</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>getXid</span><span class=p>(),</span><span class=w> </span><span class=n>h</span><span class=p>.</span><span class=na>getType</span><span class=p>(),</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>cnxn</span><span class=p>.</span><span class=na>getAuthInfo</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>length</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>limit</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isLargeRequest</span><span class=p>(</span><span class=n>length</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// checkRequestSize will throw IOException if request is rejected</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>checkRequestSizeWhenMessageReceived</span><span class=p>(</span><span class=n>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>si</span><span class=p>.</span><span class=na>setLargeRequestSize</span><span class=p>(</span><span class=n>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>si</span><span class=p>.</span><span class=na>setOwner</span><span class=p>(</span><span class=n>ServerCnxn</span><span class=p>.</span><span class=na>me</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//正常的请求则会从这里进去</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>submitRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>至此，我们发现都会走到submitRequest方法，而这个方法的逻辑则是将request扔到节流器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>submitRequest</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>restoreLatch</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Blocking request submission while restore is in progress&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>restoreLatch</span><span class=p>.</span><span class=na>await</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Unexpected interruption&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>enqueueRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span><span class=c1>//会将request扔到throttler的submittedRequests</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>enqueueRequest</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestThrottler</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// Since all requests are passed to the request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// processor it should wait for setting up the request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// processor chain. The state will be updated to RUNNING</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// after the setup.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>State</span><span class=p>.</span><span class=na>INITIAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>wait</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Unexpected interruption&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestThrottler</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=s>&#34;Not started&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>requestThrottler</span><span class=p>.</span><span class=na>submitRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=requestthrottler>RequestThrottler</h4><p>throttler的创建和启动是在startupWithServerState方法中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startupWithServerState</span><span class=p>(</span><span class=n>State</span><span class=w> </span><span class=n>state</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sessionTracker</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>createSessionTracker</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//用于管理每个链接的session</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>startSessionTracker</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//以单链表的方式串起来processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setupRequestProcessors</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//节流器，所有的request都会先过一遍这个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>startRequestThrottler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startRequestThrottler</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>requestThrottler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createRequestThrottler</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>requestThrottler</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>上面讲到所有的请求都执行了<code>requestThrottler.submitRequest</code>,这个操作实际是将请求放入了submittedRequests队列中，requestThrottler作为一个线程，循环取出队列中的请求并判断是否做限流。</p><p>下面的代码主要有两个逻辑：</p><p>一是当正在执行的请求数量达到上限时，要一直阻塞到数量小于maxRequests</p><p>二是假如请求在队列里等待的时间大于throttled_op_wait_time，标记为已限流，后面的Processor处理时会抛异常。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>killed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//从队列取出一个请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>submittedRequests</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Request</span><span class=p>.</span><span class=na>requestOfDeath</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>mustDrop</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Throttling is disabled when maxRequests = 0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>maxRequests</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>killed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//一直都没有处理，导致连接都关闭了，或者session超时了，丢掉请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dropStaleRequests</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>isStale</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>// Note: this will close the connection</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>dropRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>STALE_REQUESTS_DROPPED</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//没达到上限时跳出循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>zks</span><span class=p>.</span><span class=na>getInProcess</span><span class=p>()</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>maxRequests</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//达到上限了的话，等待stallTime这么在重新进循环，避免过多执行循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>throttleSleep</span><span class=p>(</span><span class=n>stallTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>killed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// A dropped stale request will be null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>request</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isStale</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>STALE_REQUESTS</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>elapsedTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>requestThrottleQueueTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>REQUEST_THROTTLE_QUEUE_TIME</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>elapsedTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//当在队列等待时间过长，大于限流等待时间时，会将请求标志位已限流；已限流的请求在finalRequestProcessor中会抛异常Code.THROTTLEDOP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldThrottleOp</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>elapsedTime</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>request</span><span class=p>.</span><span class=na>setIsThrottled</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                      </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>THROTTLED_OPS</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//交由Processor去处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>zks</span><span class=p>.</span><span class=na>submitRequestNow</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>假如没有被限流的话，执行到<code>zks.submitRequestNow(request);</code>后就将request交给processor处理了</p><h4 id=requestprocessor>RequestProcessor</h4><p>zookeeper中将Processor分为了三个Processor，其启动是在setupRequestProcessors方法中，以链表的形式串起了三个processor，以PrepRequestProcessor为head，FinalRequestProcessor为tail。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setupRequestProcessors</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RequestProcessor</span><span class=w> </span><span class=n>finalProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FinalRequestProcessor</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>RequestProcessor</span><span class=w> </span><span class=n>syncProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SyncRequestProcessor</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>finalProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>((</span><span class=n>SyncRequestProcessor</span><span class=p>)</span><span class=w> </span><span class=n>syncProcessor</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>firstProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PrepRequestProcessor</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>syncProcessor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>((</span><span class=n>PrepRequestProcessor</span><span class=p>)</span><span class=w> </span><span class=n>firstProcessor</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nf>PrepRequestProcessor</span><span class=p>(</span><span class=n>ZooKeeperServer</span><span class=w> </span><span class=n>zks</span><span class=p>,</span><span class=w> </span><span class=n>RequestProcessor</span><span class=w> </span><span class=n>nextProcessor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>nextProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextProcessor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nf>SyncRequestProcessor</span><span class=p>(</span><span class=n>ZooKeeperServer</span><span class=w> </span><span class=n>zks</span><span class=p>,</span><span class=w> </span><span class=n>RequestProcessor</span><span class=w> </span><span class=n>nextProcessor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>zks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>zks</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>nextProcessor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextProcessor</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=preprequestprocessor>PrepRequestProcessor</h5><p>PrepRequestProcessor的主要工作就是校验和创建事务。</p><p>当调用processRequest时，也是通过队列解耦了一下，通过线程去异步执行，核心方法就是pRequestHelper</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processRequest</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>request</span><span class=p>.</span><span class=na>prepQueueStartTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>submittedRequests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>PREP_PROCESSOR_QUEUED</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&#34;PrepRequestProcessor (sid:%d) started, reconfigEnabled=%s&#34;</span><span class=p>,</span><span class=w> </span><span class=n>zks</span><span class=p>.</span><span class=na>getServerId</span><span class=p>(),</span><span class=w> </span><span class=n>zks</span><span class=p>.</span><span class=na>reconfigEnabled</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>submittedRequests</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>...</span><span class=na>不重要的逻辑</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>pRequest</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>RequestProcessorException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>request</span><span class=p>.</span><span class=na>setHdr</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>request</span><span class=p>.</span><span class=na>setTxn</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//正常情况下request的isThrottled应该是false，所以会执行pRequestHelper</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>request</span><span class=p>.</span><span class=na>isThrottled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//一些前置的校验，事务的创建等</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>pRequestHelper</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//获取事务ID，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>request</span><span class=p>.</span><span class=na>zxid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>zks</span><span class=p>.</span><span class=na>getZxid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>timeFinishedPrepare</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>PREP_PROCESS_TIME</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>timeFinishedPrepare</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>prepStartTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//由syncRequestProcessor执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>nextProcessor</span><span class=p>.</span><span class=na>processRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>PROPOSAL_PROCESS_TIME</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>timeFinishedPrepare</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>pRequestHelper方法里根据不同的OpCode有各自的处理方法，但是总共依旧可以区分为两大类：需要创建事务和不需要创建事务</p><p>不需要创建事务的如下，就只执行checkSession方法，就是校验一下session是否正常</p><p><img src=http://picgo.qisiii.asia/post/08-16-57-44-image.png loading=lazy></p><p>而需要创建事务的逻辑则也差不多，大多数都是封装为一个Request对象，然后执行pRequest2Txn方法</p><p><img src=http://picgo.qisiii.asia/post/08-17-00-50-image.png loading=lazy></p><p>pRequest2Txn方法的主要逻辑则是校验request、校验Acl权限、校验路径、校验[quota](<a class=link href=https://www.cnblogs.com/cc11001100/p/9971808.html target=_blank rel=noopener>Zookeeper笔记之quota - CC11001100 - 博客园</a>)、创建事务和创建事务摘要</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//校验request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>validateCreateRequest</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>createMode</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>ttl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//acl权限校验</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>zks</span><span class=p>.</span><span class=na>checkACL</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>cnxn</span><span class=p>,</span><span class=w> </span><span class=n>parentRecord</span><span class=p>.</span><span class=na>acl</span><span class=p>,</span><span class=w> </span><span class=n>ZooDefs</span><span class=p>.</span><span class=na>Perms</span><span class=p>.</span><span class=na>CREATE</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>authInfo</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>listACL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//校验路径名称合规</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>validatePath</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>sessionId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//校验节点数和字节数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>zks</span><span class=p>.</span><span class=na>checkQuota</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>OpCode</span><span class=p>.</span><span class=na>create</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//创建事务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>request</span><span class=p>.</span><span class=na>setTxn</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CreateTxn</span><span class=p>(</span><span class=n>path</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>listACL</span><span class=p>,</span><span class=w> </span><span class=n>createMode</span><span class=p>.</span><span class=na>isEphemeral</span><span class=p>(),</span><span class=w> </span><span class=n>newCversion</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//事务摘要</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>setTxnDigest</span><span class=p>(</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>nodeRecord</span><span class=p>.</span><span class=na>precalculatedDigest</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=syncrequestprocessor>SyncRequestProcessor</h5><p>SyncRequestProcessor主要有两个操作，一个是写事务，一个是生成快照。</p><p>对于非事务操作，这个processor是没有意义的；只有事务操作，才会进行日志的持久化。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// we do this in an attempt to ensure that not all of the servers</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// in the ensemble take a snapshot at the same time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>resetSnapshotStats</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lastFlushTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>SYNC_PROCESSOR_QUEUE_SIZE</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>queuedRequests</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>pollTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>zks</span><span class=p>.</span><span class=na>getMaxWriteQueuePollTime</span><span class=p>(),</span><span class=w> </span><span class=n>getRemainingDelay</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//之所有先poll一次是为了当queuedRequests队列为null的时候，期望可以触发一下flush</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Request</span><span class=w> </span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queuedRequests</span><span class=p>.</span><span class=na>poll</span><span class=p>(</span><span class=n>pollTime</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>si</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=cm>/* We timed out looking for more writes to batch, go ahead and flush immediately */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>queuedRequests</span><span class=p>.</span><span class=na>take</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>si</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>REQUEST_OF_DEATH</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>startProcessTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>SYNC_PROCESSOR_QUEUE_TIME</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>startProcessTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>si</span><span class=p>.</span><span class=na>syncQueueStartTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 普通的查询都没有事务，所以都会返回false；append这里只是写到了流里，还需要在commit方法中调用flush才会落盘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>si</span><span class=p>.</span><span class=na>isThrottled</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>zks</span><span class=p>.</span><span class=na>getZKDatabase</span><span class=p>().</span><span class=na>append</span><span class=p>(</span><span class=n>si</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldSnapshot</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>resetSnapshotStats</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// roll the log</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>zks</span><span class=p>.</span><span class=na>getZKDatabase</span><span class=p>().</span><span class=na>rollLog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>// take a snapshot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>snapThreadMutex</span><span class=p>.</span><span class=na>tryAcquire</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Too busy to snap, skipping&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>new</span><span class=w> </span><span class=n>ZooKeeperThread</span><span class=p>(</span><span class=s>&#34;Snapshot Thread&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>zks</span><span class=p>.</span><span class=na>takeSnapshot</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>LOG</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;Unexpected exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                        </span><span class=n>snapThreadMutex</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>toFlush</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// optimization for read heavy workloads</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// iff this is a read or a throttled request(which doesn&#39;t need to be written to the disk),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// and there are no pending flushes (writes), then just pass this to the next processor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//当没有需要flush的内容，直接调用下一个processor处理；但假如toFlush队列有内容，就只能排队处理了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextProcessor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>nextProcessor</span><span class=p>.</span><span class=na>processRequest</span><span class=p>(</span><span class=n>si</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextProcessor</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Flushable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>((</span><span class=n>Flushable</span><span class=p>)</span><span class=w> </span><span class=n>nextProcessor</span><span class=p>).</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//排队处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>toFlush</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>si</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shouldFlush</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>SYNC_PROCESS_TIME</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startProcessTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleException</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getName</span><span class=p>(),</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;SyncRequestProcessor exited!&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>关于写事务的方法是append和flush</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>append</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TxnHeader</span><span class=w> </span><span class=n>hdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getHdr</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//普通的查询都没有事务，所以都会返回false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hdr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//当logStream == null时会新创建文件，首次创建或者文件达到上限新创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logStream</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOG</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Creating new log file: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Util</span><span class=p>.</span><span class=na>makeLogName</span><span class=p>(</span><span class=n>hdr</span><span class=p>.</span><span class=na>getZxid</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logFileWrite</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>logDir</span><span class=p>,</span><span class=w> </span><span class=n>Util</span><span class=p>.</span><span class=na>makeLogName</span><span class=p>(</span><span class=n>hdr</span><span class=p>.</span><span class=na>getZxid</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fos</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=n>logFileWrite</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedOutputStream</span><span class=p>(</span><span class=n>fos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>oa</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BinaryOutputArchive</span><span class=p>.</span><span class=na>getArchive</span><span class=p>(</span><span class=n>logStream</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>FileHeader</span><span class=w> </span><span class=n>fhdr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileHeader</span><span class=p>(</span><span class=n>TXNLOG_MAGIC</span><span class=p>,</span><span class=w> </span><span class=n>VERSION</span><span class=p>,</span><span class=w> </span><span class=n>dbId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>dataSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oa</span><span class=p>.</span><span class=na>getDataSize</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fhdr</span><span class=p>.</span><span class=na>serialize</span><span class=p>(</span><span class=n>oa</span><span class=p>,</span><span class=w> </span><span class=s>&#34;fileheader&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Make sure that the magic number is written before padding.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//新建文件的文件头要立刻flush</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logStream</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>filePosition</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>oa</span><span class=p>.</span><span class=na>getDataSize</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>dataSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>filePadding</span><span class=p>.</span><span class=na>setCurrentSize</span><span class=p>(</span><span class=n>filePosition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//在commit的时候进行flush</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>streamsToFlush</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>fos</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fileSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filePadding</span><span class=p>.</span><span class=na>padFile</span><span class=p>(</span><span class=n>fos</span><span class=p>.</span><span class=na>getChannel</span><span class=p>(),</span><span class=w> </span><span class=n>filePosition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//request序列化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>request</span><span class=p>.</span><span class=na>getSerializeData</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>buf</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>buf</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IOException</span><span class=p>(</span><span class=s>&#34;Faulty serialization for header &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;and txn&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>dataSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oa</span><span class=p>.</span><span class=na>getDataSize</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Checksum</span><span class=w> </span><span class=n>crc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>makeChecksumAlgorithm</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>crc</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>.</span><span class=na>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>oa</span><span class=p>.</span><span class=na>writeLong</span><span class=p>(</span><span class=n>crc</span><span class=p>.</span><span class=na>getValue</span><span class=p>(),</span><span class=w> </span><span class=s>&#34;txnEntryCRC&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//将request写到流里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Util</span><span class=p>.</span><span class=na>writeTxnBytes</span><span class=p>(</span><span class=n>oa</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>unFlushedSize</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>oa</span><span class=p>.</span><span class=na>getDataSize</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>dataSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>flush</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>RequestProcessorException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>toFlush</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>BATCH_SIZE</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>toFlush</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>flushStartTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//将事务日志从流里刷到盘里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>zks</span><span class=p>.</span><span class=na>getZKDatabase</span><span class=p>().</span><span class=na>commit</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>SYNC_PROCESSOR_FLUSH_TIME</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>flushStartTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>nextProcessor</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>toFlush</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>toFlush</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=n>Request</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>toFlush</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>latency</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=na>syncQueueStartTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>SYNC_PROCESSOR_QUEUE_AND_FLUSH_TIME</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>latency</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//到finalRequestProcessor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>nextProcessor</span><span class=p>.</span><span class=na>processRequest</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>nextProcessor</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Flushable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>((</span><span class=n>Flushable</span><span class=p>)</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>nextProcessor</span><span class=p>).</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lastFlushTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>commit</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logStream</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>logStream</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>filePosition</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>unFlushedSize</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If we have written more than we have previously preallocated,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// we should override the fileSize by filePosition.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>filePosition</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>fileSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>fileSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>filePosition</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>unFlushedSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>FileOutputStream</span><span class=w> </span><span class=n>log</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>streamsToFlush</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//刷盘</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>log</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>streamsToFlush</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>streamsToFlush</span><span class=p>.</span><span class=na>poll</span><span class=p>().</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 达到上限了创建新事务文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>txnLogSizeLimit</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>logSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCurrentLogSize</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logSize</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>txnLogSizeLimit</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Log size limit reached: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>logSize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//创建新文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>rollLog</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h5 id=finalrequestprocessor>FinalRequestProcessor</h5><p>到目前为止，如果是查询请求，那还没有进行查询操作；如果是事务请求，只是将事务落盘了，内存中还没有进行修改。加上返回对象的组装，这些都是在这个Processor进行处理的。下面分别以创建节点和查询数据两个为例</p><ol><li><p>创建节点（create）</p><p>创建节点属于事务操作，所以在返回结果之间要同步修改内存中的值，核心方法是applyRequest，一直会执行到DataTree的processTxn</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processRequest</span><span class=p>(</span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOG</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Processing request:: {}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ProcessTxnResult</span><span class=w> </span><span class=n>rc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>request</span><span class=p>.</span><span class=na>isThrottled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=c1>//处理事务或session</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>rc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>applyRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><img src=http://picgo.qisiii.asia/post/08-18-10-27-image.png loading=lazy></p><p><img src=http://picgo.qisiii.asia/post/08-18-11-39-image.png loading=lazy></p><p>将其执行结果封装为response，并发送出去</p><p><img src=http://picgo.qisiii.asia/post/08-18-14-23-image.png loading=lazy></p><p><img src=http://picgo.qisiii.asia/post/08-18-15-29-image.png loading=lazy></p></li><li><p>查询数据（getData）</p><p>由于查询数据不是事务，所以在applyRequest中并没有啥操作，直接走到下面的switch，封装request，然后从zkDataBase获取节点，再获取数据封装为response并返回</p><p><img src=http://picgo.qisiii.asia/post/08-18-17-46-image.png loading=lazy></p><p><img src=http://picgo.qisiii.asia/post/08-18-18-31-image.png loading=lazy></p><p><img src=http://picgo.qisiii.asia/post/08-18-19-46-image.png loading=lazy></p></li></ol><h4 id=sessiontracker>SessionTracker</h4><p>session是逻辑上客户端和服务端的一次长连接的通话，依托于物理的长连接connection。当第一次建立连接之后，zookeeper会为这个链接创建一个session并设置一个过期时间，只要没到过期时间，期间哪怕连接断开，只要可以重新连接，那依然算作一个session内。</p><p>zookeeper利用session实现了如临时节点，即当session过期，当前session所建立的临时节点都会被删除。</p><p>sessionTrack的创建也是在zookeeperServer.start的时候</p><p><img src=https://raw.githubusercontent.com/qisiii/imagehost/main/2024/08/08-23-05-42-image.png loading=lazy><img src=http://picgo.qisiii.asia/post/08-23-06-04-image.png loading=lazy></p><p>而session的过期处理和connect的过期处理逻辑基本一样，在这里以session讲解一下逻辑，上面的connect过期部分也就看的懂了。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>running</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>long</span><span class=w> </span><span class=n>waitTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sessionExpiryQueue</span><span class=p>.</span><span class=na>getWaitTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>waitTime</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>waitTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//看似是poll，其实是取出expiryMap中已经过期的队列</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>SessionImpl</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>sessionExpiryQueue</span><span class=p>.</span><span class=na>poll</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ServerMetrics</span><span class=p>.</span><span class=na>getMetrics</span><span class=p>().</span><span class=na>STALE_SESSIONS_EXPIRED</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>setSessionClosing</span><span class=p>(</span><span class=n>s</span><span class=p>.</span><span class=na>sessionId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>expirer</span><span class=p>.</span><span class=na>expire</span><span class=p>(</span><span class=n>s</span><span class=p>);</span><span class=c1>//其实就是close操作</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>过期逻辑核心是一个队列ExpiryQueue，核心方法是update和poll方法。</p><p>ExpiryQueue持有两个集合对象elemMap和expiryMap，</p><p>elemMap的key为连接对象，在这里就是指session，在connect逻辑中就是指connect，value是其过期时间。</p><p>expiryMap的key是过期时间，value是当前过期时间下对应的连接的集合。结构大概如下图。</p><p><img src=http://picgo.qisiii.asia/post/08-23-22-07-image.png loading=lazy></p><p>此外，ExpiryQueue还记录了下一个要过期的时间nextExpirationTime，因此，对于poll方法，就是遍历expiryMap，找到nextExpirationTime&lt;now&lt;key的values，并关闭即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=nf>poll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//当前最后一个要过期的时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>expirationTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextExpirationTime</span><span class=p>.</span><span class=na>get</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//时间还没到，所以都不过期</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>now</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>expirationTime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>emptySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//计算下一个周期并赋值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>newExpirationTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expirationTime</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>expirationInterval</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>nextExpirationTime</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=n>expirationTime</span><span class=p>,</span><span class=w> </span><span class=n>newExpirationTime</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//取到上一个过期的周期的集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expiryMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>expirationTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>set</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>emptySet</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>set</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>而update方法也好理解，其实就是给session续期，假如续期之后其落到下个周期了，则要从上个周期对应的集合移除，添加到下个周期的集合</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=nf>update</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>elem</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>timeout</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//取到session的之前过期时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>prevExpiryTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elemMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>elem</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Time</span><span class=p>.</span><span class=na>currentElapsedTime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//续期</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>newExpiryTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>roundToNextInterval</span><span class=p>(</span><span class=n>now</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>timeout</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//续期之后依然属于上个周期，则不需要改变expiryMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>newExpiryTime</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>prevExpiryTime</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// No change, so nothing to update</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//续期之后不属于上个周期了，则要将当前sessoin加到下一个周期的集合，并从上一个集合删除</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// First add the elem to the new expiry time bucket in expiryMap.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expiryMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>newExpiryTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>set</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Construct a ConcurrentHashSet using a ConcurrentHashMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>newSetFromMap</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Put the new set in the map, but only if another thread</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// hasn&#39;t beaten us to it</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>existingSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expiryMap</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>newExpiryTime</span><span class=p>,</span><span class=w> </span><span class=n>set</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>existingSet</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>set</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>existingSet</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>set</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>elem</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Map the elem to the new expiry time. If a different previous</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// mapping was present, clean up the previous expiry bucket.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>prevExpiryTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elemMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>elem</span><span class=p>,</span><span class=w> </span><span class=n>newExpiryTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prevExpiryTime</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>newExpiryTime</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>prevExpiryTime</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>E</span><span class=o>&gt;</span><span class=w> </span><span class=n>prevSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>expiryMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>prevExpiryTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>prevSet</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>prevSet</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>elem</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>newExpiryTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>而update方法的调用上层是touchSession，在Processor处理前会调用。</p><h2 id=参考文档>参考文档：</h2><p><a class=link href=https://juejin.cn/post/7112332360053424165#heading-20 target=_blank rel=noopener>【图解源码】Zookeeper3.7源码分析，包含服务启动流程源码、网络通信源码、RequestProcessor处理请求源码 - 掘金</a></p><p><a class=link href=https://juejin.cn/post/7112681401601769486 target=_blank rel=noopener>【图解源码】Zookeeper3.7源码剖析，Session的管理机制，Leader选举投票规则，集群数据同步流程 - 掘金</a></p><p><a class=link href=https://mouday.github.io/coding-tree/zookeeper/zookeeper-code.html#_2-1-%E8%BE%85%E5%8A%A9%E6%BA%90%E7%A0%81 target=_blank rel=noopener>Zookeeper源码分析 | Coding Tree</a></p><p><a class=link href=https://www.cnblogs.com/cc11001100/p/9971808.html target=_blank rel=noopener>Zookeeper笔记之quota - CC11001100 - 博客园</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/>中间件</a>
<a href=/tags/%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83/>注册中心</a>
<a href=/tags/zookeeper/>Zookeeper</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2024-08-19</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/tech/distributed/zookeeper/zab/><div class=article-details><h2 class=article-title>Zookeeper源码分析-Zab协议</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/election/><div class=article-details><h2 class=article-title>Zookeeper源码分析-选举机制</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/watch/><div class=article-details><h2 class=article-title>Zookeeper源码分析-watch机制</h2></div></a></article><article><a href=/post/tech/distributed/redis_cluster_deploy/><div class=article-details><h2 class=article-title>单服务器Redis集群部署记录</h2></div></a></article><article><a href=/post/tech/distributed/dubbo/dubbo_spi/><div class=article-details><h2 class=article-title>Dubbo的SPI增强</h2></div></a></article></div></div></aside><script src=//cdn.jsdelivr.net/npm/twikoo@1.6.21/dist/twikoo.all.min.js></script><div id=tcomment></div><style>.twikoo{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}:root[data-scheme=dark]{--twikoo-body-text-color-main:rgba(255, 255, 255, 0.9);--twikoo-body-text-color:rgba(255, 255, 255, 0.7)}.twikoo .el-input-group__prepend,.twikoo .tk-action-icon,.twikoo .tk-submit-action-icon,.twikoo .tk-time,.twikoo .tk-comments-no,.twikoo .tk-comments-count{color:var(--twikoo-body-text-color)}.twikoo .el-input__inner,.twikoo .el-textarea__inner,.twikoo .tk-preview-container,.twikoo .tk-content,.twikoo .tk-nick,.twikoo .tk-send{color:var(--twikoo-body-text-color-main)}.twikoo .el-button{color:var(--twikoo-body-text-color)!important}.twikoo .el-input__count{color:var(--twikoo-body-text-color)!important}.OwO .OwO-body{background-color:var(--body-background)!important;color:var(--body-text-color)!important}</style><script>twikoo.init({envId:"https://qisiii-twikoo.hf.space",el:"#tcomment"})</script><a href=#top aria-label="go to top" class=top-link id=top-link style=display:none><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg>
</a><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>$(window).scroll(function(){$(this).scrollTop()>300?$("#top-link").show():$("#top-link").hide()})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 起司</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_site_pv></span>次
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user" aria-hidden=true></i>
<span id=busuanzi_value_site_uv></span>人次</span></section></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>