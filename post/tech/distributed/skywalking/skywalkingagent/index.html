<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Skywalking 从架构上分为三个大模块，分别是Agent、Oap（Backend&amp;Storage）、UI。这篇文档主要是介绍Agent部分。这部分"><title>SkywalkingAgent启动流程源码分析</title>
<link rel=canonical href=https://www.qisiii.asia/post/tech/distributed/skywalking/skywalkingagent/><link rel=stylesheet href=/scss/style.min.7657e19dfcc00117e827b40bd92bcea286037ffa4a33e95fc533eaea79d078f9.css><meta property='og:title' content="SkywalkingAgent启动流程源码分析"><meta property='og:description' content="Skywalking 从架构上分为三个大模块，分别是Agent、Oap（Backend&amp;Storage）、UI。这篇文档主要是介绍Agent部分。这部分"><meta property='og:url' content='https://www.qisiii.asia/post/tech/distributed/skywalking/skywalkingagent/'><meta property='og:site_name' content='起司的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='中间件'><meta property='article:tag' content='Skywalking'><meta property='article:tag' content='监控'><meta property='article:published_time' content='2023-08-29T00:00:00+00:00'><meta property='article:modified_time' content='2025-02-13T05:54:52+00:00'><meta name=twitter:title content="SkywalkingAgent启动流程源码分析"><meta name=twitter:description content="Skywalking 从架构上分为三个大模块，分别是Agent、Oap（Backend&amp;Storage）、UI。这篇文档主要是介绍Agent部分。这部分"><link rel=alternate type=application/json href=https://www.qisiii.asia/post/tech/distributed/skywalking/skywalkingagent/index.json><link rel=alternate type=application/rss+xml href=https://www.qisiii.asia/post/tech/distributed/skywalking/skywalkingagent/index.xml><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NDCRP4S7S"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NDCRP4S7S")}</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><span id=top></span></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huf89847f5290877d03a6309f0caaa56f1_43584_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>起司的博客</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/qisiii target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页|Home</span></a></li><li><a href=/post/friends target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-heart-handshake"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/><path d="M12 6 8.707 9.293a1 1 0 000 1.414l.543.543c.69.69 1.81.69 2.5.0l1-1a3.182 3.182.0 014.5.0l2.25 2.25"/><path d="M12.5 15.5l2 2"/><path d="M15 13l2 2"/></svg>
<span>友链|Friends</span></a></li><li><a href=/post/search target=_blank><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索|Search</span></a></li><li><a href=/leetcode target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-leetcode"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg>
<span>力扣|Leetcode</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#skywalkingagent类>SkyWalkingAgent类</a><ol><li><a href=#读取并整合配置>读取并整合配置</a></li><li><a href=#加载插件>加载插件</a></li><li><a href=#agentbuilder>AgentBuilder</a><ol><li><a href=#type>type()</a></li><li><a href=#transform>transform()</a></li><li><a href=#installon>installOn()</a></li></ol></li></ol></li><li><a href=#参考文档>参考文档:</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tech/>技术人生</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/tech/distributed/skywalking/skywalkingagent/>SkywalkingAgent启动流程源码分析</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023-08-29</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
<time class=article-time--reading>10分钟</time></div><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><div class=artile-time-reading><a href=https://www.qisiii.asia/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6>#中间件</a>
<a href=https://www.qisiii.asia/tags/skywalking>#Skywalking</a>
<a href=https://www.qisiii.asia/tags/%E7%9B%91%E6%8E%A7>#监控</a></div></footer></div></header><section class=article-content><p>Skywalking 从架构上分为三个大模块，分别是Agent、Oap（Backend&amp;Storage）、UI。这篇文档主要是介绍Agent部分。这部分核心依赖的是java的agent技术，对这个技术陌生的可以先看一下<a class=link href=https://www.qisiii.asia/post/tech/lang/javaagent/>Agent</a> 这篇文章。Skywalking在agent的基础上利用<a class=link href=http://bytebuddy.net/#/tutorial-cn target=_blank rel=noopener>ByteBuddy</a>类库对类和方法等进行加强，实现无入侵的监测。</p><h2 id=skywalkingagent类>SkyWalkingAgent类</h2><p>在官方的skywalking-agent包中，通过MANIFEST.MF的Premain-Class值，我们可以确定入口类是org.apache.skywalking.apm.agent.SkyWalkingAgent，而核心的方法就是里面的premain方法，大概的内容是以下四部分。</p><ol><li><p>读取并整合配置</p></li><li><p>加载插件</p></li><li><p>通过AgentBuilder注入到jvm</p></li><li><p>启动上报相关的服务等</p></li></ol><h3 id=读取并整合配置>读取并整合配置</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//将各个途径的配置都处理汇总到CONFIG类里，CONFIG类里面全是静态字段，所以直接赋值也不需要实例化对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SnifferConfigInitializer</span><span class=p>.</span><span class=na>initializeCoreConfig</span><span class=p>(</span><span class=n>agentArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initializeCoreConfig</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>agentOptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AGENT_SETTINGS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Properties</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//loadConfig方法中会优先从指定的系统属性skywalking_config中取值（即 java -Dskywalking_config=xxx/custom.config)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//如果没有设置，则默认加载SKYWALKING_AGENT_PATH/config/agent.config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>InputStreamReader</span><span class=w> </span><span class=n>configFileStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadConfig</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AGENT_SETTINGS</span><span class=p>.</span><span class=na>load</span><span class=p>(</span><span class=n>configFileStream</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>AGENT_SETTINGS</span><span class=p>.</span><span class=na>stringPropertyNames</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=w> </span><span class=n>AGENT_SETTINGS</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//替换占位符的变量，依次从System.getProperty(key)-&gt;System.getenv(key)-&gt;properties.getProperty(key)-&gt;default取</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AGENT_SETTINGS</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>PropertyPlaceholderHelper</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>.</span><span class=na>replacePlaceholders</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>AGENT_SETTINGS</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed to read the config file, skywalking is going to run in default config.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//替换通过java -Dskywalking.指定的变量值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//这里我觉得很奇怪，明明上面也是处理系统属性，这里为什么还要专门用skywalking前缀区分呢？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>overrideConfigBySystemProp</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed to read the system properties.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>agentOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>StringUtil</span><span class=p>.</span><span class=na>trim</span><span class=p>(</span><span class=n>agentOptions</span><span class=p>,</span><span class=w> </span><span class=sc>&#39;,&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>StringUtil</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>agentOptions</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>agentOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>agentOptions</span><span class=p>.</span><span class=na>trim</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;Agent options is {}.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>agentOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//替换在 java -agent:/***.jar=key:value里的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>overrideConfigByAgentOptions</span><span class=p>(</span><span class=n>agentOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed to parse the agent options, val is {}.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>agentOptions</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//通过反射将AGENT_SETTINGS注入到Config的变量中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>initializeConfig</span><span class=p>(</span><span class=n>Config</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=加载插件>加载插件</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//这一步实际上是加载了插件jar包里的增加类def里面描述的类，最终都传到了PluginFinder，存储为三种不同的对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pluginFinder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PluginFinder</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>PluginBootstrap</span><span class=p>().</span><span class=na>loadPlugins</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=nf>loadPlugins</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>AgentPackageNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//可以通过启动一次看日志，了解这里是先装载jar包再识别出def</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//注意，这里自定义了一个类加载器,并且加载了activations和plugins/plugins下的jar包</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//Q&amp;A 2023/8/27</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Q:为什么要自定义类加载器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// A:为了加载插件的那些jar包，继承自AppClassLodder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AgentClassLoader</span><span class=p>.</span><span class=na>initDefaultLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PluginResourcesResolver</span><span class=w> </span><span class=n>resolver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PluginResourcesResolver</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//获取所有的skywalking-plugin.def，由于上面的jar包已经添加，所以实际就是那些jar包里的skywalking-plugin.def</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span><span class=w> </span><span class=n>resources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resolver</span><span class=p>.</span><span class=na>getResources</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resources</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>resources</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;no plugin files (skywalking-plugin.def) found, continue to start application.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>URL</span><span class=w> </span><span class=n>pluginUrl</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>resources</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//最终都加载到了List&lt;PluginDefine&gt; pluginClassList里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>PluginCfg</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>.</span><span class=na>load</span><span class=p>(</span><span class=n>pluginUrl</span><span class=p>.</span><span class=na>openStream</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=s>&#34;plugin file [{}] init failure.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pluginUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>PluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=n>pluginClassList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PluginCfg</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>.</span><span class=na>getPluginClassList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=n>plugins</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>PluginDefine</span><span class=w> </span><span class=n>pluginDefine</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>pluginClassList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;loading plugin class {}.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pluginDefine</span><span class=p>.</span><span class=na>getDefineClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//Q&amp;A 2023/8/22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Q:为什么这里所有的类都能强转为AbstractClassEnhancePluginDefine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// A:因为插件继承的顶层最终都是这个抽象类,见下面类图</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractClassEnhancePluginDefine</span><span class=w> </span><span class=n>plugin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=p>)</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>pluginDefine</span><span class=p>.</span><span class=na>getDefineClass</span><span class=p>(),</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>AgentClassLoader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getDefault</span><span class=p>()).</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>plugins</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>plugin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=s>&#34;load plugin [{}] failure.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pluginDefine</span><span class=p>.</span><span class=na>getDefineClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//这个是通过SPI用所有的InstrumentationLoader来添加AbstractClassEnhancePluginDefine，不知道用在哪</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>plugins</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>DynamicPluginLoader</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>.</span><span class=na>load</span><span class=p>(</span><span class=n>AgentClassLoader</span><span class=p>.</span><span class=na>getDefault</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>plugins</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//这里面将插件分到了三个不同的集合中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nf>PluginFinder</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=n>plugins</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=w> </span><span class=n>plugin</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>plugins</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassMatch</span><span class=w> </span><span class=n>match</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>plugin</span><span class=p>.</span><span class=na>enhanceClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>match</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//重写enhanceClass，以restTemplate为例，enhanceClass是NameMatch.byName(&#34;org.springframework.web.client.RestTemplate&#34;)，所以对应map的key就是&#34;org.springframework.web.client.RestTemplate&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>match</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>NameMatch</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>NameMatch</span><span class=w> </span><span class=n>nameMatch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>NameMatch</span><span class=p>)</span><span class=w> </span><span class=n>match</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=n>pluginDefines</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nameMatchDefine</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>nameMatch</span><span class=p>.</span><span class=na>getClassName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pluginDefines</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pluginDefines</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>nameMatchDefine</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>nameMatch</span><span class=p>.</span><span class=na>getClassName</span><span class=p>(),</span><span class=w> </span><span class=n>pluginDefines</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pluginDefines</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>plugin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>signatureMatchDefine</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>plugin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>plugin</span><span class=p>.</span><span class=na>isBootstrapInstrumentation</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bootstrapClassMatchDefine</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>plugin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/1affea7202e2d9060c841e4d2faee965.jpg loading=lazy></p><h3 id=agentbuilder>AgentBuilder</h3><p>这中间有一部分是JDK9的模块相关的内容，由于我还没有深入了解过JDK9相关的内容，加上</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//这一步实际上是加载了插件jar包里的增加类def里面描述的类，最终都传到了PluginFinder，存储为三种不同的对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>pluginFinder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PluginFinder</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>PluginBootstrap</span><span class=p>().</span><span class=na>loadPlugins</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=nf>loadPlugins</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>AgentPackageNotFoundException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//可以通过启动一次看日志，了解这里是先装载jar包再识别出def</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//注意，这里自定义了一个类加载器,并且加载了activations和plugins/plugins下的jar包</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//Q&amp;A 2023/8/27</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Q:为什么要自定义类加载器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// A:为了加载插件的那些jar包，继承自AppClassLodder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AgentClassLoader</span><span class=p>.</span><span class=na>initDefaultLoader</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>PluginResourcesResolver</span><span class=w> </span><span class=n>resolver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PluginResourcesResolver</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//获取所有的skywalking-plugin.def，由于上面的jar包已经添加，所以实际就是那些jar包里的skywalking-plugin.def</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span><span class=w> </span><span class=n>resources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resolver</span><span class=p>.</span><span class=na>getResources</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resources</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>resources</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;no plugin files (skywalking-plugin.def) found, continue to start application.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>URL</span><span class=w> </span><span class=n>pluginUrl</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>resources</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//最终都加载到了List&lt;PluginDefine&gt; pluginClassList里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>PluginCfg</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>.</span><span class=na>load</span><span class=p>(</span><span class=n>pluginUrl</span><span class=p>.</span><span class=na>openStream</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=s>&#34;plugin file [{}] init failure.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pluginUrl</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>PluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=n>pluginClassList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PluginCfg</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>.</span><span class=na>getPluginClassList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=n>plugins</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>PluginDefine</span><span class=w> </span><span class=n>pluginDefine</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>pluginClassList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;loading plugin class {}.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pluginDefine</span><span class=p>.</span><span class=na>getDefineClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//Q&amp;A 2023/8/22</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// Q:为什么这里所有的类都能强转为AbstractClassEnhancePluginDefine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// A:因为插件继承的顶层最终都是这个抽象类,见下面类图</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractClassEnhancePluginDefine</span><span class=w> </span><span class=n>plugin</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=p>)</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>pluginDefine</span><span class=p>.</span><span class=na>getDefineClass</span><span class=p>(),</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=n>AgentClassLoader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>getDefault</span><span class=p>()).</span><span class=na>newInstance</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>plugins</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>plugin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=s>&#34;load plugin [{}] failure.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pluginDefine</span><span class=p>.</span><span class=na>getDefineClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//这个是通过SPI用所有的InstrumentationLoader来添加AbstractClassEnhancePluginDefine，不知道用在哪</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>plugins</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>DynamicPluginLoader</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>.</span><span class=na>load</span><span class=p>(</span><span class=n>AgentClassLoader</span><span class=p>.</span><span class=na>getDefault</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>plugins</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//这里面将插件分到了三个不同的集合中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nf>PluginFinder</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=n>plugins</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=w> </span><span class=n>plugin</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>plugins</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassMatch</span><span class=w> </span><span class=n>match</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>plugin</span><span class=p>.</span><span class=na>enhanceClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>match</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//重写enhanceClass，以restTemplate为例，enhanceClass是NameMatch.byName(&#34;org.springframework.web.client.RestTemplate&#34;)，所以对应map的key就是&#34;org.springframework.web.client.RestTemplate&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>match</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>NameMatch</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>NameMatch</span><span class=w> </span><span class=n>nameMatch</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>NameMatch</span><span class=p>)</span><span class=w> </span><span class=n>match</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=w> </span><span class=n>pluginDefines</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nameMatchDefine</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>nameMatch</span><span class=p>.</span><span class=na>getClassName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pluginDefines</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>pluginDefines</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedList</span><span class=o>&lt;</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>nameMatchDefine</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>nameMatch</span><span class=p>.</span><span class=na>getClassName</span><span class=p>(),</span><span class=w> </span><span class=n>pluginDefines</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>pluginDefines</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>plugin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>signatureMatchDefine</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>plugin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>plugin</span><span class=p>.</span><span class=na>isBootstrapInstrumentation</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bootstrapClassMatchDefine</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>plugin</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这里开始就要用到ByteBuddy了，先简单了解下<a class=link href>AgentBuilder</a> ，然后我们结合插件分析源码中的核心部分</p><p>比较关键的其实就是type、transform和installOn三个方法，其他的ignore、with感兴趣的可以自己研究，不影响主流程的理解</p><h4 id=type>type()</h4><p>type是命中要处理的类，对应的是插件里的enhanceClass，如果enhanceClass实现是指定的类名称，那么在之前已经加入到nameMatchDefine里了，如果不是则各自解析，比如Spring的插件就是通过注解来匹配</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>ClassMatch</span><span class=w> </span><span class=nf>enhanceClass</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ClassAnnotationMatch</span><span class=p>.</span><span class=na>byClassAnnotationMatch</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getEnhanceAnnotations</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=nf>getEnhanceAnnotations</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;org.springframework.web.bind.annotation.RestController&#34;</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 主要是通过插件里定义的NameMatch和IndirectMatch来匹配，IndirectMatch就是要更复杂，比如匹配的更多，前缀，后缀之类的，参考IndirectMatch的实现类
</span></span></span><span class=line><span class=cl><span class=cm> * @return
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>ElementMatcher</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>TypeDescription</span><span class=o>&gt;</span><span class=w> </span><span class=nf>buildMatch</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ElementMatcher</span><span class=p>.</span><span class=na>Junction</span><span class=w> </span><span class=n>judge</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AbstractJunction</span><span class=o>&lt;</span><span class=n>NamedElement</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>matches</span><span class=p>(</span><span class=n>NamedElement</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>nameMatchDefine</span><span class=p>.</span><span class=na>containsKey</span><span class=p>(</span><span class=n>target</span><span class=p>.</span><span class=na>getActualName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>judge</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>judge</span><span class=p>.</span><span class=na>and</span><span class=p>(</span><span class=n>not</span><span class=p>(</span><span class=n>isInterface</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>AbstractClassEnhancePluginDefine</span><span class=w> </span><span class=n>define</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>signatureMatchDefine</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassMatch</span><span class=w> </span><span class=n>match</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>define</span><span class=p>.</span><span class=na>enhanceClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>match</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>IndirectMatch</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>judge</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>judge</span><span class=p>.</span><span class=na>or</span><span class=p>(((</span><span class=n>IndirectMatch</span><span class=p>)</span><span class=w> </span><span class=n>match</span><span class=p>).</span><span class=na>buildJunction</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ProtectiveShieldMatcher</span><span class=p>(</span><span class=n>judge</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h4 id=transform>transform()</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>DynamicType</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>define</span><span class=p>(</span><span class=n>TypeDescription</span><span class=w> </span><span class=n>typeDescription</span><span class=p>,</span><span class=w> </span><span class=n>DynamicType</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>builder</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>WitnessFinder</span><span class=w> </span><span class=n>finder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WitnessFinder</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//witness机制，希望加强某类之前，必须有些类已经加载，用于区分版本，让插件和应用的版本所对应</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * find witness classes for enhance class
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>witnessClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>witnessClasses</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>witnessClasses</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>witnessClass</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>witnessClasses</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>finder</span><span class=p>.</span><span class=na>exist</span><span class=p>(</span><span class=n>witnessClass</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;enhance class {} by plugin {} is not activated. Witness class {} does not exist.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>transformClassName</span><span class=p>,</span><span class=w> </span><span class=n>interceptorDefineClassName</span><span class=p>,</span><span class=w> </span><span class=n>witnessClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>WitnessMethod</span><span class=o>&gt;</span><span class=w> </span><span class=n>witnessMethods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>witnessMethods</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>CollectionUtil</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>witnessMethods</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>WitnessMethod</span><span class=w> </span><span class=n>witnessMethod</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>witnessMethods</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>finder</span><span class=p>.</span><span class=na>exist</span><span class=p>(</span><span class=n>witnessMethod</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&#34;enhance class {} by plugin {} is not activated. Witness method {} does not exist.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>transformClassName</span><span class=p>,</span><span class=w> </span><span class=n>interceptorDefineClassName</span><span class=p>,</span><span class=w> </span><span class=n>witnessMethod</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * find origin class source code for interceptor
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicType</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>newClassBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>enhance</span><span class=p>(</span><span class=n>typeDescription</span><span class=p>,</span><span class=w> </span><span class=n>builder</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>,</span><span class=w> </span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>transform是增强命中的类，这里核心方法是org.apache.skywalking.apm.agent.SkyWalkingAgent.Transformer#transform-></p><p>org.apache.skywalking.apm.agent.core.plugin.AbstractClassEnhancePluginDefine#define</p><h5 id=witness机制>Witness机制</h5><p>这里需要提及一个机制，即<a class=link href=https://skywalking.apache.org/docs/skywalking-java/next/en/setup/service-agent/java-agent/java-plugin-development-guide/#implement-plugin target=_blank rel=noopener>Witness机制</a>，他的作用是让引入的插件必须和当前应用组件的版本必须相对应。举例来说，spring-mvc有三个版本的插件，如下面代码所示，不同的版本校验的类并不相同。(但是我去查了spring3456每个版本的类，好像并不太能对应到spring的版本，所以我也不知道skywalking官方的这个mvc插件对应的哪个版本)</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/12/e45135ec82e6af3d6f247b0e9cd202ce.jpg loading=lazy></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>AbstractSpring3Instrumentation</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ClassInstanceMethodsEnhancePluginDefine</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>WITHNESS_CLASSES</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;org.springframework.web.servlet.view.xslt.AbstractXsltView&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AbstractSpring3Instrumentation</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=nf>witnessClasses</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;org.springframework.web.servlet.view.xslt.AbstractXsltView&#34;</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>AbstractSpring4Instrumentation</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ClassInstanceMethodsEnhancePluginDefine</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>WITHNESS_CLASSES</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;org.springframework.cache.interceptor.SimpleKey&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AbstractSpring4Instrumentation</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=nf>witnessClasses</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;org.springframework.cache.interceptor.SimpleKey&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;org.springframework.cache.interceptor.DefaultKeyGenerator&#34;</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>abstract</span><span class=w> </span><span class=kd>class</span> <span class=nc>AbstractSpring5Instrumentation</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>ClassInstanceMethodsEnhancePluginDefine</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>WITNESS_CLASSES</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;org.springframework.beans.annotation.AnnotationBeanUtils&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>AbstractSpring5Instrumentation</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=nf>witnessClasses</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[]</span><span class=p>{</span><span class=s>&#34;org.springframework.beans.annotation.AnnotationBeanUtils&#34;</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h5 id=拦截器>拦截器</h5><p>enhance方法里面包含了两个部分，enhanceClass主要是加强类的静态方法，enhanceInstance则是加强类的构造方法和普通方法.</p><p>这样给插件留出更细粒度的扩展，只需要插件实现InstanceMethodsInterceptPoint等接口就可以了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>DynamicType</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>enhance</span><span class=p>(</span><span class=n>TypeDescription</span><span class=w> </span><span class=n>typeDescription</span><span class=p>,</span><span class=w> </span><span class=n>DynamicType</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>newClassBuilder</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                         </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>classLoader</span><span class=p>,</span><span class=w> </span><span class=n>EnhanceContext</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>PluginException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//这里是实际和插件作用的地方</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>newClassBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>enhanceClass</span><span class=p>(</span><span class=n>typeDescription</span><span class=p>,</span><span class=w> </span><span class=n>newClassBuilder</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>newClassBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>enhanceInstance</span><span class=p>(</span><span class=n>typeDescription</span><span class=p>,</span><span class=w> </span><span class=n>newClassBuilder</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>,</span><span class=w> </span><span class=n>context</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>newClassBuilder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=n>DynamicType</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>enhanceInstance</span><span class=p>(</span><span class=n>TypeDescription</span><span class=w> </span><span class=n>typeDescription</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>DynamicType</span><span class=p>.</span><span class=na>Builder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>newClassBuilder</span><span class=p>,</span><span class=w> </span><span class=n>ClassLoader</span><span class=w> </span><span class=n>classLoader</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EnhanceContext</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>PluginException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Manipulate class source code.&lt;br/&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * new class need:&lt;br/&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 1.Add field, name {@link #CONTEXT_ATTR_NAME}.
</span></span></span><span class=line><span class=cl><span class=cm>     * 2.Add a field accessor for this field.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * And make sure the source codes manipulation only occurs once.
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//生成一个新的类，该类继承EnhancedInstance接口，并且自定义了一个字段叫做_$EnhancedClassField_ws，同时生成了这个的set、get方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//Q&amp;A 2023/8/29</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// Q: 为什么非要指定这样一个字段呢？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// A: 说是为了解决上下文问题，需要这样一个字段缓存，但是我不理解 https://github.com/apache/skywalking/issues/7146</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>typeDescription</span><span class=p>.</span><span class=na>isAssignableTo</span><span class=p>(</span><span class=n>EnhancedInstance</span><span class=p>.</span><span class=na>class</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>context</span><span class=p>.</span><span class=na>isObjectExtended</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newClassBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newClassBuilder</span><span class=p>.</span><span class=na>defineField</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>CONTEXT_ATTR_NAME</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>ACC_PRIVATE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ACC_VOLATILE</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                             </span><span class=p>.</span><span class=na>implement</span><span class=p>(</span><span class=n>EnhancedInstance</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                             </span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=n>FieldAccessor</span><span class=p>.</span><span class=na>ofField</span><span class=p>(</span><span class=n>CONTEXT_ATTR_NAME</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>context</span><span class=p>.</span><span class=na>extendObjectCompleted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//下面的增强构造和实例方法其实很类似</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//核心点在于InstanceMethodsInterceptPoint，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//通过getMethodsMatcher获取需要加强的方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//通过getMethodsInterceptor获取需要插件定义的拦截器，然后将其构造到agentBuilder里</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 2. enhance constructors
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 3. enhance instance methods
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>newClassBuilder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>newClassBuilder</span><span class=p>.</span><span class=na>method</span><span class=p>(</span><span class=n>junction</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=n>MethodDelegation</span><span class=p>.</span><span class=na>withDefaultConfiguration</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=na>to</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=p>(</span><span class=n>interceptor</span><span class=p>,</span><span class=w> </span><span class=n>classLoader</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>newClassBuilder</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这里不对agentBuidle的intercept等具体分析，感兴趣的可以自己看</p><h4 id=installon>installOn()</h4><p>正常定义permain方法时，定义的transformer都是通过addTransformer添加到instrumentation的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>premain</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>agentArgs</span><span class=p>,</span><span class=w> </span><span class=n>Instrumentation</span><span class=w> </span><span class=n>instrumentation</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;enhance by agent,params:&#34;</span><span class=o>+</span><span class=n>agentArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>instrumentation</span><span class=p>.</span><span class=na>addTransformer</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ClassFileTransformer</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span><span class=n>ClassLoader</span><span class=w> </span><span class=n>loader</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>className</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>classBeingRedefined</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>ProtectionDomain</span><span class=w> </span><span class=n>protectionDomain</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>classfileBuffer</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>throws</span><span class=w> </span><span class=n>IllegalClassFormatException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;premain load Class     :&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>className</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>classfileBuffer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>而这里，我们用的是agentBuilder,在transform()部分我们已经知道定义了transformer,其transform方法是遍历插件定义然后加强类，因此我们可以猜测最终肯定也是将transformer添加到instrumentation，最简单的映证方法就是在sun.instrument.InstrumentationImpl#addTransformer(java.lang.instrument.ClassFileTransformer, boolean)打个断点，启动项目</p><p>installon()->org.apache.skywalking.apm.dependencies.net.bytebuddy.agent.builder.AgentBuilder.Default#doInstall()</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>ResettableClassFileTransformer</span><span class=w> </span><span class=nf>doInstall</span><span class=p>(</span><span class=n>Instrumentation</span><span class=w> </span><span class=n>instrumentation</span><span class=p>,</span><span class=w> </span><span class=n>AgentBuilder</span><span class=p>.</span><span class=na>RawMatcher</span><span class=w> </span><span class=n>matcher</span><span class=p>,</span><span class=w> </span><span class=n>AgentBuilder</span><span class=p>.</span><span class=na>PatchMode</span><span class=p>.</span><span class=na>Handler</span><span class=w> </span><span class=n>handler</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>circularityLock</span><span class=p>.</span><span class=na>acquire</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Could not acquire the circularity lock upon installation.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ResettableClassFileTransformer</span><span class=w> </span><span class=n>var13</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AgentBuilder</span><span class=p>.</span><span class=na>RedefinitionStrategy</span><span class=p>.</span><span class=na>ResubmissionStrategy</span><span class=p>.</span><span class=na>Installation</span><span class=w> </span><span class=n>installation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>redefinitionResubmissionStrategy</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>instrumentation</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>poolStrategy</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>locationStrategy</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>descriptionStrategy</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>fallbackStrategy</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>listener</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>installationListener</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>circularityLock</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AgentBuilder</span><span class=p>.</span><span class=na>Default</span><span class=p>.</span><span class=na>Transformation</span><span class=p>.</span><span class=na>SimpleMatcher</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>ignoreMatcher</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>transformations</span><span class=p>),</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>redefinitionStrategy</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>redefinitionBatchAllocator</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>redefinitionListener</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ResettableClassFileTransformer</span><span class=w> </span><span class=n>classFileTransformer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>transformerDecorator</span><span class=p>.</span><span class=na>decorate</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>makeRaw</span><span class=p>(</span><span class=n>installation</span><span class=p>.</span><span class=na>getListener</span><span class=p>(),</span><span class=w> </span><span class=n>installation</span><span class=p>.</span><span class=na>getInstallationListener</span><span class=p>(),</span><span class=w> </span><span class=n>installation</span><span class=p>.</span><span class=na>getResubmissionEnforcer</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>installation</span><span class=p>.</span><span class=na>getInstallationListener</span><span class=p>().</span><span class=na>onBeforeInstall</span><span class=p>(</span><span class=n>instrumentation</span><span class=p>,</span><span class=w> </span><span class=n>classFileTransformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>warmupStrategy</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>classFileTransformer</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>locationStrategy</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>redefinitionStrategy</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>circularityLock</span><span class=p>,</span><span class=w> </span><span class=n>installation</span><span class=p>.</span><span class=na>getInstallationListener</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>handler</span><span class=p>.</span><span class=na>onBeforeRegistration</span><span class=p>(</span><span class=n>instrumentation</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>redefinitionStrategy</span><span class=p>.</span><span class=na>isRetransforming</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>DISPATCHER</span><span class=p>.</span><span class=na>addTransformer</span><span class=p>(</span><span class=n>instrumentation</span><span class=p>,</span><span class=w> </span><span class=n>classFileTransformer</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>instrumentation</span><span class=p>.</span><span class=na>addTransformer</span><span class=p>(</span><span class=n>classFileTransformer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>启动上报相关的服务</p><p>暂未研究</p><h2 id=参考文档>参考文档:</h2><p><a class=link href=https://zhuanlan.zhihu.com/p/563375170 target=_blank rel=noopener>Skywalking8.9.1源码解析&lt;六>-Skywalking-agent版本识别机制</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/>中间件</a>
<a href=/tags/skywalking/>Skywalking</a>
<a href=/tags/%E7%9B%91%E6%8E%A7/>监控</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2025-02-13</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/tech/distributed/skywalking/skywalkingcontroller/><div class=article-details><h2 class=article-title>分析Skywalking的controller加强原理</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/zab/><div class=article-details><h2 class=article-title>Zookeeper源码分析-Zab协议</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/election/><div class=article-details><h2 class=article-title>Zookeeper源码分析-选举机制</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/watch/><div class=article-details><h2 class=article-title>Zookeeper源码分析-watch机制</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/zookeeperservermain/><div class=article-details><h2 class=article-title>Zookeeper源码学习-单机部分通信组件</h2></div></a></article></div></div></aside><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script src=https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js></script><script>const gitalk=new Gitalk({clientID:"Ov23libDgguDHlLK57yi",clientSecret:"bfd2cba55f272f4919357e37e54e4f4697cdd7d0",repo:"qisiii.github.io",owner:"qisiii",admin:["qisiii"],distractionFreeMode:!1,id:md5(location.pathname)});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script><a href=#top aria-label="go to top" class=top-link id=top-link style=display:none><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg>
</a><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>$(window).scroll(function(){$(this).scrollTop()>300?$("#top-link").show():$("#top-link").hide()})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2025 起司</section><section class=powerby><a href=https://beian.miit.gov.cn/ target=_blank>京ICP备2023017017号-1</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>