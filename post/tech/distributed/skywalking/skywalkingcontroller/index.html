<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="在阅读本篇文章之前，建议先了解agent的启动流程，这对分析controller加强原理有很大的帮助，Skywalking Agent启动流程"><title>分析Skywalking的controller加强原理</title>
<link rel=canonical href=https://qisiii.github.io/post/tech/distributed/skywalking/skywalkingcontroller/><link rel=stylesheet href=/scss/style.min.7657e19dfcc00117e827b40bd92bcea286037ffa4a33e95fc533eaea79d078f9.css><meta property='og:title' content="分析Skywalking的controller加强原理"><meta property='og:description' content="在阅读本篇文章之前，建议先了解agent的启动流程，这对分析controller加强原理有很大的帮助，Skywalking Agent启动流程"><meta property='og:url' content='https://qisiii.github.io/post/tech/distributed/skywalking/skywalkingcontroller/'><meta property='og:site_name' content='起司的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='中间件'><meta property='article:tag' content='Skywalking'><meta property='article:tag' content='监控'><meta property='article:published_time' content='2023-09-02T00:00:00+00:00'><meta property='article:modified_time' content='2024-11-25T17:06:07+00:00'><meta name=twitter:title content="分析Skywalking的controller加强原理"><meta name=twitter:description content="在阅读本篇文章之前，建议先了解agent的启动流程，这对分析controller加强原理有很大的帮助，Skywalking Agent启动流程"><link rel=alternate type=application/json href=https://qisiii.github.io/post/tech/distributed/skywalking/skywalkingcontroller/index.json><link rel=alternate type=application/rss+xml href=https://qisiii.github.io/post/tech/distributed/skywalking/skywalkingcontroller/index.xml><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NDCRP4S7S"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NDCRP4S7S")}</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><span id=top></span></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huf89847f5290877d03a6309f0caaa56f1_43584_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>起司的博客</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/qisiii target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页|Home</span></a></li><li><a href=/post/friends target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-heart-handshake"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/><path d="M12 6 8.707 9.293a1 1 0 000 1.414l.543.543c.69.69 1.81.69 2.5.0l1-1a3.182 3.182.0 014.5.0l2.25 2.25"/><path d="M12.5 15.5l2 2"/><path d="M15 13l2 2"/></svg>
<span>友链|Friends</span></a></li><li><a href=/post/search target=_blank><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索|Search</span></a></li><li><a href=/leetcode target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-leetcode"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg>
<span>力扣|Leetcode</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#instmethodsinter>InstMethodsInter</a></li><li><a href=#instancemethodsaroundinterceptor>InstanceMethodsAroundInterceptor</a><ol><li><a href=#interceptor源码分析>Interceptor源码分析</a><ol><li><a href=#tomcatinvokerintercetor>TomcatInvokerIntercetor</a></li><li><a href=#getbeaninterceptor>GetBeanInterceptor</a></li><li><a href=#restmappingmethodinterceptor>RestMappingMethodInterceptor</a></li></ol></li></ol></li><li><a href=#上报>上报</a><ol><li><a href=#收集生产>收集（生产）</a></li><li><a href=#消费>消费</a></li></ol></li><li><a href=#代码>代码</a><ol><li><a href=#controller方法>Controller方法</a></li><li><a href=#反编译firstrequestcontroller>反编译FirstRequestController</a></li><li><a href=#反编译handlermethod>反编译HandlerMethod</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tech/>技术人生</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/tech/distributed/skywalking/skywalkingcontroller/>分析Skywalking的controller加强原理</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2023-09-02</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
<time class=article-time--reading>10分钟</time></div><span id=busuanzi_container_value_page_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_page_pv></span>&nbsp;</span><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><div class=artile-time-reading><a href=https://qisiii.github.io/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6>#中间件</a>
<a href=https://qisiii.github.io/tags/skywalking>#Skywalking</a>
<a href=https://qisiii.github.io/tags/%E7%9B%91%E6%8E%A7>#监控</a></div></footer></div></header><section class=article-content><p>在阅读本篇文章之前，建议先了解agent的启动流程，这对分析controller加强原理有很大的帮助，<a class=link href=https://qisiii.github.io/post/tech/distributed/skywalking/skywalkingagent/>Skywalking Agent启动流程源码分析</a></p><p>项目启动时我指定skywalking<a class=link href=https://www.apache.org/dyn/closer.cgi/skywalking/java-agent/8.16.0/apache-skywalking-java-agent-8.16.0.tgz target=_blank rel=noopener>官方jar包</a></p><p>-javaagent:/xxxx/skywalking/skywalking-agent/skywalking-agent.jar</p><h2 id=instmethodsinter>InstMethodsInter</h2><p>在agent启动原理那篇文章，我们知道Skywalking对于类的加强主要就是对静态方法、构造方法、实例方法各自的加强。虽然我们并没有深入研究AgentBuilder的每个方法，但通过附件的反编译可以了解到，对于要加强的类，</p><p>其本质是new出一个新的类，继承EnhancedInstance，然后创建了一堆的代理对象，以hello方法为例，我们实际调用的是InstMethodsInter类的一个实例对象的intercept方法；</p><p>intercept定义了三个钩子方法，分别是beforeMethod、handleMethodException和afterMethod。所以我们使用的插件一般来说也都是去实现定义的这三个方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>InstanceMethodsAroundInterceptor</span><span class=w> </span><span class=n>interceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>intercept</span><span class=p>(</span><span class=nd>@This</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>,</span><span class=w> </span><span class=nd>@AllArguments</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>allArguments</span><span class=p>,</span><span class=w> </span><span class=nd>@SuperCall</span><span class=w> </span><span class=n>Callable</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>zuper</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Origin</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>EnhancedInstance</span><span class=w> </span><span class=n>targetObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>EnhancedInstance</span><span class=p>)</span><span class=w> </span><span class=n>obj</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MethodInterceptResult</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MethodInterceptResult</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>interceptor</span><span class=p>.</span><span class=na>beforeMethod</span><span class=p>(</span><span class=n>targetObject</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>allArguments</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>(),</span><span class=w> </span><span class=n>result</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=s>&#34;class[{}] before method[{}] intercept failure&#34;</span><span class=p>,</span><span class=w> </span><span class=n>obj</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//这里在beforeMethod中设定了isContinue为true的话，就直接返回result._ret()，等于是代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>isContinue</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>_ret</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>zuper</span><span class=p>.</span><span class=na>call</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>interceptor</span><span class=p>.</span><span class=na>handleMethodException</span><span class=p>(</span><span class=n>targetObject</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>allArguments</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>(),</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>t2</span><span class=p>,</span><span class=w> </span><span class=s>&#34;class[{}] handle method[{}] exception failure&#34;</span><span class=p>,</span><span class=w> </span><span class=n>obj</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>interceptor</span><span class=p>.</span><span class=na>afterMethod</span><span class=p>(</span><span class=n>targetObject</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>allArguments</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getParameterTypes</span><span class=p>(),</span><span class=w> </span><span class=n>ret</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>t</span><span class=p>,</span><span class=w> </span><span class=s>&#34;class[{}] after method[{}] intercept failure&#34;</span><span class=p>,</span><span class=w> </span><span class=n>obj</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=instancemethodsaroundinterceptor>InstanceMethodsAroundInterceptor</h2><p>在InstanceMethodsAroundInterceptor的before和after方法上都打上断点，请求hello接口，其核心链路如下图所示。</p><p><img src=http://picgo-cloudflare.qisiii.asia/post/2024/11/ad12ea03e93fa9effdaed20bda08f9b9.png loading=lazy></p><p>TomcatInvokerInterceptor是在插件tomcat-7.x-8.x-plugin-8.15.0.jar中TomcatInstrumentation类的getMethodsInterceptor指定，对org.apache.catalina.core.StandardHostValve#invoke进行加强</p><p>GetBeanInterceptor是在插件apm-springmvc-annotation-5.x-plugin-8.15.0.jar中的HandlerMethodInstrumentation类getMethodsInterceptor指定，对org.springframework.web.method.HandlerMethod#getBean方法进行加强</p><p>RestMappingMethodInterceptor是在插件apm-springmvc-annotation-5.x-plugin-8.15.0.jar中的ControllerInstrumentation和RestControllerInstrumentation类所继承的AbstractControllerInstrumentation的getMethodsInterceptor指定（这里如果是@RequestMapping注解会走到RequestMappingMethodInterceptor，如果是@GetMapping、@PostMapping等rest的注解，则是会走到RestMappingMethodInterceptor，但其实这两个Interceptor都是继承的AbstractMethodInterceptor）</p><p><strong>GetBeanInterceptor、RestMappingMethodInterceptor都定义在插件apm-springmvc-annotation-commons-8.15.0.jar中</strong></p><h3 id=interceptor源码分析>Interceptor源码分析</h3><h4 id=tomcatinvokerintercetor>TomcatInvokerIntercetor</h4><p>TomcatInvokerIntercetor相对比较独立，像是在容器层面的监听和统计，和mvc流程不掺和；逻辑也比较简单，就是将请求的url、method、head和响应状态封装到span里，上报到oap，这里就不贴源码分析了；</p><h4 id=getbeaninterceptor>GetBeanInterceptor</h4><p>GetBeanInterceptor的作用就是将request和response放到了thredlocal里面，方便RestMappingMethodInterceptor获取和处理</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=c1>//GetBeanInterceptor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>afterMethod</span><span class=p>(</span><span class=n>EnhancedInstance</span><span class=w> </span><span class=n>objInst</span><span class=p>,</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>allArguments</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;[]</span><span class=w> </span><span class=n>argumentsTypes</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>ret</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>EnhancedInstance</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ServletRequestAttributes</span><span class=w> </span><span class=n>requestAttributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ServletRequestAttributes</span><span class=p>)</span><span class=n>RequestContextHolder</span><span class=p>.</span><span class=na>getRequestAttributes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestAttributes</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>getRuntimeContext</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;SW_REQUEST&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestAttributes</span><span class=p>.</span><span class=na>getRequest</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>getRuntimeContext</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;SW_RESPONSE&#34;</span><span class=p>,</span><span class=w> </span><span class=n>requestAttributes</span><span class=p>.</span><span class=na>getResponse</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=restmappingmethodinterceptor>RestMappingMethodInterceptor</h4><p>在分析这段代码之前，建议先看以下<a class=link href=https://skywalking.apache.org/docs/skywalking-java/v8.16.0/en/setup/service-agent/java-agent/java-plugin-development-guide/#tracing-plugin target=_blank rel=noopener>官方文档</a>对于span的介绍，简单总结就是</p><p>Span 表示分布式系统中完成工作的单个单元，即一个组件的一次操作，可以被包含。</p><p>Skywalking 将span做了类型区分</p><p>EntrySpan 用来在服务间交互的时候记录数据</p><p>LocalSpan 用来在本地方法记录数据</p><p>ExitSpan 则表示endpoint的数据</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>beforeMethod</span><span class=p>(</span><span class=n>EnhancedInstance</span><span class=w> </span><span class=n>objInst</span><span class=p>,</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>allArguments</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;[]</span><span class=w> </span><span class=n>argumentsTypes</span><span class=p>,</span><span class=w> </span><span class=n>MethodInterceptResult</span><span class=w> </span><span class=n>result</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//SW_FORWARD_REQUEST_FLAG这个我没找到在哪里塞入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=n>forwardRequestFlag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Boolean</span><span class=p>)</span><span class=n>ContextManager</span><span class=p>.</span><span class=na>getRuntimeContext</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;SW_FORWARD_REQUEST_FLAG&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>forwardRequestFlag</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>forwardRequestFlag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//依托于getBean方法的afterMethod塞到threadlocal的request</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>getRuntimeContext</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;SW_REQUEST&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>request</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//字面意思，用来记录调用方法的深度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>StackDepth</span><span class=w> </span><span class=n>stackDepth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>StackDepth</span><span class=p>)</span><span class=n>ContextManager</span><span class=p>.</span><span class=na>getRuntimeContext</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;SW_CONTROLLER_METHOD_STACK_DEPTH&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//这里是指进入controller之前，已经记录了一层，但我想象不到是哪种场景</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stackDepth</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AbstractSpan</span><span class=w> </span><span class=n>span</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>createLocalSpan</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>buildOperationName</span><span class=p>(</span><span class=n>objInst</span><span class=p>,</span><span class=w> </span><span class=n>method</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>span</span><span class=p>.</span><span class=na>setComponent</span><span class=p>(</span><span class=n>ComponentsDefine</span><span class=p>.</span><span class=na>SPRING_MVC_ANNOTATION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ContextCarrier</span><span class=w> </span><span class=n>contextCarrier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ContextCarrier</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>CarrierItem</span><span class=w> </span><span class=n>next</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>operationName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AbstractSpan</span><span class=w> </span><span class=n>span</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//区分request是HttpServletRequest、还是jakarta包的HttpServletRequest、或者是ServerHttpRequest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IN_SERVLET_CONTAINER</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>IS_JAVAX</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>HttpServletRequest</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>HttpServletRequest</span><span class=w> </span><span class=n>httpServletRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=n>request</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>contextCarrier</span><span class=p>.</span><span class=na>items</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//从请求的header找有没有contextCarrier对象属性的值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>while</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>next</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>next</span><span class=p>.</span><span class=na>setHeadValue</span><span class=p>(</span><span class=n>httpServletRequest</span><span class=p>.</span><span class=na>getHeader</span><span class=p>(</span><span class=n>next</span><span class=p>.</span><span class=na>getHeadKey</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//将请求url和方法提取并组合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>operationName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>buildOperationName</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>httpServletRequest</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(),</span><span class=w> </span><span class=p>(</span><span class=n>EnhanceRequireObjectCache</span><span class=p>)</span><span class=n>objInst</span><span class=p>.</span><span class=na>getSkyWalkingDynamicField</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//创建EntrySpan，这里记录了开始时间，下面是记录URL、方法（Get、POST）、组件类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>span</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>createEntrySpan</span><span class=p>(</span><span class=n>operationName</span><span class=p>,</span><span class=w> </span><span class=n>contextCarrier</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Tags</span><span class=p>.</span><span class=na>URL</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>span</span><span class=p>,</span><span class=w> </span><span class=n>httpServletRequest</span><span class=p>.</span><span class=na>getRequestURL</span><span class=p>().</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>HTTP</span><span class=p>.</span><span class=na>METHOD</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>span</span><span class=p>,</span><span class=w> </span><span class=n>httpServletRequest</span><span class=p>.</span><span class=na>getMethod</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>span</span><span class=p>.</span><span class=na>setComponent</span><span class=p>(</span><span class=n>ComponentsDefine</span><span class=p>.</span><span class=na>SPRING_MVC_ANNOTATION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>SpanLayer</span><span class=p>.</span><span class=na>asHttp</span><span class=p>(</span><span class=n>span</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//默认是false，如果为true，则要记录入参请求</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>SpringMVC</span><span class=p>.</span><span class=na>COLLECT_HTTP_PARAMS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>RequestUtil</span><span class=p>.</span><span class=na>collectHttpParam</span><span class=p>(</span><span class=n>httpServletRequest</span><span class=p>,</span><span class=w> </span><span class=n>span</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//指定要记录的header</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>CollectionUtil</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>Http</span><span class=p>.</span><span class=na>INCLUDE_HTTP_HEADERS</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>RequestUtil</span><span class=p>.</span><span class=na>collectHttpHeaders</span><span class=p>(</span><span class=n>httpServletRequest</span><span class=p>,</span><span class=w> </span><span class=n>span</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IN_SERVLET_CONTAINER</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>IS_JAKARTA</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>jakarta</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>http</span><span class=p>.</span><span class=na>HttpServletRequest</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>jakarta</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>http</span><span class=p>.</span><span class=na>HttpServletRequest</span><span class=w> </span><span class=n>httpServletRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>jakarta</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>http</span><span class=p>.</span><span class=na>HttpServletRequest</span><span class=p>)</span><span class=n>request</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//和上面一样</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ServerHttpRequest</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;this line should not be reached&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ServerHttpRequest</span><span class=w> </span><span class=n>serverHttpRequest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ServerHttpRequest</span><span class=p>)</span><span class=n>request</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//和上面一样</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//初始化一个StackDepth，值为1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stackDepth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StackDepth</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>getRuntimeContext</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;SW_CONTROLLER_METHOD_STACK_DEPTH&#34;</span><span class=p>,</span><span class=w> </span><span class=n>stackDepth</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//每过一个before+1，每过一个after-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>stackDepth</span><span class=p>.</span><span class=na>increment</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>afterMethod</span><span class=p>(</span><span class=n>EnhancedInstance</span><span class=w> </span><span class=n>objInst</span><span class=p>,</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>allArguments</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;[]</span><span class=w> </span><span class=n>argumentsTypes</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>ret</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Throwable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RuntimeContext</span><span class=w> </span><span class=n>runtimeContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>getRuntimeContext</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Boolean</span><span class=w> </span><span class=n>forwardRequestFlag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Boolean</span><span class=p>)</span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;SW_FORWARD_REQUEST_FLAG&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>forwardRequestFlag</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>forwardRequestFlag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Object</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;SW_REQUEST&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>request</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//获取层深并减一</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>StackDepth</span><span class=w> </span><span class=n>stackDepth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>StackDepth</span><span class=p>)</span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;SW_CONTROLLER_METHOD_STACK_DEPTH&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stackDepth</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalMethodStackDepthException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>stackDepth</span><span class=p>.</span><span class=na>decrement</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>AbstractSpan</span><span class=w> </span><span class=n>span</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>activeSpan</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stackDepth</span><span class=p>.</span><span class=na>depth</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Object</span><span class=w> </span><span class=n>response</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;SW_RESPONSE&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>response</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServletResponseNotFoundException</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Integer</span><span class=w> </span><span class=n>statusCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//记录请求response的code</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_SERVLET_GET_STATUS_METHOD_EXIST</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>HttpServletResponse</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>statusCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>HttpServletResponse</span><span class=p>)</span><span class=n>response</span><span class=p>).</span><span class=na>getStatus</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_JAKARTA_SERVLET_GET_STATUS_METHOD_EXIST</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>jakarta</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>http</span><span class=p>.</span><span class=na>HttpServletResponse</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>statusCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>jakarta</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>http</span><span class=p>.</span><span class=na>HttpServletResponse</span><span class=p>)</span><span class=n>response</span><span class=p>).</span><span class=na>getStatus</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ServerHttpResponse</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>response</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_SERVLET_GET_STATUS_METHOD_EXIST</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>IS_JAKARTA_SERVLET_GET_STATUS_METHOD_EXIST</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>statusCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>ServerHttpResponse</span><span class=p>)</span><span class=n>response</span><span class=p>).</span><span class=na>getRawStatusCode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Object</span><span class=w> </span><span class=n>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=s>&#34;SW_REACTIVE_RESPONSE_ASYNC_SPAN&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>context</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//响应是异步得专门看一下</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>((</span><span class=n>AbstractSpan</span><span class=o>[]</span><span class=p>)</span><span class=n>context</span><span class=p>)</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>span</span><span class=p>.</span><span class=na>prepareForAsync</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>statusCode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Tags</span><span class=p>.</span><span class=na>HTTP_RESPONSE_STATUS_CODE</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>span</span><span class=p>,</span><span class=w> </span><span class=n>statusCode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>statusCode</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>400</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>span</span><span class=p>.</span><span class=na>errorOccurred</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=s>&#34;SW_REACTIVE_RESPONSE_ASYNC_SPAN&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=s>&#34;SW_REQUEST&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=s>&#34;SW_RESPONSE&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>runtimeContext</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=s>&#34;SW_CONTROLLER_METHOD_STACK_DEPTH&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//假如COLLECT_HTTP_PARAMS默认是false，那这里就会由ProfileStatus决定，而ProfileStatus由org.apache.skywalking.apm.agent.core.profile.ThreadProfiler#startProfilingIfNeed决定</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>SpringMVC</span><span class=p>.</span><span class=na>COLLECT_HTTP_PARAMS</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>span</span><span class=p>.</span><span class=na>isProfiling</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_JAVAX</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>HttpServletRequest</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>RequestUtil</span><span class=p>.</span><span class=na>collectHttpParam</span><span class=p>((</span><span class=n>HttpServletRequest</span><span class=p>)</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>span</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_JAKARTA</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>jakarta</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>http</span><span class=p>.</span><span class=na>HttpServletRequest</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>RequestUtil</span><span class=p>.</span><span class=na>collectHttpParam</span><span class=p>((</span><span class=n>jakarta</span><span class=p>.</span><span class=na>servlet</span><span class=p>.</span><span class=na>http</span><span class=p>.</span><span class=na>HttpServletRequest</span><span class=p>)</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>span</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ServerHttpRequest</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>RequestUtil</span><span class=p>.</span><span class=na>collectHttpParam</span><span class=p>((</span><span class=n>ServerHttpRequest</span><span class=p>)</span><span class=n>request</span><span class=p>,</span><span class=w> </span><span class=n>span</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//在这里进行的上报</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ContextManager</span><span class=p>.</span><span class=na>stopSpan</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=上报>上报</h2><p>到这里为止，可以发现其实就跟拦截器的思路是一样的，在执行前后做了一些记录操作。那么记录完之后，是如何上报到oap的呢?原理就在ContextManager.stopSpan()中</p><h3 id=收集生产>收集（生产）</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>stopSpan</span><span class=p>(</span><span class=n>AbstractSpan</span><span class=w> </span><span class=n>span</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>AbstractSpan</span><span class=w> </span><span class=n>lastSpan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>peek</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastSpan</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>span</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastSpan</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>AbstractTracingSpan</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>AbstractTracingSpan</span><span class=w> </span><span class=n>toFinishSpan</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AbstractTracingSpan</span><span class=p>)</span><span class=n>lastSpan</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//这个finish是AbstractTracingSpan的finish，</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>toFinishSpan</span><span class=p>.</span><span class=na>finish</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>segment</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>this</span><span class=p>.</span><span class=na>pop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>pop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//这个finish是TraceContent的finish</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>finish</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>activeSpanStack</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;Stopping the unexpected span = &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>span</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>org.apache.skywalking.apm.agent.core.context.ContextManager#stopSpan()-></p><p>org.apache.skywalking.apm.agent.core.context.trace.AbstractTracingSpan#finish，</p><p>从 stopSpan跟进去，会先走到AbstractTracingSpan#finish这个方法，在这里将本次请求的span放到了TraceSegment.spans集合中，等待被收集和消费</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>finish</span><span class=p>(</span><span class=n>TraceSegment</span><span class=w> </span><span class=n>owner</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>endTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>owner</span><span class=p>.</span><span class=na>archive</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>archive</span><span class=p>(</span><span class=n>AbstractTracingSpan</span><span class=w> </span><span class=n>finishedSpan</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>spans</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>finishedSpan</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后会走到TraceContent的finish，org.apache.skywalking.apm.agent.core.context.TracingContext.ListenerManager#notifyFinish->&mldr;-></p><p>#org.apache.skywalking.apm.commons.datacarrier.DataCarrier#produce</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>finish</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//下面是调用了两次notifyFinish，但是通知的内容不一样，这里我们主要关注第二个，因为通知的是TraceSegment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>isFinishedInMainThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>activeSpanStack</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>running</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isFinishedInMainThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TracingContext</span><span class=p>.</span><span class=na>TracingThreadListenerManager</span><span class=p>.</span><span class=na>notifyFinish</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isFinishedInMainThread</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>isRunningInAsyncMode</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>asyncSpanCounter</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TraceSegment</span><span class=w> </span><span class=n>finishedSegment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>segment</span><span class=p>.</span><span class=na>finish</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>isLimitMechanismWorking</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>TracingContext</span><span class=p>.</span><span class=na>ListenerManager</span><span class=p>.</span><span class=na>notifyFinish</span><span class=p>(</span><span class=n>finishedSegment</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>running</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//一层层跟下去</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>notifyFinish</span><span class=p>(</span><span class=n>TraceSegment</span><span class=w> </span><span class=n>finishedSegment</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Iterator</span><span class=w> </span><span class=n>var1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LISTENERS</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>var1</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>TracingContextListener</span><span class=w> </span><span class=n>listener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TracingContextListener</span><span class=p>)</span><span class=n>var1</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>listener</span><span class=p>.</span><span class=na>afterFinished</span><span class=p>(</span><span class=n>finishedSegment</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>afterFinished</span><span class=p>(</span><span class=n>TraceSegment</span><span class=w> </span><span class=n>traceSegment</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>traceSegment</span><span class=p>.</span><span class=na>isIgnore</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>carrier</span><span class=p>.</span><span class=na>produce</span><span class=p>(</span><span class=n>traceSegment</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>isDebugEnable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>LOGGER</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;One trace segment has been abandoned, cause by buffer is full.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>skywalking</span><span class=p>.</span><span class=na>apm</span><span class=p>.</span><span class=na>commons</span><span class=p>.</span><span class=na>datacarrier</span><span class=p>.</span><span class=na>DataCarrier</span><span class=err>#</span><span class=n>produce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>produce</span><span class=p>(</span><span class=n>T</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>driver</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>driver</span><span class=p>.</span><span class=na>isRunning</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>channels</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>channels</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>save</span><span class=p>(</span><span class=n>data</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>条件</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>bufferChannels</span><span class=o>[</span><span class=n>index</span><span class=o>]</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=n>data</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>）</span><span class=w>
</span></span></span></code></pre></div><p>直到这里为止，我们可以发现数据被存到了DataCarrier.channels中，而且从执行的方法是produce可以猜到，对应的consume方法就是消费逻辑。</p><h3 id=消费>消费</h3><p>还是在DataCarrier中，通过下面的代码可以发现，实际一个ConsumeDriver有多个线程，每个线程对应一个channel，是以属性dataSource绑定到ConsumerThread上</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>DataCarrier</span><span class=w> </span><span class=nf>consume</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>IConsumer</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>consumerClass</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>consumeCycle</span><span class=p>,</span><span class=w> </span><span class=n>Properties</span><span class=w> </span><span class=n>properties</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>driver</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>driver</span><span class=p>.</span><span class=na>close</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>channels</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//将channels放入ConsumeDriver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>driver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConsumeDriver</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>channels</span><span class=p>,</span><span class=w> </span><span class=n>consumerClass</span><span class=p>,</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=n>consumeCycle</span><span class=p>,</span><span class=w> </span><span class=n>properties</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>driver</span><span class=p>.</span><span class=na>begin</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>channels</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>begin</span><span class=p>(</span><span class=n>Channels</span><span class=w> </span><span class=n>channels</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//将chennel和ConsumerThread做绑定</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>allocateBuffer2Thread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ConsumerThread</span><span class=o>[]</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>consumerThreads</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>var3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var2</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>var4</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>var3</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>var4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ConsumerThread</span><span class=w> </span><span class=n>consumerThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>var2</span><span class=o>[</span><span class=n>var4</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>consumerThread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>allocateBuffer2Thread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>channelSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>channels</span><span class=p>.</span><span class=na>getChannelSize</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>channelIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>channelIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>channelSize</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>channelIndex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>consumerIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channelIndex</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>consumerThreads</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//将channel放到ConsumerThread的dataSource中，因为后面每个线程的主要工作就是从datasource获取要要发送的数据，然后发送</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>consumerThreads</span><span class=o>[</span><span class=n>consumerIndex</span><span class=o>]</span><span class=p>.</span><span class=na>addDataSource</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>channels</span><span class=p>.</span><span class=na>getBuffer</span><span class=p>(</span><span class=n>channelIndex</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>所以ConsumerThread持有datasource，然后datasource又有了数据,线程在死循环获取datasource中数据就可以了</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=err>#</span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>skywalking</span><span class=p>.</span><span class=na>apm</span><span class=p>.</span><span class=na>commons</span><span class=p>.</span><span class=na>datacarrier</span><span class=p>.</span><span class=na>consumer</span><span class=p>.</span><span class=na>ConsumerThread</span><span class=err>#</span><span class=n>consume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>consume</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>consumeList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Iterator</span><span class=w> </span><span class=n>var2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>dataSources</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=p>(</span><span class=n>var2</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ConsumerThread</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>.</span><span class=na>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ConsumerThread</span><span class=p>.</span><span class=na>DataSource</span><span class=p>)</span><span class=n>var2</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//将datasource数据放入consumeList</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dataSource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>consumeList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>consumer</span><span class=p>.</span><span class=na>consume</span><span class=p>(</span><span class=n>consumeList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>#</span><span class=n>org</span><span class=p>.</span><span class=na>apache</span><span class=p>.</span><span class=na>skywalking</span><span class=p>.</span><span class=na>apm</span><span class=p>.</span><span class=na>agent</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>remote</span><span class=p>.</span><span class=na>TraceSegmentServiceClient</span><span class=err>#</span><span class=n>consume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>consume</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>TraceSegment</span><span class=o>&gt;</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>GRPCChannelStatus</span><span class=p>.</span><span class=na>CONNECTED</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>status</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>GRPCStreamServiceStatus</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GRPCStreamServiceStatus</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StreamObserver</span><span class=w> </span><span class=n>upstreamSegmentStreamObserver</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>TraceSegmentReportServiceStub</span><span class=p>)</span><span class=k>this</span><span class=p>.</span><span class=na>serviceStub</span><span class=p>.</span><span class=na>withDeadlineAfter</span><span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>Collector</span><span class=p>.</span><span class=na>GRPC_UPSTREAM_TIMEOUT</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>)).</span><span class=na>collect</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>StreamObserver</span><span class=o>&lt;</span><span class=n>Commands</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//这里的onNext是response的onNext，不是request，可以看一下collect的逻辑，所以下面直接调onNext并不是调到这个方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onNext</span><span class=p>(</span><span class=n>Commands</span><span class=w> </span><span class=n>commands</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>((</span><span class=n>CommandService</span><span class=p>)</span><span class=n>ServiceManager</span><span class=p>.</span><span class=na>INSTANCE</span><span class=p>.</span><span class=na>findService</span><span class=p>(</span><span class=n>CommandService</span><span class=p>.</span><span class=na>class</span><span class=p>)).</span><span class=na>receiveCommand</span><span class=p>(</span><span class=n>commands</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>var4</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>TraceSegment</span><span class=w> </span><span class=n>segment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>TraceSegment</span><span class=p>)</span><span class=n>var4</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//构建传输对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SegmentObject</span><span class=w> </span><span class=n>upstreamSegment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>segment</span><span class=p>.</span><span class=na>transform</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//进行传输</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>upstreamSegmentStreamObserver</span><span class=p>.</span><span class=na>onNext</span><span class=p>(</span><span class=n>upstreamSegment</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//走发送逻辑，由于GRPC我还没有研究过，所以暂不分析往下的源码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onNext</span><span class=p>(</span><span class=n>ReqT</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkState</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>aborted</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Stream was terminated by error, no further calls are allowed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkState</span><span class=p>(</span><span class=o>!</span><span class=k>this</span><span class=p>.</span><span class=na>completed</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Stream is already completed, no further calls are allowed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>call</span><span class=p>.</span><span class=na>sendMessage</span><span class=p>(</span><span class=n>value</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=代码>代码</h2><h3 id=controller方法>Controller方法</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/first&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FirstRequestController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/hello&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>hello</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;hello,mybatis&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>testAgent</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>noAgent</span><span class=p>());;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;mybatis&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>testAgent</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;testAgent&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>noAgent</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&#34;noAgent&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=反编译firstrequestcontroller>反编译FirstRequestController</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=w>       </span><span class=nd>@RestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=n>value</span><span class=o>=</span><span class=p>{</span><span class=s>&#34;/first&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>FirstRequestController</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=kd>implements</span><span class=w> </span><span class=n>EnhancedInstance</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>_$EnhancedClassField_ws</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$fmp8mm0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$usgtuf1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>ConstructorInter</span><span class=w> </span><span class=n>delegate$ve3rcd0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$9q0b6r1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$mft2580</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>ConstructorInter</span><span class=w> </span><span class=n>delegate$gcp4qa1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$4vl1o10</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$vcjgr61</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>ConstructorInter</span><span class=w> </span><span class=n>delegate$di6p0h0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$jfo0r51</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$dg0j500</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>ConstructorInter</span><span class=w> </span><span class=n>delegate$5c04f20</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>cachedValue$aWq206nq$b4bilp1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$306a1i0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$3h5imi1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>ConstructorInter</span><span class=w> </span><span class=n>delegate$25tu2j0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$su4hhm0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$e5jt5f1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>ConstructorInter</span><span class=w> </span><span class=n>delegate$kc72041</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$pf9hmj0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$kik32a0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>ConstructorInter</span><span class=w> </span><span class=n>delegate$os3qlu1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$0e263f0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>InstMethodsInter</span><span class=w> </span><span class=n>delegate$a5ji980</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>ConstructorInter</span><span class=w> </span><span class=n>delegate$jc027h1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>cachedValue$niIMIXK0$b4bilp1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=nf>FirstRequestController</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>this</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>delegate$25tu2j0</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>private</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>FirstRequestController</span><span class=p>(</span><span class=n>auxiliary</span><span class=p>.</span><span class=na>MVLCe3Gn</span><span class=w> </span><span class=n>mVLCe3Gn</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=n>value</span><span class=o>=</span><span class=p>{</span><span class=s>&#34;/hello&#34;</span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>hello</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=p>)</span><span class=n>delegate$306a1i0</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Callable</span><span class=o>&lt;?&gt;</span><span class=p>)</span><span class=k>new</span><span class=w> </span><span class=n>auxiliary</span><span class=p>.</span><span class=na>4sHLGVLS</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>cachedValue$niIMIXK0$b4bilp1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>private</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>hello$original$UjAdUjOr</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*17*/</span><span class=w>         </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;hello,mybatis&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*18*/</span><span class=w>         </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>testAgent</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*19*/</span><span class=w>         </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>noAgent</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*20*/</span><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=s>&#34;mybatis&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>testAgent</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*23*/</span><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=s>&#34;testAgent&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>noAgent</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/*26*/</span><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=s>&#34;noAgent&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>ClassLoader</span><span class=p>.</span><span class=na>getSystemClassLoader</span><span class=p>().</span><span class=na>loadClass</span><span class=p>(</span><span class=s>&#34;org.apache.skywalking.apm.dependencies.net.bytebuddy.dynamic.Nexus&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;initialize&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>TYPE</span><span class=p>).</span><span class=na>invoke</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>FirstRequestController</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>1021095365</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>cachedValue$niIMIXK0$b4bilp1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FirstRequestController</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=kd>final</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>hello$original$UjAdUjOr$accessor$niIMIXK0</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>hello$original$UjAdUjOr</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=反编译handlermethod>反编译HandlerMethod</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HandlerMethod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>implements</span><span class=w> </span><span class=n>EnhancedInstance</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=cm>/* synthetic */</span><span class=w> </span><span class=n>Method</span><span class=w> </span><span class=n>cachedValue$1RDdupwP$41avq00</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getBean</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>delegate$shr7st0</span><span class=p>.</span><span class=na>intercept</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>Callable</span><span class=o>&lt;?&gt;</span><span class=p>)</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>auxiliary</span><span class=p>.</span><span class=na>ENGom7ym</span><span class=p>(</span><span class=k>this</span><span class=p>),</span><span class=w> </span><span class=n>cachedValue$1RDdupwP$41avq00</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>     * Enabled aggressive block sorting
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ClassLoader</span><span class=p>.</span><span class=na>getSystemClassLoader</span><span class=p>().</span><span class=na>loadClass</span><span class=p>(</span><span class=s>&#34;org.apache.skywalking.apm.dependencies.net.bytebuddy.dynamic.Nexus&#34;</span><span class=p>).</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;initialize&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>TYPE</span><span class=p>).</span><span class=na>invoke</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1058650667</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>cachedValue$1RDdupwP$41avq00</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HandlerMethod</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;getBean&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=cm>/* 66*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>logger</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogFactory</span><span class=p>.</span><span class=na>getLog</span><span class=p>(</span><span class=n>HandlerMethod</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></section><footer class=article-footer><section class=article-tags><a href=/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/>中间件</a>
<a href=/tags/skywalking/>Skywalking</a>
<a href=/tags/%E7%9B%91%E6%8E%A7/>监控</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2024-11-25</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/tech/distributed/skywalking/skywalkingagent/><div class=article-details><h2 class=article-title>SkywalkingAgent启动流程源码分析</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/zab/><div class=article-details><h2 class=article-title>Zookeeper源码分析-Zab协议</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/election/><div class=article-details><h2 class=article-title>Zookeeper源码分析-选举机制</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/watch/><div class=article-details><h2 class=article-title>Zookeeper源码分析-watch机制</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/zookeeperservermain/><div class=article-details><h2 class=article-title>Zookeeper源码学习-单机部分通信组件</h2></div></a></article></div></div></aside><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script src=https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js></script><script>const gitalk=new Gitalk({clientID:"Ov23libDgguDHlLK57yi",clientSecret:"bfd2cba55f272f4919357e37e54e4f4697cdd7d0",repo:"qisiii.github.io",owner:"qisiii",admin:["qisiii"],distractionFreeMode:!1,id:md5(location.pathname)});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script><a href=#top aria-label="go to top" class=top-link id=top-link style=display:none><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg>
</a><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>$(window).scroll(function(){$(this).scrollTop()>300?$("#top-link").show():$("#top-link").hide()})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 起司</section><section class=powerby><a href=https://beian.miit.gov.cn/ target=_blank>京ICP备2023017017号-1</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_site_pv></span>次
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user" aria-hidden=true></i>
<span id=busuanzi_value_site_uv></span>人次</span></section></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>