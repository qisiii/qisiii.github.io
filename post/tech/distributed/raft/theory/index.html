<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="本文是先简单记录一下Raft最基本的内容，即论文的第5章的部分，至于后面的日志压缩、集群成员变化、客户端交互则由另一篇文章记录"><title>Raft算法理论学习(一)</title>
<link rel=canonical href=https://qisiii.github.io/post/tech/distributed/raft/theory/><link rel=stylesheet href=/scss/style.min.7657e19dfcc00117e827b40bd92bcea286037ffa4a33e95fc533eaea79d078f9.css><meta property='og:title' content="Raft算法理论学习(一)"><meta property='og:description' content="本文是先简单记录一下Raft最基本的内容，即论文的第5章的部分，至于后面的日志压缩、集群成员变化、客户端交互则由另一篇文章记录"><meta property='og:url' content='https://qisiii.github.io/post/tech/distributed/raft/theory/'><meta property='og:site_name' content='起司的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='raft'><meta property='article:published_time' content='2024-09-30T10:54:07+08:00'><meta property='article:modified_time' content='2024-10-11T02:20:40+00:00'><meta property='og:image' content='http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/fd9fe615c172b89d11eb050986e1a1d4.jpg'><meta name=twitter:title content="Raft算法理论学习(一)"><meta name=twitter:description content="本文是先简单记录一下Raft最基本的内容，即论文的第5章的部分，至于后面的日志压缩、集群成员变化、客户端交互则由另一篇文章记录"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/fd9fe615c172b89d11eb050986e1a1d4.jpg'><link rel=alternate type=application/json href=https://qisiii.github.io/post/tech/distributed/raft/theory/index.json><link rel=alternate type=application/rss+xml href=https://qisiii.github.io/post/tech/distributed/raft/theory/index.xml><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NDCRP4S7S"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NDCRP4S7S")}</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><span id=top></span></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huf89847f5290877d03a6309f0caaa56f1_43584_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>起司的博客</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/qisiii target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页|Home</span></a></li><li><a href=/post/friends target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-heart-handshake"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/><path d="M12 6 8.707 9.293a1 1 0 000 1.414l.543.543c.69.69 1.81.69 2.5.0l1-1a3.182 3.182.0 014.5.0l2.25 2.25"/><path d="M12.5 15.5l2 2"/><path d="M15 13l2 2"/></svg>
<span>友链|Friends</span></a></li><li><a href=/post/search target=_blank><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索|Search</span></a></li><li><a href=/leetcode target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-leetcode"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg>
<span>力扣|Leetcode</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#学习途径>学习途径</a><ol><li><a href=#实践版动画>实践版动画</a><ol><li><a href=#状态>状态</a></li></ol></li><li><a href=#操作>操作</a></li><li><a href=#rpc>RPC</a></li></ol></li><li><a href=#基本理论>基本理论</a><ol><li><a href=#选举>选举</a><ol><li><a href=#何时选举>何时选举</a></li><li><a href=#如何投票>如何投票</a></li><li><a href=#如何竞选成功>如何竞选成功</a></li></ol></li></ol></li><li><a href=#日志复制>日志复制</a><ol><li><a href=#follower启动时和leader的日志不同如何处理>Follower启动时和Leader的日志不同如何处理？</a></li><li><a href=#假如follower进度没有跟上收到的消息还会按2pc处理还是说直接就可以commit>假如Follower进度没有跟上，收到的消息还会按2pc处理还是说直接就可以Commit？</a></li><li><a href=#新leader是否会提交旧leader未提交的内容>新Leader是否会提交旧Leader未提交的内容?</a></li></ol></li><li><a href=#参考>参考：</a></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/post/tech/distributed/raft/theory/><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/fd9fe615c172b89d11eb050986e1a1d4.jpg loading=lazy alt="Featured image of post Raft算法理论学习(一)"></a></div><div class=article-details><header class=article-category><a href=/categories/tech/>技术人生</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/tech/distributed/raft/theory/>Raft算法理论学习(一)</a></h2><h3 class=article-subtitle>本文是先简单记录一下Raft最基本的内容，即论文的第5章的部分，至于后面的日志压缩、集群成员变化、客户端交互则由另一篇文章记录</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-09-30</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
<time class=article-time--reading>9分钟</time></div><span id=busuanzi_container_value_page_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_page_pv></span>&nbsp;</span><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><div class=artile-time-reading><a href=https://qisiii.github.io/tags/raft>#raft</a></div></footer></div></header><section class=article-content><p>随着接触各种开源的中间件或者数据库，总是会了解到他们必须保证多节点的一致性。比如Zookeeper使用了Zab来保证CP；Nacos既支持AP也支持CP，CP使用的是Zookeeper，AP则是raft；Rocketmq在主备切换的时候是Dledger（基于Raft），在最新的5.3版本我还看到可以选择使用JRaft或者Dledger；Kafka则准备抛弃Zokeeper，改用KRaft。</p><p>这些技术中绕不过去Raft，因此为了理解的更透彻，也为了更好的了解Zab和Raft的区别，我打算分为两部分，本文是先简单记录一下Raft最基本的内容，即论文的第5章的部分，至于后面的日志压缩、集群成员变化、客户端交互则由另一篇文章记录。</p><h2 id=学习途径>学习途径</h2><p>不同于Zab官网没有介绍，<a class=link href=https://raft.github.io/ target=_blank rel=noopener>Raft官网</a>提供了两个非常友好的动画来辅助学习。</p><p><a class=link href=https://thesecretlivesofdata.com/raft/ target=_blank rel=noopener>入门版</a>（<a class=link href=https://acehi.github.io/thesecretlivesofdata-cn/raft/ target=_blank rel=noopener>也可以用中文版</a>）是让人在没有任何基础的情况下大致了解分布式共识的意义以及Raft的方案是什么。</p><p><a class=link href=https://raft.github.io/raftscope/index.html target=_blank rel=noopener>Raft Scope</a>则是一个可以让你模拟各种情况的可视化动画，包括选举和日志复制，甚至异常情况。通过这个动画你可以看到算法运行过程，以及最终的结果，可以去印证你的理解思路是否存在问题。</p><p>除了动画，官网的Talk区还有很多的介绍视频可以让你更快入门，虽然这里大部分都是YouTube上的，但是你在国内自己搜一下也不是没有。</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/6beaa26954c07952561cf11188b82b36.jpg loading=lazy></p><p>不过，有能力最好还是通过读<a class=link href=https://raft.github.io/raft.pdf target=_blank rel=noopener>原论文</a>的方式，从根源上去了解去确认其为何要这么设计。毕竟你无法去确认视频里的内容是否有错误，现在这个人云亦云的时代，千篇一律的博客，当你的认知和他人的内容出现差别的时候，最好还是去读一读<a class=link href=https://raft.github.io/raft.pdf target=_blank rel=noopener>最官方的原始资料</a>。</p><h3 id=实践版动画>实践版动画</h3><p>虽然实践版动画很好很强大，但是他没有说明书，不清楚动画里各个组件的内容你可能很难尽快上手。所以本节做一个简单的介绍。</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/b2326661fc04d358f9f498c8fdadbd42.jpg loading=lazy></p><p>左上角是代表集群有5个节点，分别是S1-S5；</p><p>右上角是日志，表示每个节点在给自己的日志文件中的内容是什么情况。</p><p>两个进度条第一个是时间进度条，左边的按钮代表暂停/继续，可以拖动进度条回滚到之前的时间重新开始。</p><p>第二个进度条是速率，越往左越慢，越往右越快，我个人一般使用1/70x会多一些。</p><h4 id=状态>状态</h4><p>节点有三个状态：Leader、Follower、Candidate</p><p>Leader状态下，外圈是黑色整圈，内部是周期数，不会随着时间缩圈</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/76892cee124e1b26e79de180646bb783.jpg loading=lazy></p><p>Follower状态下，外圈是一个灰色圈，内部是周期数，但会随着时间缩圈</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/4e4666298feb5b8c881616f1ac480c4c.jpg loading=lazy></p><p>Candidate状态下，外圈也是黑色圈，但是随着时间会缩圈，其内部是类似于左轮弹夹一样，&ldquo;子弹数"代表收到同意的票数</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/3dd59c31671de635cb4c0548d1bd6b58.jpg loading=lazy></p><h3 id=操作>操作</h3><p>节点是可以单击或者右击的，单击显示该节点完整的状态</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/2b29560108ed1453aed5e2abaa40bb5d.jpg loading=lazy></p><p>表格中vote granted列是指在上次选举时，每个节点收到的其他节点的投票信息；</p><p>两个Index列是只有当选Leader后，Leader所记录的每个节点的进度；nextIndex是只下一个可以写的索引位置，CommitIndex是指已经经过大多数节点认同的信息，对应到日志表格中，有着黑色边框的就是已经Commit的信息，虚线框的就是还未Commit的信息；箭头指向的就是nextIndex，圆点是matchIndex</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/5e2dc26900c062e11709648faeb8b12e.jpg loading=lazy></p><p>详情看板上的按钮右击时也会出现</p><p>Stop是指当前节点下线</p><p>resume则是指当前节点重新上线，即重新变为Follower，但周期不变</p><p>restart 感觉和resume没有区别，只是从语义上说resume是恢复，restart是重启？</p><p>timeout会将当前节点立即变为候选人，即进入Candidate状态且周期+1</p><p>request仅有Leader可以操作，是指追加一条日志</p><h3 id=rpc>RPC</h3><p>RPC分为Request和Reply，并且可以通过单击或者右击丢弃掉这条信息</p><p>Request的样式在暂停状态下有箭头，正常播放情况下只有一个圆圈</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/c0657a622b7fab426e4f9d4bd1b6c261.jpg loading=lazy></p><p>Reply则有两种结果，同意的话圆圈内部是+号，拒绝是-号</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/01e2d5083c2580e4c23ce0e4ff87f1f4.jpg loading=lazy></p><p>公共信息是：</p><p>from（发送方）TO（接收方） sent（何时发送，一般是负数表示n毫秒前发送）deliver（何时到达，一般是正数，表示n毫秒后到达）</p><p>Rpc有两种业务：一种是投票（Vote），一种是追加日志（AppendEntries），具体字段的内容得了解Raft流程后才能理解，但其实都是字面意思。</p><h2 id=基本理论>基本理论</h2><p>Raft主要由两部分组成：选举和日志复制。</p><h3 id=选举>选举</h3><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/ffef51adc51af216dd8ff2e16ebac9d3.jpg loading=lazy></p><p>Raft算法认为分布式场景中多个节点中应该选出一个Leader节点，由此节点来负责和集群外的Client进行信息交换，每个Leader有自己的任期称之为Term，其他的节点只需要从Leader节点中不断地复制信息即可。</p><p>节点存在三个状态：Leader、Follower、Candidate。</p><p>Leader是指已经成为领导者，可以给其他节点发送日志信息</p><p>Follower是指具有投票权，在未超时的状态下会对其他节点的请求做出回复，在超时的状态会变为Candidate</p><p>Candidate是候选人状态，由Follower转变，当Follower超时，会自己投自己一票变为该状态，当前Term会+1，同时会给其他节点发送投票请求</p><h4 id=何时选举>何时选举</h4><p>节点首次启动时Follower状态，Raft中每个节点设计了一个随机超时时间，当超时后会进入选举，即进入到Candidate状态；但如果在超时时间内接收到其他候选节点的投票信息或者Leader的rpc信息就会重置超时时间。</p><p>或者当Leader下线，所有的节点都是Follower，会再次进入选举流程</p><h4 id=如何投票>如何投票</h4><p>每个节点每个周期仅可以投一票，即接受了S1的投票就无法接受S2的投票；同意投票的条件是<strong>周期（term）较大&日志（lastLogIndex）最长</strong></p><p>其中要求日志最长是为了保障安全，比如S1节点有20条日志，S2只有0条日志，假如S2Term大因此竞选成功，那么会要求其他节点都和自己保持一致，会丢失过多信息。因此Raft要求Leader必须拥有最多的日志。</p><h4 id=如何竞选成功>如何竞选成功</h4><p>当Candidate节点收到整个集群内一半以上的票(n/2+1)表示竞选成功，包含自己投自己的一票；当竞选成功后会像其他节点发送Rpc消息，消息内可能有日志信息，也可能没有，没有的话就是普通的心跳机制。</p><p>存在多个候选人收到相同票数或者不满足(n/2+1)等无法决出Leader的情况，会进入下一轮选举重新尝试。基于随机超时的设计机制，并不会重复太多次。</p><p>比如下图S1是2票，S3和S5都是1票，无法选出Leader，会在S1超时后，以Term为9再次尝试</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/8789a0c538e2d43df187236734a1ca5a.jpg loading=lazy></p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/2c0bd91c7db66bd64b6a5218702b387b.jpg loading=lazy></p><h2 id=日志复制>日志复制</h2><p>日志复制本身是复制状态机的一种实现，其理论为对于多个拥有相同初始状态的状态机，在按照相同的顺序执行一系列输入之后，得到的一系列输出也是相同的。体现在Raft中，就是指多个Follower从Leader去同步复制并进行提交，以达到最终一致性。注意：Raft中数据只允许单向流动，即Leader—>Follower</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/7388eae3092873fb7efd81bb759229e3.jpg loading=lazy></p><p>来自客户端的写请求在日志中体现为一个entry，entry分为未提交和已提交两种，以2PC的模式去运行。</p><p>正常的流程如下：</p><p>Leader收到来自客户端的全新请求后，会先创建一个新的entry存储在自己的日志中，同时发送AppendEnties的RPC请求给其他Follower节点。</p><p>Follower节点收到之后会在指定位置追加该Entry，会回复给Leader成功或者失败以及命中的索引值。</p><p>Leader收到大多数节点的成功后再本地提交该entry到状态机，然后发送提交的消息给那些响应为成功的节点。假如响应的是失败，Leader会重新发送该消息。</p><p>Follower收到消息后，如果其CommitIndex大于自身的CommitIndex，就会将这些entry提交，并返回自己最新的CommitIndex给Leader</p><h3 id=follower启动时和leader的日志不同如何处理>Follower启动时和Leader的日志不同如何处理？</h3><p>当Leader当选之后，会先进行一致性检查。</p><p>首先Leader初始化所有节点的nextIndex值跟自己一样（只是修改Leader节点中的nextIndex数组），然后发送请求（携带prevLogIndex和prevLogTerm）给Follower。</p><p>Follwer应该有三种情况：</p><ul><li><p>进度比Leader慢，即prevLogIndex内容为空</p><p>Follower会返回false，Leader收到False之后，会将prevLogIndex-1，然后再次发消息给Follower，直到找到相同的位置为止；当找到该位置之后，会将后面位置的消息一条一条发送给Follower，Follower收到并返回True后，Leader会更新该节点nextIndex的值，直到该节点的nextIndex和Leader自身相同</p></li><li><p>进度和Leader相同，且内容相同</p><p>直接返回True，Leader更新nextIndex和CommitIndex即可</p></li><li><p>进度和Leader相同，但内容不同</p><p>这种情况和下一种情况是从属关系，区别仅在于不同的位置后面还有没有其他值</p></li><li><p>进度大于等于Leader</p><p>这种情况常见于旧Leader挂掉然后又恢复了，但是旧Leader有一些新Leader没有的值。Follower在收到Leader最新的位置和值后，会直接抛弃不同的内容，然后将Leader的新值覆写</p></li></ul><p>可以造一个和下面视频一样的情况，观察一下</p><video src=/videos/raft_log_copy_error.mp4 autoplay controls width=800 height=600>
日志复制异常情况</video><h3 id=假如follower进度没有跟上收到的消息还会按2pc处理还是说直接就可以commit>假如Follower进度没有跟上，收到的消息还会按2pc处理还是说直接就可以Commit？</h3><p>会收到消息立即Commit</p><h3 id=新leader是否会提交旧leader未提交的内容>新Leader是否会提交旧Leader未提交的内容?</h3><p>会提交，但不是立即提交，是在提交当前Leader周期的内容时间接提交了之前周期的内容。</p><p>至于为什么会这样，我说一下我的理解，最大的原因是Leader假如立即提交的话，有可能在提交之后挂掉，导致其他和该节点不同的竞选为Leader后，无法处理这个情况。</p><p><img src=http://picgo.qisiii.asia/post/w39dhfwj7v37x15wz_psyqmc0000gn/T/54ada80df08f2e04a5f7a5c8743ee9f6.jpg loading=lazy></p><p>比如论文中给的这个例子，假如在b阶段的时候S1下线，S5获得S3-S5三票成为leader，并写入3；然后到了c阶段，S5下线了，S1再次成为Leader，如果S1在提交之后再次下线，那么此时S1-S3的2的位置都是提交后的2，如果此时S5成为Leader（是有可能的，因为大家长度都一样，最多也就是2），那么S5就无法要求Follower和自己保持一致了，自己的2的位置上是3；</p><p>而如果是在提交自己周期内容时间接提交，会保证有多数的节点是要更长的，这样子，哪怕有些节点和自己的值不同，也不会当选为Leader了。</p><h2 id=参考>参考：</h2><p><a class=link href="https://www.bilibili.com/video/BV1so4y1r7eM/?spm_id_from=333.337.search-card.all.click&amp;vd_source=3d16ef281ad4cd88768b5713b89fbdf7" target=_blank rel=noopener>动画：Raft算法Leader选举、脑裂后选举、日志复制、修复不一致日志和数据安全</a></p><p><a class=link href="https://www.cnblogs.com/Finley/p/14467602.html#:~:text=Raft%20Scope" target=_blank rel=noopener>看动画轻松学会 Raft 算法 - -Finley- - 博客园</a></p><p><a class=link href=https://raft.github.io/raft.pdf target=_blank rel=noopener>Raft论文</a></p><p><a class=link href=https://zhuanlan.zhihu.com/p/343560811 target=_blank rel=noopener>分布式算法：Raft论文翻译</a></p><p><a class=link href=https://segmentfault.com/q/1010000023435805 target=_blank rel=noopener>raft 读请求可以读follower吗</a></p></section><footer class=article-footer><section class=article-tags><a href=/tags/raft/>Raft</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2024-10-11</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/tech/distributed/zookeeper/diff_acceptepoch_currentepoch/><div class=article-details><h2 class=article-title>AcceptEpoch和CurrentEpoch区别</h2></div></a></article><article><a href=/post/tech/lang/threadpoolexecutor/><div class=article-details><h2 class=article-title>ThreadPoolExecutor分析</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/zab/><div class=article-details><h2 class=article-title>Zookeeper源码分析-Zab协议</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/election/><div class=article-details><h2 class=article-title>Zookeeper源码分析-选举机制</h2></div></a></article><article><a href=/post/tech/distributed/zookeeper/watch/><div class=article-details><h2 class=article-title>Zookeeper源码分析-watch机制</h2></div></a></article></div></div></aside><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script src=https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js></script><script>const gitalk=new Gitalk({clientID:"Ov23libDgguDHlLK57yi",clientSecret:"bfd2cba55f272f4919357e37e54e4f4697cdd7d0",repo:"qisiii.github.io",owner:"qisiii",admin:["qisiii"],distractionFreeMode:!1,id:md5(location.pathname)});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script><a href=#top aria-label="go to top" class=top-link id=top-link style=display:none><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg>
</a><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>$(window).scroll(function(){$(this).scrollTop()>300?$("#top-link").show():$("#top-link").hide()})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 起司</section><section class=powerby><a href=https://beian.miit.gov.cn/ target=_blank>京ICP备2023017017号-1</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_site_pv></span>次
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user" aria-hidden=true></i>
<span id=busuanzi_value_site_uv></span>人次</span></section></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>