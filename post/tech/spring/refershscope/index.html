<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Spring中是存在多个Scope的，比如大部分的bean都是单例(Singleton)，还有一些不常用的比如原型(Prototype)、r"><title>RefershScope源码分析</title>
<link rel=canonical href=https://www.qisihub.cn/post/tech/spring/refershscope/><link rel=stylesheet href=/scss/style.min.7657e19dfcc00117e827b40bd92bcea286037ffa4a33e95fc533eaea79d078f9.css><meta property='og:title' content="RefershScope源码分析"><meta property='og:description' content="Spring中是存在多个Scope的，比如大部分的bean都是单例(Singleton)，还有一些不常用的比如原型(Prototype)、r"><meta property='og:url' content='https://www.qisihub.cn/post/tech/spring/refershscope/'><meta property='og:site_name' content='起司的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Spring'><meta property='article:published_time' content='2024-05-26T00:00:00+00:00'><meta property='article:modified_time' content='2025-09-01T02:52:03+00:00'><meta name=twitter:title content="RefershScope源码分析"><meta name=twitter:description content="Spring中是存在多个Scope的，比如大部分的bean都是单例(Singleton)，还有一些不常用的比如原型(Prototype)、r"><link rel=alternate type=application/json href=https://www.qisihub.cn/post/tech/spring/refershscope/index.json><link rel=alternate type=application/rss+xml href=https://www.qisihub.cn/post/tech/spring/refershscope/index.xml><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NDCRP4S7S"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NDCRP4S7S")}</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><span id=top></span></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huf89847f5290877d03a6309f0caaa56f1_43584_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>起司的博客</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/qisiii target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页|Home</span></a></li><li><a href=/post/friends target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-heart-handshake"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/><path d="M12 6 8.707 9.293a1 1 0 000 1.414l.543.543c.69.69 1.81.69 2.5.0l1-1a3.182 3.182.0 014.5.0l2.25 2.25"/><path d="M12.5 15.5l2 2"/><path d="M15 13l2 2"/></svg>
<span>友链|Friends</span></a></li><li><a href=/post/search target=_blank><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索|Search</span></a></li><li><a href=/leetcode target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-leetcode"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg>
<span>力扣|Leetcode</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#注册代理bean>注册代理bean</a></li><li><a href=#实例化scopebean>实例化scopeBean</a><ol><li><a href=#refreshscope>RefreshScope</a></li></ol></li><li><a href=#刷新scopebean>刷新ScopeBean</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tech/>技术人生</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/tech/spring/refershscope/>RefershScope源码分析</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-05-26</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
<time class=article-time--reading>5分钟</time></div><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><div class=artile-time-reading><a href=https://www.qisihub.cn/tags/spring>#Spring</a></div></footer></div></header><section class=article-content><p>Spring中是存在多个Scope的，比如大部分的bean都是单例(Singleton)，还有一些不常用的比如原型(Prototype)、request、session、thread、servlet以及refresh。除了单例之外，其他的都是表示在某一个限定的范围内，是相同的bean，比如原型表示每次都是全新的bean，request表示每一次request是全新的bean。</p><p>RefreshScope，则表示每次Refresh的时候，都会获取全新的bean。这个注解的核心在于Scope注解，且value是refresh。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Target</span><span class=p>({</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>TYPE</span><span class=p>,</span><span class=w> </span><span class=n>ElementType</span><span class=p>.</span><span class=na>METHOD</span><span class=w> </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Retention</span><span class=p>(</span><span class=n>RetentionPolicy</span><span class=p>.</span><span class=na>RUNTIME</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Scope</span><span class=p>(</span><span class=s>&#34;refresh&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Documented</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nd>@interface</span><span class=w> </span><span class=n>RefreshScope</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * @see Scope#proxyMode()
</span></span></span><span class=line><span class=cl><span class=cm>     * @return proxy mode
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=c1>//默认是cglib代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ScopedProxyMode</span><span class=w> </span><span class=nf>proxyMode</span><span class=p>()</span><span class=w> </span><span class=k>default</span><span class=w> </span><span class=n>ScopedProxyMode</span><span class=p>.</span><span class=na>TARGET_CLASS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=注册代理bean>注册代理bean</h2><p>标有Scope的类，无论是那种加载beanDefinition的情况，在注册beanDefinition的时候会注册成代理bean并持有scope范围的bean。例如，bean名字是simpleBean,那么在spring容器中会注册两个bean，scopedTarget.simpleBean(非单例）和simpleBean（单例）。所有的依赖，如@Autowired和@Value类的属性，都只会注入到simpleBean中</p><p>这里以ClassPathBeanDefinitionScanner.doScan为例。</p><p><img src=http://picgo-cloudflare.qisihub.cn/post/2024/12/7b7b2531f1f8c2cfd368fa2e9ea393c5.jpg loading=lazy></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>BeanDefinitionHolder</span><span class=o>&gt;</span><span class=w> </span><span class=nf>doScan</span><span class=p>(</span><span class=n>String</span><span class=p>...</span><span class=w> </span><span class=n>basePackages</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Assert</span><span class=p>.</span><span class=na>notEmpty</span><span class=p>(</span><span class=n>basePackages</span><span class=p>,</span><span class=w> </span><span class=s>&#34;At least one base package must be specified&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>BeanDefinitionHolder</span><span class=o>&gt;</span><span class=w> </span><span class=n>beanDefinitions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedHashSet</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>basePackage</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>basePackages</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>BeanDefinition</span><span class=o>&gt;</span><span class=w> </span><span class=n>candidates</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findCandidateComponents</span><span class=p>(</span><span class=n>basePackage</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>BeanDefinition</span><span class=w> </span><span class=n>candidate</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>candidates</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>//解析Scope注解的元数据信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>ScopeMetadata</span><span class=w> </span><span class=n>scopeMetadata</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>scopeMetadataResolver</span><span class=p>.</span><span class=na>resolveScopeMetadata</span><span class=p>(</span><span class=n>candidate</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>candidate</span><span class=p>.</span><span class=na>setScope</span><span class=p>(</span><span class=n>scopeMetadata</span><span class=p>.</span><span class=na>getScopeName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>beanNameGenerator</span><span class=p>.</span><span class=na>generateBeanName</span><span class=p>(</span><span class=n>candidate</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>candidate</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>AbstractBeanDefinition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>postProcessBeanDefinition</span><span class=p>((</span><span class=n>AbstractBeanDefinition</span><span class=p>)</span><span class=w> </span><span class=n>candidate</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>candidate</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>AnnotatedBeanDefinition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>AnnotationConfigUtils</span><span class=p>.</span><span class=na>processCommonDefinitionAnnotations</span><span class=p>((</span><span class=n>AnnotatedBeanDefinition</span><span class=p>)</span><span class=w> </span><span class=n>candidate</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>checkCandidate</span><span class=p>(</span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>candidate</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>BeanDefinitionHolder</span><span class=w> </span><span class=n>definitionHolder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BeanDefinitionHolder</span><span class=p>(</span><span class=n>candidate</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=c1>//额外处理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>definitionHolder</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=n>AnnotationConfigUtils</span><span class=p>.</span><span class=na>applyScopedProxyMode</span><span class=p>(</span><span class=n>scopeMetadata</span><span class=p>,</span><span class=w> </span><span class=n>definitionHolder</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>beanDefinitions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>definitionHolder</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>registerBeanDefinition</span><span class=p>(</span><span class=n>definitionHolder</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>beanDefinitions</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>需要关注的就两个方法resolveScopeMetadata和AnnotationConfigUtils.<em>applyScopedProxyMode</em></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//就是组装注解元数据信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>ScopeMetadata</span><span class=w> </span><span class=nf>resolveScopeMetadata</span><span class=p>(</span><span class=n>BeanDefinition</span><span class=w> </span><span class=n>definition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ScopeMetadata</span><span class=w> </span><span class=n>metadata</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ScopeMetadata</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>definition</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>AnnotatedBeanDefinition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>AnnotatedBeanDefinition</span><span class=w> </span><span class=n>annDef</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AnnotatedBeanDefinition</span><span class=p>)</span><span class=w> </span><span class=n>definition</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>AnnotationAttributes</span><span class=w> </span><span class=n>attributes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnnotationConfigUtils</span><span class=p>.</span><span class=na>attributesFor</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>annDef</span><span class=p>.</span><span class=na>getMetadata</span><span class=p>(),</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>scopeAnnotationType</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>attributes</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>metadata</span><span class=p>.</span><span class=na>setScopeName</span><span class=p>(</span><span class=n>attributes</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;value&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>ScopedProxyMode</span><span class=w> </span><span class=n>proxyMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attributes</span><span class=p>.</span><span class=na>getEnum</span><span class=p>(</span><span class=s>&#34;proxyMode&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>proxyMode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ScopedProxyMode</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>proxyMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>defaultProxyMode</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>metadata</span><span class=p>.</span><span class=na>setScopedProxyMode</span><span class=p>(</span><span class=n>proxyMode</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>metadata</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>static</span><span class=w> </span><span class=n>BeanDefinitionHolder</span><span class=w> </span><span class=nf>applyScopedProxyMode</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>ScopeMetadata</span><span class=w> </span><span class=n>metadata</span><span class=p>,</span><span class=w> </span><span class=n>BeanDefinitionHolder</span><span class=w> </span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ScopedProxyMode</span><span class=w> </span><span class=n>scopedProxyMode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>metadata</span><span class=p>.</span><span class=na>getScopedProxyMode</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//为no表示不代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>scopedProxyMode</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ScopedProxyMode</span><span class=p>.</span><span class=na>NO</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=n>definition</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//是否是cglib代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>proxyTargetClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scopedProxyMode</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>ScopedProxyMode</span><span class=p>.</span><span class=na>TARGET_CLASS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ScopedProxyCreator</span><span class=p>.</span><span class=na>createScopedProxy</span><span class=p>(</span><span class=n>definition</span><span class=p>,</span><span class=w> </span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=n>proxyTargetClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//这段代码的主要作用就是将bean本身注册为了一个代理bean，且这个代理bean持有一个名字为scopedTarget.+原名字的内部bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>BeanDefinitionHolder</span><span class=w> </span><span class=nf>createScopedProxy</span><span class=p>(</span><span class=n>BeanDefinitionHolder</span><span class=w> </span><span class=n>definition</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>proxyTargetClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>originalBeanName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>definition</span><span class=p>.</span><span class=na>getBeanName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BeanDefinition</span><span class=w> </span><span class=n>targetDefinition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>definition</span><span class=p>.</span><span class=na>getBeanDefinition</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//代理bean的名字是scopedTarget.+原名字</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>targetBeanName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getTargetBeanName</span><span class=p>(</span><span class=n>originalBeanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Create a scoped proxy definition for the original bean name,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// &#34;hiding&#34; the target bean in an internal target definition.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>RootBeanDefinition</span><span class=w> </span><span class=n>proxyDefinition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RootBeanDefinition</span><span class=p>(</span><span class=n>ScopedProxyFactoryBean</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>setDecoratedDefinition</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>BeanDefinitionHolder</span><span class=p>(</span><span class=n>targetDefinition</span><span class=p>,</span><span class=w> </span><span class=n>targetBeanName</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//持有targetBean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>setOriginatingBeanDefinition</span><span class=p>(</span><span class=n>targetDefinition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>setSource</span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getSource</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>setRole</span><span class=p>(</span><span class=n>targetDefinition</span><span class=p>.</span><span class=na>getRole</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>getPropertyValues</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;targetBeanName&#34;</span><span class=p>,</span><span class=w> </span><span class=n>targetBeanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>proxyTargetClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>targetDefinition</span><span class=p>.</span><span class=na>setAttribute</span><span class=p>(</span><span class=n>AutoProxyUtils</span><span class=p>.</span><span class=na>PRESERVE_TARGET_CLASS_ATTRIBUTE</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>TRUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>// ScopedProxyFactoryBean&#39;s &#34;proxyTargetClass&#34; default is TRUE, so we don&#39;t need to set it explicitly here.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>getPropertyValues</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;proxyTargetClass&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>FALSE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Copy autowire settings from original bean definition.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>setAutowireCandidate</span><span class=p>(</span><span class=n>targetDefinition</span><span class=p>.</span><span class=na>isAutowireCandidate</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>setPrimary</span><span class=p>(</span><span class=n>targetDefinition</span><span class=p>.</span><span class=na>isPrimary</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>targetDefinition</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>AbstractBeanDefinition</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>proxyDefinition</span><span class=p>.</span><span class=na>copyQualifiersFrom</span><span class=p>((</span><span class=n>AbstractBeanDefinition</span><span class=p>)</span><span class=w> </span><span class=n>targetDefinition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// The target bean should be ignored in favor of the scoped proxy.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>targetDefinition</span><span class=p>.</span><span class=na>setAutowireCandidate</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>targetDefinition</span><span class=p>.</span><span class=na>setPrimary</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Register the target bean as separate bean in the factory.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//这里注册了targetBean，bean名字是scopedTarget.+原名字</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>registry</span><span class=p>.</span><span class=na>registerBeanDefinition</span><span class=p>(</span><span class=n>targetBeanName</span><span class=p>,</span><span class=w> </span><span class=n>targetDefinition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Return the scoped proxy definition as primary bean definition</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// (potentially an inner bean).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//这里返回代理bean的信息，但是bean名字还是原来的bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BeanDefinitionHolder</span><span class=p>(</span><span class=n>proxyDefinition</span><span class=p>,</span><span class=w> </span><span class=n>originalBeanName</span><span class=p>,</span><span class=w> </span><span class=n>definition</span><span class=p>.</span><span class=na>getAliases</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=实例化scopebean>实例化scopeBean</h2><p>由于scopeBean都不是单例，所以不是在熟知的refresh遍历beanNames进行实例化的。</p><p>而是在finishRefresh方法中，对于ContextRefreshedEvent事件进行处理时，在RefresScope中进行的getBean</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onApplicationEvent</span><span class=p>(</span><span class=n>ContextRefreshedEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>start</span><span class=p>(</span><span class=n>event</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=n>ContextRefreshedEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>context</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>eager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>registry</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>eagerlyInitialize</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>eagerlyInitialize</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>context</span><span class=p>.</span><span class=na>getBeanDefinitionNames</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>BeanDefinition</span><span class=w> </span><span class=n>definition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>registry</span><span class=p>.</span><span class=na>getBeanDefinition</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>definition</span><span class=p>.</span><span class=na>getScope</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>definition</span><span class=p>.</span><span class=na>isLazyInit</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>Object</span><span class=w> </span><span class=n>bean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>context</span><span class=p>.</span><span class=na>getBean</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bean</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在doGetBean时，对于Scope类型，是要走特殊的逻辑的，会从scopes中获取对应的scope。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mbd</span><span class=p>.</span><span class=na>isSingleton</span><span class=p>())</span><span class=w> </span><span class=p>{...}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mbd</span><span class=p>.</span><span class=na>isPrototype</span><span class=p>())</span><span class=w> </span><span class=p>{...}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>scopeName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mbd</span><span class=p>.</span><span class=na>getScope</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Scope</span><span class=w> </span><span class=n>scope</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>scopes</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>scopeName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>scope</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&#34;No Scope registered for scope name &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>scopeName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//会调到RefreshScope的get方法，将其添加到cache中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>Object</span><span class=w> </span><span class=n>scopedInstance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>scope</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>beforePrototypeCreation</span><span class=p>(</span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=k>return</span><span class=w> </span><span class=n>createBean</span><span class=p>(</span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>mbd</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>afterPrototypeCreation</span><span class=p>(</span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>bean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getObjectForBeanInstance</span><span class=p>(</span><span class=n>scopedInstance</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>mbd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalStateException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BeanCreationException</span><span class=p>(</span><span class=n>beanName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=s>&#34;Scope &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>scopeName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; is not active for the current thread; consider &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=s>&#34;defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=refreshscope>RefreshScope</h3><p>这里需要先了解下scopes里面的内容从何而来，以及认识一下ScopeRefresh类。</p><p>RefreshScope是实现了BeanFactoryPostProcessor接口的类，因此在执行到postProcessBeanFactory时，就会添加到scopes中去。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>postProcessBeanFactory</span><span class=p>(</span><span class=n>ConfigurableListableBeanFactory</span><span class=w> </span><span class=n>beanFactory</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=kd>throws</span><span class=w> </span><span class=n>BeansException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>beanFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>beanFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>beanFactory</span><span class=p>.</span><span class=na>registerScope</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>setSerializationId</span><span class=p>(</span><span class=n>beanFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>registerScope</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>scopeName</span><span class=p>,</span><span class=w> </span><span class=n>Scope</span><span class=w> </span><span class=n>scope</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>scopeName</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Scope identifier must not be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>scope</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Scope must not be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>SCOPE_SINGLETON</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>scopeName</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>SCOPE_PROTOTYPE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>scopeName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Cannot replace existing scopes &#39;singleton&#39; and &#39;prototype&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//scopeName为refresh，value是this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Scope</span><span class=w> </span><span class=n>previous</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>scopes</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>scopeName</span><span class=p>,</span><span class=w> </span><span class=n>scope</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>previous</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>previous</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>scope</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Replacing scope &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>scopeName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; from [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>previous</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;] to [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>scope</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isTraceEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>logger</span><span class=p>.</span><span class=na>trace</span><span class=p>(</span><span class=s>&#34;Registering scope &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>scopeName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; with implementation [&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>scope</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;]&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>同时RefreshScope继承了GenericScope，其大部分核心的逻辑都在GenericScope，GenericScope持有一个cache的对象，就是当前scope对应的所有的bean，cache的类型是ConcurrentHashMap。</p><p>而在doCreateBean方法，scope.get会真正调到这里。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>ObjectFactory</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>objectFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BeanLifecycleWrapper</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>new</span><span class=w> </span><span class=n>BeanLifecycleWrapper</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>objectFactory</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReentrantReadWriteLock</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//实际是调用objectFactory.getObject();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>getBean</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>this</span><span class=p>.</span><span class=na>errors</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getBean</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>bean</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>bean</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=k>this</span><span class=p>.</span><span class=na>bean</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>objectFactory</span><span class=p>.</span><span class=na>getObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=刷新scopebean>刷新ScopeBean</h2><p>在RefreshScope类中，表示刷新的方法有两个，分别是刷新单个bean或者刷新全部的bean，本质是调用的cache的remove和clear。</p><p>当在缓存中删除之后，下一次再调用的时候，就会重新调用getBean来创造新的bean，这也是scope为refresh的本质。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>refresh</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>name</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=n>SCOPED_TARGET_PREFIX</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>// User wants to refresh the bean with this name but that isn&#39;t the one in the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=c1>// cache...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SCOPED_TARGET_PREFIX</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Ensure lifecycle is finished if bean was disposable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=kd>super</span><span class=p>.</span><span class=na>destroy</span><span class=p>(</span><span class=n>name</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>this</span><span class=p>.</span><span class=na>context</span><span class=p>.</span><span class=na>publishEvent</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>RefreshScopeRefreshedEvent</span><span class=p>(</span><span class=n>name</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ManagedOperation</span><span class=p>(</span><span class=n>description</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Dispose of the current instance of all beans &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=o>+</span><span class=w> </span><span class=s>&#34;in this scope and force a refresh on next method execution.&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>refreshAll</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>super</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>context</span><span class=p>.</span><span class=na>publishEvent</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>RefreshScopeRefreshedEvent</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>destroy</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//移除指定bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>BeanLifecycleWrapper</span><span class=w> </span><span class=n>wrapper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>cache</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>wrapper</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>Lock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>wrapper</span><span class=p>.</span><span class=na>getName</span><span class=p>()).</span><span class=na>writeLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>wrapper</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>this</span><span class=p>.</span><span class=na>errors</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>destroy</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span><span class=w> </span><span class=n>errors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//移除所有的bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Collection</span><span class=o>&lt;</span><span class=n>BeanLifecycleWrapper</span><span class=o>&gt;</span><span class=w> </span><span class=n>wrappers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>BeanLifecycleWrapper</span><span class=w> </span><span class=n>wrapper</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>wrappers</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>Lock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>locks</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>wrapper</span><span class=p>.</span><span class=na>getName</span><span class=p>()).</span><span class=na>writeLock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>wrapper</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>errors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>errors</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>throw</span><span class=w> </span><span class=n>wrapIfNecessary</span><span class=p>(</span><span class=n>errors</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>errors</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></section><footer class=article-footer><section class=article-tags><a href=/tags/spring/>Spring</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2025-09-01</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/tech/spring/cycle_bean/><div class=article-details><h2 class=article-title>SpringBean循环依赖处理流程</h2></div></a></article><article><a href=/post/tech/spring/aop/><div class=article-details><h2 class=article-title>Aop执行逻辑</h2></div></a></article><article><a href=/post/tech/spring/async/><div class=article-details><h2 class=article-title>@Async源码分析</h2></div></a></article><article><a href=/post/tech/spring/beandefinitionregistion/><div class=article-details><h2 class=article-title>Spring注册BeanDefinition的方式</h2></div></a></article><article><a href=/post/base/binary/><div class=article-details><h2 class=article-title>Binary</h2></div></a></article></div></div></aside><a href=#top aria-label="go to top" class=top-link id=top-link style=display:none><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg>
</a><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>$(window).scroll(function(){$(this).scrollTop()>300?$("#top-link").show():$("#top-link").hide()})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2025 起司</section><section class=powerby><a href=https://beian.miit.gov.cn/ target=_blank>京ICP备2023017017号-1</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>