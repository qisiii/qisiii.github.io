<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="AopAutoConfiguration 在spring-boot-autoconfiguration的spring.factories中指定了org.springframewor"><title>Aop执行逻辑</title>
<link rel=canonical href=https://qisiii.github.io/post/tech/spring/aop/><link rel=stylesheet href=/scss/style.min.7657e19dfcc00117e827b40bd92bcea286037ffa4a33e95fc533eaea79d078f9.css><meta property='og:title' content="Aop执行逻辑"><meta property='og:description' content="AopAutoConfiguration 在spring-boot-autoconfiguration的spring.factories中指定了org.springframewor"><meta property='og:url' content='https://qisiii.github.io/post/tech/spring/aop/'><meta property='og:site_name' content='起司的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='Spring'><meta property='article:published_time' content='2024-04-27T00:00:00+00:00'><meta property='article:modified_time' content='2024-11-24T03:39:39+00:00'><meta name=twitter:title content="Aop执行逻辑"><meta name=twitter:description content="AopAutoConfiguration 在spring-boot-autoconfiguration的spring.factories中指定了org.springframewor"><link rel=alternate type=application/json href=https://qisiii.github.io/post/tech/spring/aop/index.json><link rel=alternate type=application/rss+xml href=https://qisiii.github.io/post/tech/spring/aop/index.xml><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-8NDCRP4S7S"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8NDCRP4S7S")}</script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><span id=top></span></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huf89847f5290877d03a6309f0caaa56f1_43584_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>起司的博客</a></h1><h2 class=site-description></h2></div></header><ol class=menu-social><li><a href=https://github.com/qisiii target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/index.xml target=_blank title=rss rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页|Home</span></a></li><li><a href=/post/friends target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-heart-handshake"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19.5 12.572 12 20l-7.5-7.428A5 5 0 1112 6.006a5 5 0 117.5 6.572"/><path d="M12 6 8.707 9.293a1 1 0 000 1.414l.543.543c.69.69 1.81.69 2.5.0l1-1a3.182 3.182.0 014.5.0l2.25 2.25"/><path d="M12.5 15.5l2 2"/><path d="M15 13l2 2"/></svg>
<span>友链|Friends</span></a></li><li><a href=/post/search target=_blank><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索|Search</span></a></li><li><a href=/leetcode target=_blank><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-leetcode"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 13h7.5"/><path d="M9.424 7.268l4.999-4.999"/><path d="M16.633 16.644l-2.402 2.415a3.189 3.189.0 01-4.524.0l-3.77-3.787a3.223 3.223.0 010-4.544l3.77-3.787a3.189 3.189.0 014.524.0l2.302 2.313"/></svg>
<span>力扣|Leetcode</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#aopautoconfiguration>AopAutoConfiguration</a></li><li><a href=#annotationawareaspectjautoproxycreator>AnnotationAwareAspectJAutoProxyCreator</a><ol><li><a href=#增强流程>增强流程</a></li><li><a href=#wrapifnecessary>wrapIfNecessary</a></li><li><a href=#findcandidateadvisors>findCandidateAdvisors</a><ol><li><a href=#获取advisor>获取Advisor</a></li><li><a href=#获取切点>获取切点</a></li><li><a href=#获取advice>获取Advice</a></li></ol></li><li><a href=#advisor排序逻辑>Advisor排序逻辑</a><ol><li><a href=#annotationawareordercomparator>AnnotationAwareOrderComparator</a></li><li><a href=#aspectjawareadvisorautoproxycreatorsort>AspectJAwareAdvisorAutoProxyCreator.sort</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/tech/>技术人生</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/post/tech/spring/aop/>Aop执行逻辑</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-04-27</time></div><div><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-hourglass-empty"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
<time class=article-time--reading>8分钟</time></div><span id=busuanzi_container_value_page_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_page_pv></span>&nbsp;</span><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg><div class=artile-time-reading><a href=https://qisiii.github.io/tags/spring>#Spring</a></div></footer></div></header><section class=article-content><h2 id=aopautoconfiguration>AopAutoConfiguration</h2><p>在spring-boot-autoconfiguration的spring.factories中指定了org.springframework.boot.autoconfigure.aop.AopAutoConfiguration这个bean，因此会进行执行</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Configuration</span><span class=p>(</span><span class=n>proxyBeanMethods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//默认开启，如果不配或者为true都是开启，为false则是关闭</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ConditionalOnProperty</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;spring.aop&#34;</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;auto&#34;</span><span class=p>,</span><span class=w> </span><span class=n>havingValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>,</span><span class=w> </span><span class=n>matchIfMissing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>AopAutoConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//如果项目中引入aspectjweaver包，则实例化AspectJAutoProxyingConfiguration否则实例化ClassProxyingConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@Configuration</span><span class=p>(</span><span class=n>proxyBeanMethods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@ConditionalOnClass</span><span class=p>(</span><span class=n>Advice</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>AspectJAutoProxyingConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@Configuration</span><span class=p>(</span><span class=n>proxyBeanMethods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@EnableAspectJAutoProxy</span><span class=p>(</span><span class=n>proxyTargetClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@ConditionalOnProperty</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;spring.aop&#34;</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;proxy-target-class&#34;</span><span class=p>,</span><span class=w> </span><span class=n>havingValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;false&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>JdkDynamicAutoProxyConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>//默认启用的是cglib代理，通过@EnableAspectJAutoProxy引入其他类（EnableAspectJAutoProxy）的配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@Configuration</span><span class=p>(</span><span class=n>proxyBeanMethods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@EnableAspectJAutoProxy</span><span class=p>(</span><span class=n>proxyTargetClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@ConditionalOnProperty</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;spring.aop&#34;</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;proxy-target-class&#34;</span><span class=p>,</span><span class=w> </span><span class=n>havingValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>matchIfMissing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>CglibAutoProxyConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@Configuration</span><span class=p>(</span><span class=n>proxyBeanMethods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@ConditionalOnMissingClass</span><span class=p>(</span><span class=s>&#34;org.aspectj.weaver.Advice&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@ConditionalOnProperty</span><span class=p>(</span><span class=n>prefix</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;spring.aop&#34;</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;proxy-target-class&#34;</span><span class=p>,</span><span class=w> </span><span class=n>havingValue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;true&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>matchIfMissing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>ClassProxyingConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>static</span><span class=w> </span><span class=n>BeanFactoryPostProcessor</span><span class=w> </span><span class=nf>forceAutoProxyCreatorToUseClassProxying</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>beanFactory</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>beanFactory</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>BeanDefinitionRegistry</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>BeanDefinitionRegistry</span><span class=p>)</span><span class=w> </span><span class=n>beanFactory</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>AopConfigUtils</span><span class=p>.</span><span class=na>registerAutoProxyCreatorIfNecessary</span><span class=p>(</span><span class=n>registry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=c1>//默认也是cglib</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               </span><span class=n>AopConfigUtils</span><span class=p>.</span><span class=na>forceAutoProxyCreatorToUseClassProxying</span><span class=p>(</span><span class=n>registry</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>AspectJAutoProxyingConfiguration和ClassProxyingConfiguration的区别在于</p><p>ClassProxyingConfiguration想要注册的是InfrastructureAdvisorAutoProxyCreator</p><p>AspectJAutoProxyingConfiguration注册的则是AnnotationAwareAspectJAutoProxyCreator</p><p>这里是不同级别的creator，总共存在三个，如果存在低级则替换成高级</p><p><img src="https://l8ut65fgfc.feishu.cn/space/api/box/stream/download/asynccode/?code=YjFhM2NkMmE0MTNiZDFkOTAzOGFhNzNlZTZjZGY3ZDVfTXd1NmJCWWRtVThTRGlpVkZDNDhyWTVhYjhQaUZmaDZfVG9rZW46TElLb2JMaHNHb1RMMjh4bzk0amNxZ3JUbkxoXzE3MjMzNjc4NDI6MTcyMzM3MTQ0Ml9WNA" loading=lazy></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>BeanDefinition</span><span class=w> </span><span class=nf>registerOrEscalateApcAsRequired</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>cls</span><span class=p>,</span><span class=w> </span><span class=n>BeanDefinitionRegistry</span><span class=w> </span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>source</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Assert</span><span class=p>.</span><span class=na>notNull</span><span class=p>(</span><span class=n>registry</span><span class=p>,</span><span class=w> </span><span class=s>&#34;BeanDefinitionRegistry must not be null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>registry</span><span class=p>.</span><span class=na>containsBeanDefinition</span><span class=p>(</span><span class=n>AUTO_PROXY_CREATOR_BEAN_NAME</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>BeanDefinition</span><span class=w> </span><span class=n>apcDefinition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>registry</span><span class=p>.</span><span class=na>getBeanDefinition</span><span class=p>(</span><span class=n>AUTO_PROXY_CREATOR_BEAN_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cls</span><span class=p>.</span><span class=na>getName</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>apcDefinition</span><span class=p>.</span><span class=na>getBeanClassName</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=kt>int</span><span class=w> </span><span class=n>currentPriority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findPriorityForClass</span><span class=p>(</span><span class=n>apcDefinition</span><span class=p>.</span><span class=na>getBeanClassName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=kt>int</span><span class=w> </span><span class=n>requiredPriority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findPriorityForClass</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=c1>//如果当前等级小于需要的等级，则改为高等级</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>currentPriority</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>requiredPriority</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>apcDefinition</span><span class=p>.</span><span class=na>setBeanClassName</span><span class=p>(</span><span class=n>cls</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>RootBeanDefinition</span><span class=w> </span><span class=n>beanDefinition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RootBeanDefinition</span><span class=p>(</span><span class=n>cls</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>beanDefinition</span><span class=p>.</span><span class=na>setSource</span><span class=p>(</span><span class=n>source</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//这个顺序有啥用？</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>beanDefinition</span><span class=p>.</span><span class=na>getPropertyValues</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=s>&#34;order&#34;</span><span class=p>,</span><span class=w> </span><span class=n>Ordered</span><span class=p>.</span><span class=na>HIGHEST_PRECEDENCE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>beanDefinition</span><span class=p>.</span><span class=na>setRole</span><span class=p>(</span><span class=n>BeanDefinition</span><span class=p>.</span><span class=na>ROLE_INFRASTRUCTURE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>registry</span><span class=p>.</span><span class=na>registerBeanDefinition</span><span class=p>(</span><span class=n>AUTO_PROXY_CREATOR_BEAN_NAME</span><span class=p>,</span><span class=w> </span><span class=n>beanDefinition</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>beanDefinition</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这里先不熟悉三个creator的区别，有时间了搞，由于事务这里注册的是最高级别-AnnotationAwareAspectJAutoProxyCreator，所以先分析这个类</p><h2 id=annotationawareaspectjautoproxycreator>AnnotationAwareAspectJAutoProxyCreator</h2><p><img src="https://l8ut65fgfc.feishu.cn/space/api/box/stream/download/asynccode/?code=MTM4ZjUyOGI5MTUyZTg3ODRkMDgzZGQyMzFiNTJiN2FfUTZLWTNwNTlReEFiMjVuT0FpcWR5bFZ2eGtNZHNWSXVfVG9rZW46S3dXQWJnOWxRb1Z0bXh4UVM1bmNtcUdWbnRnXzE3MjMzNjc4ODc6MTcyMzM3MTQ4N19WNA" loading=lazy></p><p>观察类图</p><p>这个类实现了BeanFactoryAware接口来获取beanFacotry</p><p>实现了SmartInstantiationAwareBeanPostProcessor接口，主要重写了四个方法：predictBeanType、postProcessBeforeInstantiation、getEarlyBeanReference和postProcessAfterInstantiation，</p><p>postProcessBeforeInstantiation主要是用于自定义了TargetSource的情况，但是没见在哪用过；</p><p>getEarlyBeanReference则适用于处理循环依赖的时候，核心方法是wrapIfNecessary</p><p>postProcessAfterInstantiation则是正常的bean初始化结束后对bean进行aop增强的逻辑</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>getEarlyBeanReference</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Object</span><span class=w> </span><span class=n>cacheKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCacheKey</span><span class=p>(</span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>this</span><span class=p>.</span><span class=na>earlyProxyReferences</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>bean</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>wrapIfNecessary</span><span class=p>(</span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>cacheKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>postProcessAfterInitialization</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bean</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Object</span><span class=w> </span><span class=n>cacheKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getCacheKey</span><span class=p>(</span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>earlyProxyReferences</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>bean</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=n>wrapIfNecessary</span><span class=p>(</span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>cacheKey</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=增强流程>增强流程</h3><p><img src=http://picgo.qisiii.asia/post/11-17-20-10-image.png loading=lazy></p><h3 id=wrapifnecessary>wrapIfNecessary</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=nf>wrapIfNecessary</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>bean</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>cacheKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>hasLength</span><span class=p>(</span><span class=n>beanName</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>targetSourcedBeans</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>beanName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//已经存在表示这个bean处理过了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Boolean</span><span class=p>.</span><span class=na>FALSE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>advisedBeans</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>)))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//Advice、Pointcut、Advisor、AopInfrastructureBean为基础架构类，永远不可被代理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//Q&amp;A 2024/4/27</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// Q:shouldSkip里逻辑不懂,而且isInfrastructureClass排除了Advisor.class.isAssignableFrom(beanClass)，但实际上查询Advicors的时候又找的这个类型的bean，这怎么搞</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// A:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isInfrastructureClass</span><span class=p>(</span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>())</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>shouldSkip</span><span class=p>(</span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>beanName</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>advisedBeans</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>FALSE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// Create proxy if we have advice.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// async最大的问题就是这里没有扫描到</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//获取所有匹配的Advisor,是排好序的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>specificInterceptors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAdvicesAndAdvisorsForBean</span><span class=p>(</span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>specificInterceptors</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>DO_NOT_PROXY</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>advisedBeans</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>TRUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>//进行增强</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Object</span><span class=w> </span><span class=n>proxy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createProxy</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bean</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>beanName</span><span class=p>,</span><span class=w> </span><span class=n>specificInterceptors</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SingletonTargetSource</span><span class=p>(</span><span class=n>bean</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>proxyTypes</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>proxy</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>proxy</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>this</span><span class=p>.</span><span class=na>advisedBeans</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=p>.</span><span class=na>FALSE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=nf>findEligibleAdvisors</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>beanClass</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>beanName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//先查找所有的候选Advisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=n>candidateAdvisors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findCandidateAdvisors</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//进行匹配</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=n>eligibleAdvisors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findAdvisorsThatCanApply</span><span class=p>(</span><span class=n>candidateAdvisors</span><span class=p>,</span><span class=w> </span><span class=n>beanClass</span><span class=p>,</span><span class=w> </span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//追加了一个ExposeInvocationInterceptor.ADVISOR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>extendAdvisors</span><span class=p>(</span><span class=n>eligibleAdvisors</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>eligibleAdvisors</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>//进行排序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>//默认是AnnotationAwareOrderComparator.sort(advisors)；但是AspectJAwareAdvisorAutoProxyCreator重写了排序逻辑</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>eligibleAdvisors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sortAdvisors</span><span class=p>(</span><span class=n>eligibleAdvisors</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>eligibleAdvisors</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=findcandidateadvisors>findCandidateAdvisors</h3><p>findCandidateAdvisors有两种，一种是继承了Advisor接口的bean（通过beanFactory直接查询），一种是标有@Aspect的（需要扫描所有的bean，然后反射获取切面所有的方法，每个方法单独封装为一个Advisor</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getAdvisors</span><span class=p>(</span><span class=n>MetadataAwareAspectInstanceFactory</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>aspectClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>.</span><span class=na>getAspectMetadata</span><span class=p>().</span><span class=na>getAspectClass</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>String</span><span class=w> </span><span class=n>aspectName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>.</span><span class=na>getAspectMetadata</span><span class=p>().</span><span class=na>getAspectName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>validate</span><span class=p>(</span><span class=n>aspectClass</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// We need to wrap the MetadataAwareAspectInstanceFactory with a decorator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>// so that it will only instantiate once.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>MetadataAwareAspectInstanceFactory</span><span class=w> </span><span class=n>lazySingletonAspectInstanceFactory</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>new</span><span class=w> </span><span class=n>LazySingletonAspectInstanceFactoryDecorator</span><span class=p>(</span><span class=n>aspectInstanceFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=n>advisors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//获取所有类的方法并排序，按照注解排序Around.class, Before.class, After.class, AfterReturning.class, AfterThrowing.class)-&gt;按照方法名排序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>getAdvisorMethods</span><span class=p>(</span><span class=n>aspectClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>//获取切面-将pointCut和Advice组装起来</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAdvisor</span><span class=p>(</span><span class=n>method</span><span class=p>,</span><span class=w> </span><span class=n>lazySingletonAspectInstanceFactory</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>aspectName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>advisor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>advisors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>advisor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//这个是introduction机制，需要使用@DeclareParents注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Field</span><span class=w> </span><span class=n>field</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>aspectClass</span><span class=p>.</span><span class=na>getDeclaredFields</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getDeclareParentsAdvisor</span><span class=p>(</span><span class=n>field</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>advisor</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=n>advisors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>advisor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Method</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getAdvisorMethods</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>aspectClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Method</span><span class=o>&gt;</span><span class=w> </span><span class=n>methods</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>ReflectionUtils</span><span class=p>.</span><span class=na>doWithMethods</span><span class=p>(</span><span class=n>aspectClass</span><span class=p>,</span><span class=w> </span><span class=n>methods</span><span class=p>::</span><span class=n>add</span><span class=p>,</span><span class=w> </span><span class=n>adviceMethodFilter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>methods</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>methods</span><span class=p>.</span><span class=na>sort</span><span class=p>(</span><span class=n>adviceMethodComparator</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>methods</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//先按照注解排序，再按照方法名称排序</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Comparator</span><span class=o>&lt;</span><span class=n>Method</span><span class=o>&gt;</span><span class=w> </span><span class=n>adviceKindComparator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConvertingComparator</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>InstanceComparator</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Around</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Before</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>After</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>AfterReturning</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>AfterThrowing</span><span class=p>.</span><span class=na>class</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>(</span><span class=n>Converter</span><span class=o>&lt;</span><span class=n>Method</span><span class=p>,</span><span class=w> </span><span class=n>Annotation</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>AspectJAnnotation</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>ann</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AbstractAspectJAdvisorFactory</span><span class=p>.</span><span class=na>findAspectJAnnotationOnMethod</span><span class=p>(</span><span class=n>method</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>ann</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>ann</span><span class=p>.</span><span class=na>getAnnotation</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Comparator</span><span class=o>&lt;</span><span class=n>Method</span><span class=o>&gt;</span><span class=w> </span><span class=n>methodNameComparator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConvertingComparator</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>Method</span><span class=p>::</span><span class=n>getName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>adviceMethodComparator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adviceKindComparator</span><span class=p>.</span><span class=na>thenComparing</span><span class=p>(</span><span class=n>methodNameComparator</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h4 id=获取advisor>获取Advisor</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=n>Advisor</span><span class=w> </span><span class=nf>getAdvisor</span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>MetadataAwareAspectInstanceFactory</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>declarationOrderInAspect</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>aspectName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>validate</span><span class=p>(</span><span class=n>aspectInstanceFactory</span><span class=p>.</span><span class=na>getAspectMetadata</span><span class=p>().</span><span class=na>getAspectClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//切点其实封装的就是表达式和切面类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>AspectJExpressionPointcut</span><span class=w> </span><span class=n>expressionPointcut</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getPointcut</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>.</span><span class=na>getAspectMetadata</span><span class=p>().</span><span class=na>getAspectClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>expressionPointcut</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//封装切点和Advice，advice其实就是那几种注解@Before、@After之类的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InstantiationModelAwarePointcutAdvisorImpl</span><span class=p>(</span><span class=n>expressionPointcut</span><span class=p>,</span><span class=w> </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>,</span><span class=w> </span><span class=n>declarationOrderInAspect</span><span class=p>,</span><span class=w> </span><span class=n>aspectName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=获取切点>获取切点</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=n>AspectJExpressionPointcut</span><span class=w> </span><span class=nf>getPointcut</span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>candidateAspectClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>AspectJAnnotation</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>aspectJAnnotation</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>AbstractAspectJAdvisorFactory</span><span class=p>.</span><span class=na>findAspectJAnnotationOnMethod</span><span class=p>(</span><span class=n>candidateAdviceMethod</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>aspectJAnnotation</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>AspectJExpressionPointcut</span><span class=w> </span><span class=n>ajexp</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>new</span><span class=w> </span><span class=n>AspectJExpressionPointcut</span><span class=p>(</span><span class=n>candidateAspectClass</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=c1>//将方法上的注解的value值放到expression属性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>ajexp</span><span class=p>.</span><span class=na>setExpression</span><span class=p>(</span><span class=n>aspectJAnnotation</span><span class=p>.</span><span class=na>getPointcutExpression</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>beanFactory</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>ajexp</span><span class=p>.</span><span class=na>setBeanFactory</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>beanFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>ajexp</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=获取advice>获取Advice</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=n>Advice</span><span class=w> </span><span class=nf>getAdvice</span><span class=p>(</span><span class=n>Method</span><span class=w> </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>AspectJExpressionPointcut</span><span class=w> </span><span class=n>expressionPointcut</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>MetadataAwareAspectInstanceFactory</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>declarationOrder</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>aspectName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//主要就这几种场景的advice</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>aspectJAnnotation</span><span class=p>.</span><span class=na>getAnnotationType</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>case</span><span class=w> </span><span class=n>AtPointcut</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logger</span><span class=p>.</span><span class=na>isDebugEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>logger</span><span class=p>.</span><span class=na>debug</span><span class=p>(</span><span class=s>&#34;Processing pointcut &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>candidateAdviceMethod</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>case</span><span class=w> </span><span class=n>AtAround</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>springAdvice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AspectJAroundAdvice</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>expressionPointcut</span><span class=p>,</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>case</span><span class=w> </span><span class=n>AtBefore</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>springAdvice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AspectJMethodBeforeAdvice</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>expressionPointcut</span><span class=p>,</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>case</span><span class=w> </span><span class=n>AtAfter</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>springAdvice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AspectJAfterAdvice</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>expressionPointcut</span><span class=p>,</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>case</span><span class=w> </span><span class=n>AtAfterReturning</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>springAdvice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AspectJAfterReturningAdvice</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>expressionPointcut</span><span class=p>,</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>AfterReturning</span><span class=w> </span><span class=n>afterReturningAnnotation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AfterReturning</span><span class=p>)</span><span class=w> </span><span class=n>aspectJAnnotation</span><span class=p>.</span><span class=na>getAnnotation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>hasText</span><span class=p>(</span><span class=n>afterReturningAnnotation</span><span class=p>.</span><span class=na>returning</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>springAdvice</span><span class=p>.</span><span class=na>setReturningName</span><span class=p>(</span><span class=n>afterReturningAnnotation</span><span class=p>.</span><span class=na>returning</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>case</span><span class=w> </span><span class=n>AtAfterThrowing</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>springAdvice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AspectJAfterThrowingAdvice</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>candidateAdviceMethod</span><span class=p>,</span><span class=w> </span><span class=n>expressionPointcut</span><span class=p>,</span><span class=w> </span><span class=n>aspectInstanceFactory</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>AfterThrowing</span><span class=w> </span><span class=n>afterThrowingAnnotation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>AfterThrowing</span><span class=p>)</span><span class=w> </span><span class=n>aspectJAnnotation</span><span class=p>.</span><span class=na>getAnnotation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>StringUtils</span><span class=p>.</span><span class=na>hasText</span><span class=p>(</span><span class=n>afterThrowingAnnotation</span><span class=p>.</span><span class=na>throwing</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>springAdvice</span><span class=p>.</span><span class=na>setThrowingName</span><span class=p>(</span><span class=n>afterThrowingAnnotation</span><span class=p>.</span><span class=na>throwing</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnsupportedOperationException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;Unsupported advice type on method: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>candidateAdviceMethod</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=advisor排序逻辑>Advisor排序逻辑</h3><p>默认是AnnotationAwareOrderComparator.sort(advisors)；但是AspectJAwareAdvisorAutoProxyCreator重写了排序逻辑</p><h4 id=annotationawareordercomparator>AnnotationAwareOrderComparator</h4><p>这个类实现了OrderComparator，正常对于OrderComparator来说，其compare调用doCompare，里面的顺序以getOrder方法为主，getOrder调用的又是findOrder，及根据接口Ordered.getOrder获取顺序值</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>doCompare</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>o1</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>o2</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>OrderSourceProvider</span><span class=w> </span><span class=n>sourceProvider</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kt>boolean</span><span class=w> </span><span class=n>p1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>o1</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>PriorityOrdered</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kt>boolean</span><span class=w> </span><span class=n>p2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>o2</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>PriorityOrdered</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>p2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>p2</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>p1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kt>int</span><span class=w> </span><span class=n>i1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getOrder</span><span class=p>(</span><span class=n>o1</span><span class=p>,</span><span class=w> </span><span class=n>sourceProvider</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kt>int</span><span class=w> </span><span class=n>i2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getOrder</span><span class=p>(</span><span class=n>o2</span><span class=p>,</span><span class=w> </span><span class=n>sourceProvider</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>compare</span><span class=p>(</span><span class=n>i1</span><span class=p>,</span><span class=w> </span><span class=n>i2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>findOrder</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Ordered</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=p>((</span><span class=n>Ordered</span><span class=p>)</span><span class=w> </span><span class=n>obj</span><span class=p>).</span><span class=na>getOrder</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>而AnnotationAwareOrderComparator则进行了扩展，对于使用了@Order注解的也可以做排序，主要是重写了findOrder方法</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>findOrder</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Integer</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>findOrder</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>order</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>order</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>findOrderFromAnnotation</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Nullable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>findOrderFromAnnotation</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>AnnotatedElement</span><span class=w> </span><span class=n>element</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>AnnotatedElement</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=p>(</span><span class=n>AnnotatedElement</span><span class=p>)</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>obj</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>MergedAnnotations</span><span class=w> </span><span class=n>annotations</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MergedAnnotations</span><span class=p>.</span><span class=na>from</span><span class=p>(</span><span class=n>element</span><span class=p>,</span><span class=w> </span><span class=n>SearchStrategy</span><span class=p>.</span><span class=na>TYPE_HIERARCHY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>Integer</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OrderUtils</span><span class=p>.</span><span class=na>getOrderFromAnnotations</span><span class=p>(</span><span class=n>element</span><span class=p>,</span><span class=w> </span><span class=n>annotations</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>order</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>DecoratingProxy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>findOrderFromAnnotation</span><span class=p>(((</span><span class=n>DecoratingProxy</span><span class=p>)</span><span class=w> </span><span class=n>obj</span><span class=p>).</span><span class=na>getDecoratedClass</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>order</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>org</span><span class=p>.</span><span class=na>springframework</span><span class=p>.</span><span class=na>core</span><span class=p>.</span><span class=na>annotation</span><span class=p>.</span><span class=na>OrderUtils</span><span class=err>#</span><span class=n>findOrder</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=nf>findOrder</span><span class=p>(</span><span class=n>MergedAnnotations</span><span class=w> </span><span class=n>annotations</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>MergedAnnotation</span><span class=o>&lt;</span><span class=n>Order</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderAnnotation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>annotations</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>Order</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>orderAnnotation</span><span class=p>.</span><span class=na>isPresent</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>orderAnnotation</span><span class=p>.</span><span class=na>getInt</span><span class=p>(</span><span class=n>MergedAnnotation</span><span class=p>.</span><span class=na>VALUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>MergedAnnotation</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>priorityAnnotation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>annotations</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>JAVAX_PRIORITY_ANNOTATION</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>priorityAnnotation</span><span class=p>.</span><span class=na>isPresent</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>priorityAnnotation</span><span class=p>.</span><span class=na>getInt</span><span class=p>(</span><span class=n>MergedAnnotation</span><span class=p>.</span><span class=na>VALUE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h4 id=aspectjawareadvisorautoproxycreatorsort>AspectJAwareAdvisorAutoProxyCreator.sort</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>protected</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=nf>sortAdvisors</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=n>advisors</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>PartiallyComparableAdvisorHolder</span><span class=o>&gt;</span><span class=w> </span><span class=n>partiallyComparableAdvisors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>advisors</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>advisors</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>partiallyComparableAdvisors</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>PartiallyComparableAdvisorHolder</span><span class=p>(</span><span class=n>advisor</span><span class=p>,</span><span class=w> </span><span class=n>DEFAULT_PRECEDENCE_COMPARATOR</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>PartiallyComparableAdvisorHolder</span><span class=o>&gt;</span><span class=w> </span><span class=n>sorted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PartialOrder</span><span class=p>.</span><span class=na>sort</span><span class=p>(</span><span class=n>partiallyComparableAdvisors</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sorted</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>advisors</span><span class=p>.</span><span class=na>size</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>PartiallyComparableAdvisorHolder</span><span class=w> </span><span class=n>pcAdvisor</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>sorted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>pcAdvisor</span><span class=p>.</span><span class=na>getAdvisor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>sortAdvisors</span><span class=p>(</span><span class=n>advisors</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Comparator</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=n>DEFAULT_PRECEDENCE_COMPARATOR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AspectJPrecedenceComparator</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>先梳理一下陌生的类</p><p>PartiallyComparableAdvisorHolder：持有Advisor和一个Comparator，重写了compareTo和fallbackCompareTo</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>PartiallyComparableAdvisorHolder</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>PartialComparable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Comparator</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=n>comparator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=nf>PartiallyComparableAdvisorHolder</span><span class=p>(</span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor</span><span class=p>,</span><span class=w> </span><span class=n>Comparator</span><span class=o>&lt;</span><span class=n>Advisor</span><span class=o>&gt;</span><span class=w> </span><span class=n>comparator</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>advisor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>advisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>comparator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>comparator</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>compareTo</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Advisor</span><span class=w> </span><span class=n>otherAdvisor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>PartiallyComparableAdvisorHolder</span><span class=p>)</span><span class=w> </span><span class=n>obj</span><span class=p>).</span><span class=na>advisor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>comparator</span><span class=p>.</span><span class=na>compare</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>advisor</span><span class=p>,</span><span class=w> </span><span class=n>otherAdvisor</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=kd>public</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>fallbackCompareTo</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>AspectJPrecedenceComparator：默认还是AnnotationAwareOrderComparator，但是对于同一个切面的advisor做了自己的处理。但是在spring 5.2.7 之前是有用的，5.2.7之后，declarationOrderInAspect全部强制改为0了</p><blockquote><p>// Prior to Spring Framework 5.2.7, advisors.size() was supplied as the declarationOrderInAspect</p><p>// to getAdvisor(&mldr;) to represent the &ldquo;current position&rdquo; in the declared methods list.</p><p>// However, since Java 7 the &ldquo;current position&rdquo; is not valid since the JDK no longer</p><p>// returns declared methods in the order in which they are declared in the source code.</p><p>// Thus, we now hard code the declarationOrderInAspect to 0 for all advice methods</p><p>// discovered via reflection in order to support reliable advice ordering across JVM launches.</p><p>// Specifically, a value of 0 aligns with the default value used in</p><p>// AspectJPrecedenceComparator.getAspectDeclarationOrder(Advisor).</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>public</span><span class=w> </span><span class=n>AspectJPrecedenceComparator</span><span class=p>()</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>this</span><span class=p>.</span><span class=n>advisorComparator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnnotationAwareOrderComparator</span><span class=p>.</span><span class=n>INSTANCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>public</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=n>compare</span><span class=p>(</span><span class=n>Advisor</span><span class=w> </span><span class=n>o1</span><span class=p>,</span><span class=w> </span><span class=n>Advisor</span><span class=w> </span><span class=n>o2</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=err>即先拿</span><span class=n>order比较</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nb>int</span><span class=w> </span><span class=n>advisorPrecedence</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>this</span><span class=p>.</span><span class=n>advisorComparator</span><span class=p>.</span><span class=n>compare</span><span class=p>(</span><span class=n>o1</span><span class=p>,</span><span class=w> </span><span class=n>o2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>advisorPrecedence</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>SAME_PRECEDENCE</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>declaredInSameAspect</span><span class=p>(</span><span class=n>o1</span><span class=p>,</span><span class=w> </span><span class=n>o2</span><span class=p>))</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>advisorPrecedence</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>comparePrecedenceWithinAspect</span><span class=p>(</span><span class=n>o1</span><span class=p>,</span><span class=w> </span><span class=n>o2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>advisorPrecedence</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>//</span><span class=err>拿声明顺序比较</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>private</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=n>comparePrecedenceWithinAspect</span><span class=p>(</span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor1</span><span class=p>,</span><span class=w> </span><span class=n>Advisor</span><span class=w> </span><span class=n>advisor2</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nb>boolean</span><span class=w> </span><span class=n>oneOrOtherIsAfterAdvice</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=p>(</span><span class=n>AspectJAopUtils</span><span class=p>.</span><span class=n>isAfterAdvice</span><span class=p>(</span><span class=n>advisor1</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>AspectJAopUtils</span><span class=p>.</span><span class=n>isAfterAdvice</span><span class=p>(</span><span class=n>advisor2</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nb>int</span><span class=w> </span><span class=n>adviceDeclarationOrderDelta</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAspectDeclarationOrder</span><span class=p>(</span><span class=n>advisor1</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>getAspectDeclarationOrder</span><span class=p>(</span><span class=n>advisor2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>//</span><span class=err>对于是否存在</span><span class=k>after</span><span class=err>，是两种逻辑，存在</span><span class=n>after的话</span><span class=err>，最后声明的有最高优先级，否则，最先声明的有最高优先级</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>//</span><span class=n>Q</span><span class=o>&amp;</span><span class=n>A</span><span class=w> </span><span class=mi>2024</span><span class=o>/</span><span class=mi>4</span><span class=o>/</span><span class=mi>27</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>//</span><span class=w> </span><span class=n>Q</span><span class=p>:</span><span class=w> </span><span class=err>完全不理解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>//</span><span class=w> </span><span class=n>A</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>oneOrOtherIsAfterAdvice</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>//</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>advice</span><span class=w> </span><span class=n>declared</span><span class=w> </span><span class=k>last</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>higher</span><span class=w> </span><span class=n>precedence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>adviceDeclarationOrderDelta</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=o>//</span><span class=w> </span><span class=n>advice1</span><span class=w> </span><span class=n>was</span><span class=w> </span><span class=n>declared</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>advice2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=o>//</span><span class=w> </span><span class=n>so</span><span class=w> </span><span class=n>advice1</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=k>lower</span><span class=w> </span><span class=n>precedence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=n>LOWER_PRECEDENCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>adviceDeclarationOrderDelta</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=n>SAME_PRECEDENCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>else</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=n>HIGHER_PRECEDENCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=k>else</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=o>//</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>advice</span><span class=w> </span><span class=n>declared</span><span class=w> </span><span class=k>first</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>higher</span><span class=w> </span><span class=n>precedence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>adviceDeclarationOrderDelta</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=o>//</span><span class=w> </span><span class=n>advice1</span><span class=w> </span><span class=n>was</span><span class=w> </span><span class=n>declared</span><span class=w> </span><span class=k>before</span><span class=w> </span><span class=n>advice2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=o>//</span><span class=w> </span><span class=n>so</span><span class=w> </span><span class=n>advice1</span><span class=w> </span><span class=n>has</span><span class=w> </span><span class=n>higher</span><span class=w> </span><span class=n>precedence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=n>HIGHER_PRECEDENCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>adviceDeclarationOrderDelta</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=n>SAME_PRECEDENCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>else</span><span class=w> </span><span class=err>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=n>LOWER_PRECEDENCE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=err>}</span><span class=w>
</span></span></span></code></pre></div><p>此外，这里使用的不是TimSort，而是PartialOrder(离散里的偏序）</p></section><footer class=article-footer><section class=article-tags><a href=/tags/spring/>Spring</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2024-11-24</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/post/tech/spring/cycle_bean/><div class=article-details><h2 class=article-title>SpringBean循环依赖处理流程</h2></div></a></article><article><a href=/post/tech/spring/refershscope/><div class=article-details><h2 class=article-title>RefershScope源码分析</h2></div></a></article><article><a href=/post/tech/spring/async/><div class=article-details><h2 class=article-title>@Async源码分析</h2></div></a></article><article><a href=/post/tech/spring/beandefinitionregistion/><div class=article-details><h2 class=article-title>Spring注册BeanDefinition的方式</h2></div></a></article><article><a href=/post/base/binary/><div class=article-details><h2 class=article-title>Binary</h2></div></a></article></div></div></aside><div id=gitalk-container></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js></script><script src=https://cdn.jsdelivr.net/npm/blueimp-md5@2.18.0/js/md5.min.js></script><script>const gitalk=new Gitalk({clientID:"Ov23libDgguDHlLK57yi",clientSecret:"bfd2cba55f272f4919357e37e54e4f4697cdd7d0",repo:"qisiii.github.io",owner:"qisiii",admin:["qisiii"],distractionFreeMode:!1,id:md5(location.pathname)});(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("gitalk-container").innerHTML="Gitalk comments not available by default when the website is previewed locally.";return}gitalk.render("gitalk-container")})()</script><a href=#top aria-label="go to top" class=top-link id=top-link style=display:none><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-chevron-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 15l6-6 6 6"/></svg>
</a><script src=https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js></script><script type=text/javascript>$(window).scroll(function(){$(this).scrollTop()>300?$("#top-link").show():$("#top-link").hide()})</script><footer class=site-footer><section class=copyright>&copy;
2022 -
2024 起司</section><section class=powerby><a href=https://beian.miit.gov.cn/ target=_blank>京ICP备2023017017号-1</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计
<script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css><section><span id=busuanzi_container_value_site_pv><i class="far fa-eye fa-fw"></i>
<span id=busuanzi_value_site_pv></span>次
</span>&nbsp;|&nbsp;
<span id=busuanzi_container_value_site_uv><i class="fa fa-user" aria-hidden=true></i>
<span id=busuanzi_value_site_uv></span>人次</span></section></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>