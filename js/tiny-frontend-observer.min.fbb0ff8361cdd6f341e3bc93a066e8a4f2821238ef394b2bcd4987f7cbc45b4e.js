(()=>{const b=(location.hostname||"").toLowerCase(),t=window.TFO_CFG||{},e={endpoint:t.endpoint||"https://example.com/loki/api/v1/push",useLoki:t.useLoki!==!1,app:t.app||"app",release:t.release||"v1",edge:t.edge,sampleRate:t.sampleRate==null?1:t.sampleRate,batchMax:t.batchMax||30,flushInterval:t.flushInterval||5e3,maxPayload:t.maxPayload||256*1024,sameHostOnly:!!t.sameHostOnly,ignorePatterns:t.ignorePatterns||[]},v=new Set(["www.google-analytics.com","google-analytics.com","www.googletagmanager.com","googletagmanager.com","g.doubleclick.net"]);if(Math.random()>e.sampleRate)return;const d=()=>(Date.now()*1e6).toString(),i=e=>{try{return JSON.stringify(e)}catch{return"{}"}},g=()=>location.pathname+location.search+location.hash,p=()=>navigator.userAgent||"",f=()=>document.visibilityState||"visible",s=t=>Object.assign({ts:d(),app:e.app,release:e.release,path:g(),referrer:document.referrer||"",ua:p(),vis:f(),...e.edge?{edge:e.edge}:{}},t||{}),h=e=>new Blob([e]).size,u=(t,n)=>{try{const s=new URL(t,location.href);if(v.has(s.hostname))return!0;if(e.sameHostOnly&&s.origin!==location.origin)return!0;if(n&&n.mode==="no-cors")return!0;const o=e.ignorePatterns||[];return!!o.some(e=>e&&e.test&&e.test(t))}catch{return!1}},o=[];let m=Date.now();function r(t){const n={};for(const s of t){const o=[e.app,s.type||"event",s.level||"info",s.path||"",s.edge||e.edge||""].join("|");n[o]||(n[o]={stream:{app:e.app,type:s.type||"event",level:s.level||"info",path:s.path||"",...e.edge||s.edge?{edge:s.edge||e.edge}:{}},values:[]}),n[o].values.push([s.ts||d(),JSON.stringify(s)])}return{streams:Object.values(n)}}async function l(e,t){try{if(navigator.sendBeacon&&navigator.sendBeacon(e,t))return}catch{}try{await fetch(e,{method:"POST",body:t,headers:{"Content-Type":"application/json"},keepalive:!0,mode:"cors"})}catch{}}function a(){if(!o.length)return;const n=o.splice(0,o.length);m=Date.now();const c=e.useLoki?r(n):{app:e.app,release:e.release,sentAt:(new Date).toISOString(),events:n},a=i(c);if(h(a)<=e.maxPayload){l(e.endpoint,a);return}let t=[],s=0;for(const o of n){const c=e.useLoki?r([o]):{app:e.app,release:e.release,events:[o]},d=i(c),a=h(d);s+a>e.maxPayload&&t.length?(l(e.endpoint,i(e.useLoki?r(t):{app:e.app,release:e.release,events:t})),t=[o],s=a):(t.push(o),s+=a)}t.length&&l(e.endpoint,i(e.useLoki?r(t):{app:e.app,release:e.release,events:t}))}function n(t){o.push(t);const n=o.length>=e.batchMax||Date.now()-m>e.flushInterval;n&&a()}setInterval(a,e.flushInterval),window.addEventListener("beforeunload",a),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&a()});try{if("PerformanceObserver"in window){new PerformanceObserver(e=>{for(const t of e.getEntries())t.name==="first-contentful-paint"&&n(s({type:"perf",metric:"FCP",value:Math.round(t.startTime)}))}).observe({type:"paint",buffered:!0});let e=null;const t=new PerformanceObserver(t=>{const n=t.getEntries(),s=n[n.length-1];s&&(e=s.startTime)});t.observe({type:"largest-contentful-paint",buffered:!0}),document.addEventListener("visibilitychange",()=>{if(document.visibilityState==="hidden"&&e!=null){n(s({type:"perf",metric:"LCP",value:Math.round(e)}));try{t.disconnect()}catch{}}});let o=0;const i=new PerformanceObserver(e=>{for(const t of e.getEntries())t.hadRecentInput||(o+=t.value)});i.observe({type:"layout-shift",buffered:!0}),window.addEventListener("pagehide",()=>{n(s({type:"perf",metric:"CLS",value:+o.toFixed(3)}));try{i.disconnect()}catch{}});const a=performance.getEntriesByType("navigation")[0];a&&n(s({type:"perf",metric:"TTFB",value:Math.round(a.responseStart)})),new PerformanceObserver(e=>{const t=e.getEntries()[0];if(!t)return;const o=t.processingStart-t.startTime;n(s({type:"perf",metric:"FID",value:Math.round(o)}))}).observe({type:"first-input",buffered:!0})}}catch{}window.addEventListener("error",e=>{n(s({type:"error",level:"error",message:e.message||"ScriptError",src:e.filename||"",line:e.lineno||0,col:e.colno||0,stack:e.error&&e.error.stack||""}))},!0),window.addEventListener("unhandledrejection",e=>{const t=e.reason;n(s({type:"error",level:"error",message:t&&(t.message||t.toString())||"unhandledrejection",stack:t&&t.stack||""}))});function c(e){n(s({type:"pv",level:"info",reason:e||"nav"}))}c("load");try{const e=e=>function(){const t=e.apply(this,arguments);try{c("spa")}catch{}return t};history.pushState=e(history.pushState),history.replaceState=e(history.replaceState),window.addEventListener("popstate",()=>c("popstate"))}catch{}if(window.fetch){const e=window.fetch;window.fetch=function(t,o){const a=performance.now(),i=typeof t=="string"?t:t?.url||"",r=o&&o.method||"GET";return u(i,o)?e(t,o):e(t,o).then(e=>{const t=performance.now()-a;return e.type==="opaque"?e:(e.ok||n(s({type:"http",level:"warn",phase:"fetch",url:i,method:r,status:e.status,duration:Math.round(t)})),e)}).catch(e=>{const t=performance.now()-a;throw n(s({type:"http",level:"error",phase:"fetch",url:i,method:r,status:0,error:e?.message||"network",duration:Math.round(t)})),e})}}if(window.XMLHttpRequest){const e=window.XMLHttpRequest;window.XMLHttpRequest=function(){const t=new e;let o="",i="GET",a=0;const r=t.open,c=t.send;return t.open=function(e,n){i=e||"GET",o=n||"",r.apply(t,arguments)},t.send=function(){a=performance.now(),t.addEventListener("loadend",()=>{if(u(o))return;const e=performance.now()-a;(t.status===0||t.status>=400)&&n(s({type:"http",level:t.status>=500?"error":"warn",phase:"xhr",url:o,method:i,status:t.status,duration:Math.round(e)}))}),c.apply(t,arguments)},t}}})()